# Plan 18-02: Appositive Guardian Patterns

**Phase:** 18 - Guardian Edge Cases
**Plan:** 02 - Appositive Patterns
**Created:** 2026-01-30

---
wave: 1
depends_on: []
files_modified:
  - app/recognizers/pediatric.py
  - test_presidio.py
autonomous: true
---

## Objective

Implement appositive guardian patterns to detect names following relationship word + punctuation combinations (e.g., "the mom, Jessica", "dad - Mike", "guardian (Sarah)").

## Background

Appositive constructions use punctuation to set off the name from the relationship word. These patterns are less common than forward patterns but are unambiguous when they appear.

**Key constraint:** Python regex lookbehind requires fixed width. Each relationship word + punctuation combination needs its own pattern.

## Tasks

<task id="1">
**Add appositive patterns to pediatric.py**

In `app/recognizers/pediatric.py`, add a new section for appositive patterns after the possessive patterns section (which was added in 18-01), before bidirectional patterns.

Add patterns grouped by punctuation type:

**Comma Appositives ("mom, Jessica"):**
```python
# =================================================================
# Appositive patterns: "mom, Jessica", "dad - Mike" (score 0.85)
# Punctuation sets off the name from relationship word
# =================================================================

# --- Comma appositives: "relationship, name" ---
# "mom, " = 5 chars
Pattern(name="mom_comma_name", regex=r"(?i)(?<=mom, )[a-z][a-z]+\b", score=0.85),
# "mother, " = 8 chars
Pattern(name="mother_comma_name", regex=r"(?i)(?<=mother, )[a-z][a-z]+\b", score=0.85),
# "mommy, " = 7 chars
Pattern(name="mommy_comma_name", regex=r"(?i)(?<=mommy, )[a-z][a-z]+\b", score=0.85),
# "dad, " = 5 chars
Pattern(name="dad_comma_name", regex=r"(?i)(?<=dad, )[a-z][a-z]+\b", score=0.85),
# "father, " = 8 chars
Pattern(name="father_comma_name", regex=r"(?i)(?<=father, )[a-z][a-z]+\b", score=0.85),
# "daddy, " = 7 chars
Pattern(name="daddy_comma_name", regex=r"(?i)(?<=daddy, )[a-z][a-z]+\b", score=0.85),
# "grandma, " = 9 chars
Pattern(name="grandma_comma_name", regex=r"(?i)(?<=grandma, )[a-z][a-z]+\b", score=0.85),
# "grandmother, " = 13 chars
Pattern(name="grandmother_comma_name", regex=r"(?i)(?<=grandmother, )[a-z][a-z]+\b", score=0.85),
# "grandpa, " = 9 chars
Pattern(name="grandpa_comma_name", regex=r"(?i)(?<=grandpa, )[a-z][a-z]+\b", score=0.85),
# "grandfather, " = 13 chars
Pattern(name="grandfather_comma_name", regex=r"(?i)(?<=grandfather, )[a-z][a-z]+\b", score=0.85),
# "nana, " = 6 chars
Pattern(name="nana_comma_name", regex=r"(?i)(?<=nana, )[a-z][a-z]+\b", score=0.85),
# "papa, " = 6 chars
Pattern(name="papa_comma_name", regex=r"(?i)(?<=papa, )[a-z][a-z]+\b", score=0.85),
# "granny, " = 8 chars
Pattern(name="granny_comma_name", regex=r"(?i)(?<=granny, )[a-z][a-z]+\b", score=0.85),
# "aunt, " = 6 chars
Pattern(name="aunt_comma_name", regex=r"(?i)(?<=aunt, )[a-z][a-z]+\b", score=0.85),
# "auntie, " = 8 chars
Pattern(name="auntie_comma_name", regex=r"(?i)(?<=auntie, )[a-z][a-z]+\b", score=0.85),
# "uncle, " = 7 chars
Pattern(name="uncle_comma_name", regex=r"(?i)(?<=uncle, )[a-z][a-z]+\b", score=0.85),
# "guardian, " = 10 chars
Pattern(name="guardian_comma_name", regex=r"(?i)(?<=guardian, )[a-z][a-z]+\b", score=0.85),
```

**Dash Appositives ("dad - Mike"):**
```python
# --- Dash appositives: "relationship - name" ---
# "mom - " = 6 chars (space + dash + space)
Pattern(name="mom_dash_name", regex=r"(?i)(?<=mom - )[a-z][a-z]+\b", score=0.85),
# "mother - " = 9 chars
Pattern(name="mother_dash_name", regex=r"(?i)(?<=mother - )[a-z][a-z]+\b", score=0.85),
# "dad - " = 6 chars
Pattern(name="dad_dash_name", regex=r"(?i)(?<=dad - )[a-z][a-z]+\b", score=0.85),
# "father - " = 9 chars
Pattern(name="father_dash_name", regex=r"(?i)(?<=father - )[a-z][a-z]+\b", score=0.85),
# "grandma - " = 10 chars
Pattern(name="grandma_dash_name", regex=r"(?i)(?<=grandma - )[a-z][a-z]+\b", score=0.85),
# "grandpa - " = 10 chars
Pattern(name="grandpa_dash_name", regex=r"(?i)(?<=grandpa - )[a-z][a-z]+\b", score=0.85),
# "guardian - " = 11 chars
Pattern(name="guardian_dash_name", regex=r"(?i)(?<=guardian - )[a-z][a-z]+\b", score=0.85),
```

**Parenthesis Appositives ("guardian (Sarah)"):**
```python
# --- Parenthesis appositives: "relationship (name)" ---
# Note: escape the parenthesis in lookbehind
# "mom (" = 5 chars
Pattern(name="mom_paren_name", regex=r"(?i)(?<=mom \()[a-z][a-z]+\b", score=0.85),
# "mother (" = 8 chars
Pattern(name="mother_paren_name", regex=r"(?i)(?<=mother \()[a-z][a-z]+\b", score=0.85),
# "dad (" = 5 chars
Pattern(name="dad_paren_name", regex=r"(?i)(?<=dad \()[a-z][a-z]+\b", score=0.85),
# "father (" = 8 chars
Pattern(name="father_paren_name", regex=r"(?i)(?<=father \()[a-z][a-z]+\b", score=0.85),
# "grandma (" = 9 chars
Pattern(name="grandma_paren_name", regex=r"(?i)(?<=grandma \()[a-z][a-z]+\b", score=0.85),
# "grandpa (" = 9 chars
Pattern(name="grandpa_paren_name", regex=r"(?i)(?<=grandpa \()[a-z][a-z]+\b", score=0.85),
# "guardian (" = 10 chars
Pattern(name="guardian_paren_name", regex=r"(?i)(?<=guardian \()[a-z][a-z]+\b", score=0.85),
```

**Relationship words to cover:**
- Core: mom, mother, mommy, dad, father, daddy
- Grandparents: grandma, grandmother, grandpa, grandfather, nana, papa, granny
- Extended: aunt, auntie, uncle
- Caregiver: guardian

**Total patterns:** ~35 patterns (17 relationships × comma + 7 key relationships × dash + 7 key relationships × paren)
</task>

<task id="2">
**Add appositive pattern unit tests to test_presidio.py**

Add 3 new test cases to the `TEST_CASES` list in `test_presidio.py` (after the possessive tests added in 18-01):

```python
# === GUARDIAN APPOSITIVE PATTERNS ===
{
    "name": "Guardian - appositive comma",
    "input": "The mom, Jessica, is at bedside.",
    "must_redact": ["Jessica"],
    "must_preserve": ["The", "mom", "bedside"],
},
{
    "name": "Guardian - appositive dash",
    "input": "His dad - Mike - works nights.",
    "must_redact": ["Mike"],
    "must_preserve": ["His", "dad", "works"],
},
{
    "name": "Guardian - appositive paren",
    "input": "Their guardian (Sarah) is available.",
    "must_redact": ["Sarah"],
    "must_preserve": ["Their", "guardian", "available"],
},
```
</task>

<task id="3">
**Validate patterns compile correctly**

Run a quick validation to ensure all patterns compile without errors:

```bash
cd "/Users/joshpankin/My Drive/10-19 Projects/12 Development & AI Projects/12.09 Pediatric_Handoff_PHI_Remover"
python -c "from app.recognizers.pediatric import get_pediatric_recognizers; recognizers = get_pediatric_recognizers(); print(f'Loaded {len(recognizers)} recognizers')"
```

This will fail fast if any regex patterns have syntax errors (especially escaped parentheses in lookbehind).
</task>

<task id="4">
**Run test_presidio.py to verify appositive patterns work**

```bash
cd "/Users/joshpankin/My Drive/10-19 Projects/12 Development & AI Projects/12.09 Pediatric_Handoff_PHI_Remover"
python test_presidio.py
```

Expected result:
- All 3 new appositive guardian tests pass
- All existing tests (including new possessive tests from 18-01) continue to pass
- No regressions
</task>

## Verification

After completing all tasks, verify:

1. **Pattern compilation:** `python -c "from app.recognizers.pediatric import get_pediatric_recognizers; print('OK')"` succeeds
2. **Unit tests pass:** `python test_presidio.py` shows new appositive tests passing
3. **No regressions:** All existing guardian tests still pass

## must_haves

- [ ] "the mom, Jessica" detected with "Jessica" redacted and "mom," preserved
- [ ] "dad - Mike" detected with "Mike" redacted and "dad -" preserved
- [ ] "guardian (Sarah)" detected with "Sarah" redacted and "guardian (" preserved
- [ ] Existing guardian patterns unaffected (no regressions)
- [ ] All patterns compile without regex errors (especially escaped parentheses)

## Notes

- Use score 0.85 (same as existing forward patterns) - punctuation provides clear signal
- Minimum 2-character names (`[a-z][a-z]+`) to avoid single-letter false positives
- Case-insensitive matching with `(?i)` flag
- Escape special characters in lookbehind (parenthesis needs `\(`)
- Lookbehind preserves relationship word + punctuation in output
