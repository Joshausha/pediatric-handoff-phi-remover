# Plan 18-01: Possessive Guardian Patterns

**Phase:** 18 - Guardian Edge Cases
**Plan:** 01 - Possessive Patterns
**Created:** 2026-01-30

---
wave: 1
depends_on: []
files_modified:
  - app/recognizers/pediatric.py
  - test_presidio.py
autonomous: true
---

## Objective

Implement possessive guardian patterns to detect names following possessive pronoun + relationship word combinations (e.g., "his mom Sarah", "her dad Tom", "their grandma Maria").

## Background

Current guardian patterns only detect forward patterns ("Mom Jessica") and bidirectional patterns ("Jessica is Mom"). Possessive patterns like "his mom Sarah" are missed because the possessive pronoun is not accounted for.

**Key constraint:** Python regex lookbehind requires fixed width. Each possessive pronoun + relationship word combination needs its own pattern.

## Tasks

<task id="1">
**Add possessive patterns to pediatric.py**

In `app/recognizers/pediatric.py`, add a new section for possessive patterns after the existing forward patterns section (around line 165, before bidirectional patterns).

Add the following patterns grouped by possessive pronoun:

**Standard Possessive Pronouns (his/her/their):**

Create patterns for each combination of:
- Pronouns: `his`, `her`, `their`
- Relationship words: `mom`, `mother`, `mommy`, `dad`, `father`, `daddy`, `grandma`, `grandmother`, `grandpa`, `grandfather`, `nana`, `papa`, `granny`, `aunt`, `auntie`, `uncle`, `guardian`

Example patterns (implement ALL combinations):
```python
# =================================================================
# Possessive patterns: "his mom Sarah", "her dad Tom" (score 0.85)
# Using lookbehind to match ONLY the name
# =================================================================

# --- his + relationship (3 + space + relationship + space) ---
# "his mom " = 8 chars
Pattern(name="his_mom_name", regex=r"(?i)(?<=his mom )[a-z][a-z]+\b", score=0.85),
# "his mother " = 11 chars
Pattern(name="his_mother_name", regex=r"(?i)(?<=his mother )[a-z][a-z]+\b", score=0.85),
# "his dad " = 8 chars
Pattern(name="his_dad_name", regex=r"(?i)(?<=his dad )[a-z][a-z]+\b", score=0.85),
# ... continue for all relationship words ...

# --- her + relationship (3 + space + relationship + space) ---
# Same patterns but with "her" instead of "his"
Pattern(name="her_mom_name", regex=r"(?i)(?<=her mom )[a-z][a-z]+\b", score=0.85),
# ... continue for all relationship words ...

# --- their + relationship (5 + space + relationship + space) ---
# "their mom " = 10 chars
Pattern(name="their_mom_name", regex=r"(?i)(?<=their mom )[a-z][a-z]+\b", score=0.85),
# ... continue for all relationship words ...
```

**Clinical Possessive Forms (patient's/baby's/child's/infant's):**

Add patterns for clinical context:
```python
# --- patient's + relationship ---
# "patient's mom " = 14 chars
Pattern(name="patients_mom_name", regex=r"(?i)(?<=patient's mom )[a-z][a-z]+\b", score=0.85),
Pattern(name="patients_dad_name", regex=r"(?i)(?<=patient's dad )[a-z][a-z]+\b", score=0.85),
Pattern(name="patients_mother_name", regex=r"(?i)(?<=patient's mother )[a-z][a-z]+\b", score=0.85),
Pattern(name="patients_father_name", regex=r"(?i)(?<=patient's father )[a-z][a-z]+\b", score=0.85),
Pattern(name="patients_guardian_name", regex=r"(?i)(?<=patient's guardian )[a-z][a-z]+\b", score=0.85),

# --- baby's + relationship ---
# "baby's mom " = 11 chars
Pattern(name="babys_mom_name", regex=r"(?i)(?<=baby's mom )[a-z][a-z]+\b", score=0.85),
Pattern(name="babys_dad_name", regex=r"(?i)(?<=baby's dad )[a-z][a-z]+\b", score=0.85),

# --- child's + relationship ---
# "child's mom " = 12 chars
Pattern(name="childs_mom_name", regex=r"(?i)(?<=child's mom )[a-z][a-z]+\b", score=0.85),
Pattern(name="childs_dad_name", regex=r"(?i)(?<=child's dad )[a-z][a-z]+\b", score=0.85),
```

**Full list of relationship words to cover:**
- Core: mom, mother, mommy, dad, father, daddy
- Grandparents: grandma, grandmother, grandpa, grandfather, nana, papa, granny
- Extended: aunt, auntie, uncle
- Caregiver: guardian

**Total patterns:** ~60 patterns (3 standard pronouns × 17 relationships + 4 clinical pronouns × ~5 key relationships)
</task>

<task id="2">
**Add possessive pattern unit tests to test_presidio.py**

Add 4 new test cases to the `TEST_CASES` list in `test_presidio.py` (around line 46, after existing guardian tests):

```python
# === GUARDIAN POSSESSIVE PATTERNS ===
{
    "name": "Guardian - possessive his mom",
    "input": "His mom Sarah is at bedside.",
    "must_redact": ["Sarah"],
    "must_preserve": ["His", "mom", "bedside"],
},
{
    "name": "Guardian - possessive her dad",
    "input": "Her dad Tom works nights.",
    "must_redact": ["Tom"],
    "must_preserve": ["Her", "dad", "works"],
},
{
    "name": "Guardian - possessive their grandma",
    "input": "Their grandma Maria helps with care.",
    "must_redact": ["Maria"],
    "must_preserve": ["Their", "grandma", "care"],
},
{
    "name": "Guardian - possessive patient's mom",
    "input": "The patient's mom Jessica brought supplies.",
    "must_redact": ["Jessica"],
    "must_preserve": ["patient's", "mom", "brought"],
},
```
</task>

<task id="3">
**Validate patterns compile correctly**

Run a quick validation to ensure all patterns compile without errors:

```bash
cd "/Users/joshpankin/My Drive/10-19 Projects/12 Development & AI Projects/12.09 Pediatric_Handoff_PHI_Remover"
python -c "from app.recognizers.pediatric import get_pediatric_recognizers; recognizers = get_pediatric_recognizers(); print(f'Loaded {len(recognizers)} recognizers')"
```

This will fail fast if any regex patterns have syntax errors (especially lookbehind width issues).
</task>

<task id="4">
**Run test_presidio.py to verify possessive patterns work**

```bash
cd "/Users/joshpankin/My Drive/10-19 Projects/12 Development & AI Projects/12.09 Pediatric_Handoff_PHI_Remover"
python test_presidio.py
```

Expected result:
- All 4 new possessive guardian tests pass
- All existing tests continue to pass
- No regressions in guardian detection
</task>

## Verification

After completing all tasks, verify:

1. **Pattern compilation:** `python -c "from app.recognizers.pediatric import get_pediatric_recognizers; print('OK')"` succeeds
2. **Unit tests pass:** `python test_presidio.py` shows new possessive tests passing
3. **No regressions:** Existing guardian tests ("Mom Jessica", "Dad Mike") still pass

## must_haves

- [ ] "his mom Sarah" detected with "Sarah" redacted and "his mom" preserved
- [ ] "her dad Tom" detected with "Tom" redacted and "her dad" preserved
- [ ] "their grandma Maria" detected with "Maria" redacted and "their grandma" preserved
- [ ] "patient's mom Jessica" detected with "Jessica" redacted and "patient's mom" preserved
- [ ] Existing guardian patterns unaffected (no regressions)
- [ ] All patterns compile without regex errors

## Notes

- Use score 0.85 (same as existing forward patterns) - possessive pronouns provide strong context
- Minimum 2-character names (`[a-z][a-z]+`) to avoid single-letter false positives
- Case-insensitive matching with `(?i)` flag
- Lookbehind preserves pronoun + relationship word in output
