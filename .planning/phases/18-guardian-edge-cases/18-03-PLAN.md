# Plan 18-03: Validation and Recall Measurement

**Phase:** 18 - Guardian Edge Cases
**Plan:** 03 - Validation
**Created:** 2026-01-30

---
wave: 2
depends_on: [18-01, 18-02]
files_modified:
  - tests/test_deidentification.py
autonomous: true
---

## Objective

Validate all new guardian patterns work correctly and measure recall improvement. Run full test suite and real handoff validation to confirm no regressions.

## Background

Plans 18-01 and 18-02 added ~95 new patterns for possessive and appositive guardian detection. This plan validates the combined effect and measures improvement.

## Tasks

<task id="1">
**Add integration tests to test_deidentification.py**

Add guardian edge case integration tests to `tests/test_deidentification.py`. Add these as new test methods in the `TestDeidentification` class:

```python
def test_guardian_possessive_patterns(self):
    """Test possessive guardian patterns in realistic context."""
    text = "Patient admitted with his mom Sarah at bedside. Her phone is 617-555-1234."
    result = deidentify_text(text)

    # Name should be redacted
    assert "Sarah" not in result.clean_text
    # Possessive + relationship preserved
    assert "his mom" in result.clean_text.lower()
    # Phone also detected
    assert "617-555-1234" not in result.clean_text
    assert result.entity_count >= 2  # Guardian name + phone

def test_guardian_appositive_patterns(self):
    """Test appositive guardian patterns with punctuation."""
    text = "The mom, Jessica, brought medications from home."
    result = deidentify_text(text)

    # Name should be redacted
    assert "Jessica" not in result.clean_text
    # Relationship word preserved (with or without 'the')
    assert "mom" in result.clean_text.lower()
    # Context preserved
    assert "medications" in result.clean_text

def test_guardian_mixed_patterns_handoff(self):
    """Test realistic handoff with multiple guardian patterns."""
    text = """
    Patient is a 3 year old male admitted for bronchiolitis.
    His mom Sarah is primary contact. Dad - Mike - works nights.
    The grandmother, Rosa, helps with care during the day.
    Contact mom at 617-555-1234 if any concerns.
    """
    result = deidentify_text(text)

    # All names should be redacted
    assert "Sarah" not in result.clean_text
    assert "Mike" not in result.clean_text
    assert "Rosa" not in result.clean_text

    # Relationship words preserved
    assert "mom" in result.clean_text.lower()
    assert "dad" in result.clean_text.lower()
    assert "grandmother" in result.clean_text.lower()

    # Clinical content preserved
    assert "bronchiolitis" in result.clean_text
    assert "3 year old" in result.clean_text.lower() or "year old" in result.clean_text.lower()
```
</task>

<task id="2">
**Run full unit test suite**

Execute the isolated Presidio test harness:

```bash
cd "/Users/joshpankin/My Drive/10-19 Projects/12 Development & AI Projects/12.09 Pediatric_Handoff_PHI_Remover"
python test_presidio.py
```

Record the results:
- Total tests passed
- Any new failures or warnings
- Confirm all 7 new guardian tests pass (4 possessive + 3 appositive)
</task>

<task id="3">
**Run pytest integration tests**

Execute the full pytest test suite:

```bash
cd "/Users/joshpankin/My Drive/10-19 Projects/12 Development & AI Projects/12.09 Pediatric_Handoff_PHI_Remover"
pytest tests/test_deidentification.py -v -k "guardian"
```

Then run the full suite:

```bash
pytest tests/ -v --tb=short
```

Record:
- All guardian-related tests pass
- No regressions in other test areas
</task>

<task id="4">
**Document recall improvement**

Create a brief summary of the phase results. Update the test_presidio.py KNOWN_ISSUES set if any known issues are now resolved.

Check current KNOWN_ISSUES:
```python
KNOWN_ISSUES = {
    "Patient name - Baby LastName",
    "Age - months (should redact detailed)",
    "Room number",
}
```

If any guardian-related issues were in KNOWN_ISSUES and are now fixed, remove them.
</task>

<task id="5">
**Verify no false positives**

Run interactive testing to spot-check for false positives:

```bash
cd "/Users/joshpankin/My Drive/10-19 Projects/12 Development & AI Projects/12.09 Pediatric_Handoff_PHI_Remover"
python test_presidio.py -i
```

Test these phrases to ensure no over-redaction:
- "his mom is here" (no name - should NOT redact anything extra)
- "contact their guardian" (no name - should NOT redact anything extra)
- "dad is working" (no name after - should NOT redact anything extra)
- "the patient's condition" (no guardian pattern - should NOT redact anything)
</task>

## Verification

After completing all tasks, verify:

1. **Unit tests:** All test_presidio.py tests pass (including 7 new guardian edge case tests)
2. **Integration tests:** All pytest tests pass (including 3 new integration tests)
3. **No regressions:** Existing guardian tests ("Mom Jessica", "Dad Mike") still pass
4. **No false positives:** Common phrases without names are not over-redacted

## must_haves

- [ ] All 7 unit tests for guardian edge cases pass (4 possessive + 3 appositive)
- [ ] All 3 integration tests for guardian edge cases pass
- [ ] No regressions in existing tests
- [ ] No new false positives introduced (validated via interactive testing)
- [ ] GUARDIAN_NAME recall improved without precision loss

## Notes

- This validation plan depends on both 18-01 and 18-02 completing first
- Focus on confirming patterns work as designed
- Document any edge cases discovered for potential future phases
- Cross-sentence patterns were intentionally deferred per research recommendation
