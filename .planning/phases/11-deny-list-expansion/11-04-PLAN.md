---
phase: 11
plan: 04
title: "False Positive Verification and Test Recording Re-Processing"
wave: 3
depends_on: ["11-01", "11-02", "11-03"]
files_modified:
  - tests/test_deidentification.py
  - .planning/phases/11-deny-list-expansion/VERIFICATION_RESULTS.md
autonomous: false
estimated_tasks: 3
---

# Plan 11-04: False Positive Verification and Test Recording Re-Processing

## Goal

Verify all 45 documented false positives from Phase 10 are eliminated by re-processing the test recordings and adding regression tests for the specific false positive patterns.

## Context

Phase 10 documented 45 false positives across 10 test recordings:
- DATE_TIME: 26 instances (58%)
- LOCATION: 15 instances (33%)
- PERSON: 4 instances (9%)

This plan verifies the fixes from 11-01, 11-02, and 11-03 by:
1. Re-processing all 10 test recordings
2. Adding regression tests for documented false positive patterns
3. Documenting any remaining issues

## must_haves

1. Regression tests added for key false positive patterns (automated verification)
2. Full test suite passes (no regressions on PHI detection)
3. 45 documented false positives verified eliminated OR documented as remaining issues (user checkpoint)
4. Documentation of verification results with per-recording status

## Tasks

<task id="1">
<title>Add regression tests for Phase 10 false positive patterns</title>
<instructions>
Edit tests/test_deidentification.py to add a new test class for false positive regression testing.

Add after the existing TestDenyListFiltering class:

```python
# =============================================================================
# FALSE POSITIVE REGRESSION TESTS (Phase 11)
# =============================================================================

class TestFalsePositiveRegressions:
    """
    Regression tests for false positives documented in Phase 10.

    These tests ensure deny list expansions eliminate documented false positives
    while not introducing regressions on legitimate PHI detection.
    """

    # --- DATE_TIME False Positives (26 instances documented) ---

    @pytest.mark.parametrize("phrase", [
        # Simple duration
        "three days of symptoms",
        "two days of fever",
        "six hours of vomiting",
        "twelve hours ago",
        "48 hours observation",
        "one week of cough",
        # Relative time
        "yesterday she was febrile",
        "tomorrow we plan to discharge",
        "started this morning",
        # Clinical progression
        "day 4 of illness",
        "day 2 of antibiotics",
        # Continuation
        "another hour of observation",
        "one more hour then discharge",
        # Ranges and recent past
        "two to three days more",
        "the past two days",
        "last 24 hours stable",
        # Clinical percentages
        "sats in the mid-90s",
        "saturation mid-90s on room air",
    ])
    def test_duration_phrase_not_flagged(self, phrase):
        """Duration phrases should NOT be flagged as DATE_TIME."""
        result = deidentify_text(phrase)
        assert "[DATE]" not in result.clean_text, \
            f"Duration phrase '{phrase}' incorrectly flagged as DATE_TIME"

    # --- LOCATION False Positives (15 instances documented) ---

    @pytest.mark.parametrize("phrase", [
        # Flow terminology
        "patient on high flow oxygen",
        "started on high flow nasal cannula",
        "weaning to low flow",
        "currently on high, doing well",
        "on low flow, sats stable",
        "high flow at 8 liters",
        "low flow at 2 liters",
        # Room air
        "room air trial in progress",
        "saturating well on room air",
    ])
    def test_flow_terminology_not_flagged(self, phrase):
        """Flow terminology should NOT be flagged as LOCATION."""
        result = deidentify_text(phrase)
        # Check that high/low/room aren't replaced with [LOCATION]
        assert "[LOCATION]" not in result.clean_text, \
            f"Flow term in '{phrase}' incorrectly flagged as LOCATION"
        # Also verify the clinical terms are preserved
        for term in ["high flow", "low flow", "room air", "on high", "on low"]:
            if term in phrase.lower():
                assert term in result.clean_text.lower(), \
                    f"Flow term '{term}' was removed from '{phrase}'"

    # --- PERSON False Positives (4 instances documented) ---

    @pytest.mark.parametrize("phrase", [
        "barky cough consistent with croup",
        "barky quality to the cough",
        "mom at bedside",
        "bedside nurse updated",
        "patient on room air",
        "room air comfortable",
    ])
    def test_clinical_descriptors_not_flagged(self, phrase):
        """Clinical descriptors should NOT be flagged as PERSON."""
        result = deidentify_text(phrase)
        assert "[NAME]" not in result.clean_text, \
            f"Clinical term in '{phrase}' incorrectly flagged as PERSON"

    # --- Verify PHI Still Detected ---

    def test_legitimate_datetime_still_detected(self):
        """Real dates should still be detected."""
        result = deidentify_text("Admitted on January 15th, 2026")
        assert "January 15th" not in result.clean_text or "[DATE]" in result.clean_text

    def test_legitimate_location_still_detected(self):
        """Real locations should still be detected."""
        result = deidentify_text("Family lives in Boston")
        assert "Boston" not in result.clean_text or "[LOCATION]" in result.clean_text

    def test_legitimate_person_still_detected(self):
        """Real person names should still be detected."""
        result = deidentify_text("Patient Sarah Johnson is stable")
        assert "Sarah" not in result.clean_text
        assert "Johnson" not in result.clean_text
```

Save the file and run the new tests:
```bash
pytest tests/test_deidentification.py -v -k "FalsePositive"
```
</instructions>
<verification>
All new false positive regression tests pass.
Run: `pytest tests/test_deidentification.py -v -k "FalsePositive"`
Expected: All tests pass (100% pass rate on new tests)
</verification>
</task>

<task id="2" checkpoint="user">
<title>Re-process all 10 test recordings</title>
<instructions>
USER CHECKPOINT: Re-process all 10 test recordings through the web interface to verify false positives are eliminated.

1. Start the server:
```bash
cd "/Users/joshpankin/My Drive/10-19 Projects/12 Development & AI Projects/12.09 Pediatric_Handoff_PHI_Remover"
uvicorn app.main:app --reload
```

2. Open browser to http://localhost:8000

3. Process each of the 10 recordings:
   - R1: r1_rsv_bronchiolitis.m4a
   - R2: r2_pneumonia_antibiotics.m4a
   - R3: r3_asthma_exacerbation.m4a
   - R4: r4_gastroenteritis.m4a
   - R5: r5_febrile_infant.m4a
   - R6: r6_croup_stridor.m4a
   - E1: e1_duration_saturation.m4a
   - E2: e2_more_duration.m4a
   - E3: e3_flow_terminology.m4a
   - E4: e4_mixed_flow_duration.m4a

4. For each recording, review the output and note:
   - Are the 45 documented false positives eliminated?
   - Any NEW false positives observed?
   - Any regressions (legitimate PHI missed)?

5. Report results to Claude for documentation.
</instructions>
<verification>
User confirms:
- [ ] All 45 documented false positives eliminated
- [ ] No new false positives introduced
- [ ] Legitimate PHI still being detected
</verification>
</task>

<task id="3">
<title>Document verification results</title>
<instructions>
Create a verification results document based on task 2 outcomes.

Create file: `.planning/phases/11-deny-list-expansion/VERIFICATION_RESULTS.md`

Template:
```markdown
# Phase 11 Verification Results

**Date**: [current date]
**Verified By**: Josh Pankin + Claude

## Summary

| Category | Phase 10 Count | Phase 11 Count | Status |
|----------|----------------|----------------|--------|
| DATE_TIME FP | 26 | [new count] | [FIXED/REMAINING] |
| LOCATION FP | 15 | [new count] | [FIXED/REMAINING] |
| PERSON FP | 4 | [new count] | [FIXED/REMAINING] |
| **Total** | **45** | **[new total]** | **[overall]** |

## Recordings Re-Processed

[For each recording, document results]

### R1: RSV Bronchiolitis
- **Original FP**: "mid-90s" as DATE_TIME
- **After Phase 11**: [result]

### R2: Pneumonia with Antibiotics
- **Original FP**: "48 hours", "two to three days" as DATE_TIME
- **After Phase 11**: [result]

[Continue for all 10 recordings...]

## Regression Testing

- **Test Suite**: [passed/failed] (X passed, Y xfailed)
- **Manual Tests**: [passed/failed]

## Remaining Issues (if any)

[Document any false positives that weren't fixed or new issues discovered]

## CI/CD Verification

After merging, verify GitHub Actions:
- [ ] test.yml passes
- [ ] docker.yml passes

## Conclusion

[Summary of Phase 11 effectiveness]
```

Fill in based on user's verification results from task 2.
</instructions>
<verification>
VERIFICATION_RESULTS.md created with complete documentation of:
- Per-recording verification
- Before/after false positive counts
- Any remaining issues
</verification>
</task>

## Verification Criteria

After completing all tasks:

1. **Regression tests pass**: All new TestFalsePositiveRegressions tests green
2. **Recording verification complete**: All 10 recordings re-processed with results documented
3. **45 false positives eliminated**: Or documented remaining issues
4. **Full test suite passes**: No regressions on existing detection

Run final verification:
```bash
pytest tests/test_deidentification.py -v
python test_presidio.py
```

## Notes

- This plan is Wave 3 and depends on all other plans completing first
- Task 2 is a user checkpoint requiring manual re-processing of recordings
- Any remaining false positives should be documented for future work
- If significant issues remain, may need additional deny list entries
