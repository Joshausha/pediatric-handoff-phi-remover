---
phase: 11
plan: 03
title: "Unit Name Preservation in ROOM Redaction"
wave: 1
depends_on: []
files_modified:
  - app/recognizers/medical.py
autonomous: true
estimated_tasks: 2
---

# Plan 11-03: Unit Name Preservation in ROOM Redaction

## Goal

Preserve hospital unit names (PICU, NICU, ICU) during ROOM entity redaction so that "PICU bed 12" becomes "PICU [ROOM]" instead of "[ROOM]".

## Context

From Phase 10 context discussion:
- Current ROOM patterns match entire phrases like "PICU bed 12" and replace with [ROOM]
- Clinical utility lost when unit names are redacted (they're not PHI)
- Solution: Use regex capture groups to preserve unit name while redacting room number

DENY-04 requirement: Preserve unit names (PICU, NICU) during ROOM entity redaction.

## must_haves

1. "PICU bed 12" produces "PICU [ROOM]" (unit name preserved)
2. "NICU bed 3A" produces "NICU [ROOM]" (unit name preserved)
3. "ICU bed 4" produces "ICU [ROOM]" (unit name preserved)
4. "bed 12" still produces "[ROOM]" (no unit to preserve)
5. "Room 302" still produces "[ROOM]" (standard room pattern)
6. All existing room detection still works (no regressions)

## Tasks

<task id="1">
<title>Modify ROOM patterns to use capture groups for unit preservation</title>
<instructions>
Edit app/recognizers/medical.py to change the ICU bed pattern to preserve unit names.

The current `icu_bed` pattern (around line 90-96):
```python
# ICU bed formats with unit names (preserve unit, redact number)
# "PICU bed 7", "picu bed 3A", "NICU bed 21", "ICU bed 4"
Pattern(
    name="icu_bed",
    regex=r"(?i)\b(?:picu|nicu|icu)\s+bed\s+\d{1,3}[A-Za-z]?\b",
    score=0.80
),
```

**IMPLEMENTATION** - Use separate patterns for each unit type with fixed-width lookbehind:

Replace the single `icu_bed` pattern with these three patterns:
```python
# PICU bed - match only "bed X" portion (PICU preserved)
Pattern(
    name="picu_bed",
    regex=r"(?i)(?<=picu )bed\s+\d{1,3}[A-Za-z]?\b",
    score=0.80
),
# NICU bed - match only "bed X" portion (NICU preserved)
Pattern(
    name="nicu_bed",
    regex=r"(?i)(?<=nicu )bed\s+\d{1,3}[A-Za-z]?\b",
    score=0.80
),
# ICU bed - match only "bed X" portion (ICU preserved)
Pattern(
    name="icu_bed",
    regex=r"(?i)(?<=icu )bed\s+\d{1,3}[A-Za-z]?\b",
    score=0.80
),
```

**WHY this approach**: Fixed-width lookbehind is more reliable than variable-width alternation in Python's regex engine. Separate patterns avoid regex complexity while achieving the same result.

**FALLBACK**: If lookbehind patterns cause regex compilation errors during testing:
1. Keep the original single `icu_bed` pattern unchanged
2. Add PICU, NICU, ICU to the LOCATION deny list (they're already in PERSON deny list)
3. Document that unit names will appear as-is (no redaction) which is acceptable since they're not PHI
</instructions>
<verification>
Run: `python test_presidio.py -i`
Test these phrases:
- "patient in PICU bed 12" - should produce "patient in PICU [ROOM]"
- "NICU bed 3A is available" - should produce "NICU [ROOM] is available"
- "ICU bed 4" - should produce "ICU [ROOM]"

Also verify standard patterns still work:
- "Room 302" - should produce "[ROOM]"
- "bed 5" - should produce "[ROOM]"
</verification>
</task>

<task id="2">
<title>Add additional pediatric unit patterns</title>
<instructions>
Add patterns for other common pediatric units that should be preserved:

Edit app/recognizers/medical.py to add:

```python
# CVICU (Cardiovascular ICU) bed
Pattern(
    name="cvicu_bed",
    regex=r"(?i)(?<=cvicu )bed\s+\d{1,3}[A-Za-z]?\b",
    score=0.80
),
# CCU (Cardiac Care Unit) bed
Pattern(
    name="ccu_bed",
    regex=r"(?i)(?<=ccu )bed\s+\d{1,3}[A-Za-z]?\b",
    score=0.80
),
# PACU (Post-Anesthesia Care Unit) bed
Pattern(
    name="pacu_bed",
    regex=r"(?i)(?<=pacu )bed\s+\d{1,3}[A-Za-z]?\b",
    score=0.75
),
# L&D (Labor and Delivery) room - for newborn context
Pattern(
    name="ld_room",
    regex=r"(?i)(?<=l&d )room\s+\d{1,4}[A-Za-z]?\b",
    score=0.75
),
```

Also update the context list for the room_recognizer to include these unit names.
</instructions>
<verification>
Run: `python test_presidio.py -i`
Test these phrases:
- "baby in CVICU bed 3" - should produce "baby in CVICU [ROOM]"
- "PACU bed 2" - should produce "PACU [ROOM]"
</verification>
</task>

## Verification Criteria

After completing all tasks:

1. **Unit names preserved**: "PICU bed 12" -> "PICU [ROOM]"
2. **All unit types work**: PICU, NICU, ICU, CVICU, CCU, PACU
3. **Standard room patterns still work**: "Room 302" -> "[ROOM]"
4. **No regressions**: Full test suite passes

Run final verification:
```bash
pytest tests/test_deidentification.py -v -k "room"
python test_presidio.py
```

## Notes

- This plan is Wave 1 and can run in parallel with 11-01
- The lookbehind approach is preferred over post-processing because it's handled at the pattern level
- Fixed-width lookbehind is more reliable than variable-width alternation
- If lookbehind causes regex issues, fall back to Option C (post-processing in deidentification.py)
