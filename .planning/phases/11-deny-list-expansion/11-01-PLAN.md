---
phase: 11
plan: 01
title: "Duration Patterns and Matching Behavior Fix"
wave: 1
depends_on: []
files_modified:
  - app/config.py
  - app/deidentification.py
autonomous: true
estimated_tasks: 3
---

# Plan 11-01: Duration Patterns and Matching Behavior Fix

## Goal

Eliminate DATE_TIME false positives (58% of total) by adding comprehensive duration patterns to the deny list, and fix LOCATION deny list matching behavior to use word-boundary substring matching (consistent with DATE_TIME behavior).

## Context

From Phase 10 FALSE_POSITIVE_LOG.md:
- **26 DATE_TIME false positives** from duration phrases like "three days", "48 hours", "yesterday"
- LOCATION deny list uses exact matching, but DATE_TIME uses substring matching
- Inconsistent behavior makes flow terms harder to fix (DENY-02 depends on this)

## must_haves

1. Duration phrases "three days", "two days", "six hours", "twelve hours", "48 hours", "one week" are NOT flagged as DATE_TIME
2. Relative time "yesterday", "tomorrow" are NOT flagged as DATE_TIME
3. Clinical progression "day 4" is NOT flagged as DATE_TIME
4. LOCATION deny list uses substring matching with word boundaries (same as DATE_TIME)
5. Existing LOCATION deny list entries still work after matching behavior change
6. All existing tests pass (no regressions)

## Tasks

<task id="1">
<title>Add comprehensive duration patterns to DATE_TIME deny list</title>
<instructions>
Edit app/config.py to expand the `deny_list_date_time` field.

Add these categories of patterns to the existing list:

**Simple duration (written-out numbers):**
- "one day", "two days", "three days", "four days", "five days", "six days", "seven days"
- "one week", "two weeks", "three weeks", "four weeks"
- "one month", "two months", "three months"
- "one hour", "two hours", "three hours", "four hours", "five hours", "six hours"
- "eight hours", "twelve hours", "twenty-four hours"

**Numeric duration:**
- "24 hours", "48 hours", "72 hours"
- Pattern note: "X hours" where X is 1-72 - add common values explicitly

**Informal duration:**
- "a day", "a few days", "couple days", "half a day"
- "a week", "a few weeks", "couple weeks"
- "a couple of days", "a couple of hours"
- "another hour", "another day", "one more hour", "one more day"

**Duration ranges:**
- "two to three days", "three to four days", "one to two weeks"
- "a day or two", "a few more days"

**Recent past patterns (substring matches):**
- "the past two days", "the past few days", "the last few days"
- "last 24 hours", "past 24 hours", "past 48 hours"
- "the past week", "the last week"

**Duration context words:**
- "days ago", "hours ago", "weeks ago", "months ago"
- "a day and a half", "day and a half"

**Clinical percentages (oxygen saturation context):**
- "mid-90s", "low 90s", "high 90s"
- "mid-80s", "low 80s", "high 80s"

**Dosing counts that look like dates:**
- "4 doses", "3 doses", "2 doses"

Preserve all existing entries. Add new entries in organized sections with comments.

**VERIFICATION CHECKLIST** - Cross-reference against Phase 10 FALSE_POSITIVE_LOG.md documented instances:
- [ ] "three days" (R4, E1) - simple duration
- [ ] "two days" (R4, R6) - simple duration
- [ ] "48 hours" (R2, R5, E4) - numeric duration
- [ ] "six hours" (E4) - simple duration
- [ ] "twelve hours" - simple duration (extrapolated)
- [ ] "one week" - simple duration (extrapolated)
- [ ] "another hour" (R3, R6, E1) - continuation
- [ ] "one more hour" (R4) - continuation
- [ ] "two to three days" (R2, E2) - range duration
- [ ] "the past two days" (E2) - recent past
- [ ] "last 24 hours" - recent past (extrapolated)
- [ ] "yesterday" (E1, E2) - relative time
- [ ] "tomorrow" (E1) - relative time
- [ ] "day 4" (E2) - clinical progression
- [ ] "a day and a half ago" (E1) - informal duration
- [ ] "five hours ago" (E1) - informal duration
- [ ] "4 doses" (E2) - dosing count
- [ ] "mid-90s" (R1) - clinical percentage
- [ ] "three hours" (R6) - simple duration
</instructions>
<verification>
Run: `python test_presidio.py -i`
Test these phrases - should NOT be flagged as DATE_TIME:
- "three days of symptoms"
- "48 hours ago"
- "yesterday she had fever"
- "day 4 of illness"
- "the past two days"
- "sats in the mid-90s"
Verify each returns the input unchanged (no [DATE] marker).

**CHECKPOINT**: After adding all entries, count total new entries added. Should be ~70-80 entries covering the 26 documented DATE_TIME false positives. Proceed to Task 2 only after confirming the deny list is complete.
</verification>
</task>

<task id="2">
<title>Switch LOCATION deny list to substring matching</title>
<instructions>
Edit app/deidentification.py to change the LOCATION deny list filtering from exact match to substring match (consistent with DATE_TIME behavior).

Current code (around line 185):
```python
# Check LOCATION deny list
if result.entity_type == "LOCATION" and detected_text.lower() in [w.lower() for w in settings.deny_list_location]:
    logger.debug(f"Filtered out deny-listed LOCATION: {detected_text}")
    continue
```

**Replace with this single implementation** (matches DATE_TIME behavior):
```python
# Check LOCATION deny list (uses substring matching like DATE_TIME)
if result.entity_type == "LOCATION":
    detected_lower = detected_text.lower()
    is_denied = any(term.lower() in detected_lower for term in settings.deny_list_location)
    if is_denied:
        logger.debug(f"Filtered out deny-listed LOCATION: {detected_text}")
        continue
```

This is the simplest approach and matches how DATE_TIME deny list already works.
</instructions>
<verification>
Run: `python test_presidio.py -i`

**Test existing abbreviations still work:**
- "patient on NC oxygen" - NC should NOT be flagged
- "started on RA yesterday" - RA should NOT be flagged
- "transferred from OR" - OR should NOT be flagged

**Test substring matching with punctuation (existing entries):**
- "NC, and doing well" - NC with punctuation should NOT be flagged
- "(NC)" - NC in parentheses should NOT be flagged

**CRITICAL: Test that NEW substring matching behavior works (not just existing entries):**

To prove substring matching is working (not just exact matching), temporarily add a test term and verify:
1. Run: `python test_presidio.py -i`
2. Test: "patient on high flow" - if "high" is NOT in deny list, it MAY flag "high" as LOCATION
3. This test establishes baseline BEFORE Plan 11-02 adds "high" to the deny list
4. After Plan 11-02 adds "high", this phrase should NOT flag LOCATION

Alternative verification (proves substring logic change is working):
- Add temporary entry "test_substring" to deny_list_location in config.py
- Test: "text with test_substring123 embedded" - should NOT flag as LOCATION
- Remove temporary entry after confirming substring matching works
- If this test passes, the substring matching implementation is correct
</verification>
</task>

<task id="3">
<title>Run full test suite to verify no regressions</title>
<instructions>
Run the full test suite to ensure all changes pass:

```bash
cd "/Users/joshpankin/My Drive/10-19 Projects/12 Development & AI Projects/12.09 Pediatric_Handoff_PHI_Remover"
pytest tests/test_deidentification.py -v
```

Expected result: All tests pass (172 passed, 8 xfailed is acceptable).

If any tests fail, analyze the failure and either:
1. Fix the implementation if it's a bug
2. Update test expectations if the behavior change is intentional

Also run the manual test harness:
```bash
python test_presidio.py
```

Expected: All tests pass or only known issues warn.
</instructions>
<verification>
- pytest output shows all tests pass (or xfail for known issues)
- test_presidio.py shows high pass rate with no new failures
</verification>
</task>

## Verification Criteria

After completing all tasks:

1. **Duration false positives eliminated**: Interactive testing shows "three days", "48 hours", "yesterday", "day 4", "the past two days" are NOT flagged
2. **LOCATION matching consistent**: Same substring behavior as DATE_TIME
3. **No regressions**: Full test suite passes (172+ passed)
4. **Existing deny lists work**: NC, RA, OR still filtered correctly

## Notes

- This plan is Wave 1 and must complete before Plan 11-02 (flow terms) because DENY-02 depends on DENY-03's matching behavior
- Duration patterns favor recall over precision - it's acceptable to occasionally block true dates since handoffs rarely contain actual calendar dates
- The deny list additions follow the pattern-based approach decided in phase context
