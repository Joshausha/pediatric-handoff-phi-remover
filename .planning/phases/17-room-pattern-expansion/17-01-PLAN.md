---
phase: 17-room-pattern-expansion
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/recognizers/medical.py
  - tests/test_deidentification.py
autonomous: true

must_haves:
  truths:
    - "Standalone numbers in room context detected (e.g., 'in 8', 'moved to 512')"
    - "Room synonyms with numbers detected (space 5, pod 3, cubicle 12, crib 8)"
    - "Hyphenated room formats detected with context (3-22, 5-10)"
    - "ROOM recall >=80% on validation set"
    - "Unit names PICU/NICU preserved (not over-redacted)"
    - "Clinical numbers NOT falsely detected (O2 levels, doses, ages)"
  artifacts:
    - path: "app/recognizers/medical.py"
      provides: "Extended ROOM patterns with context-based detection"
      contains: "room_number_contextual"
    - path: "tests/test_deidentification.py"
      provides: "ROOM pattern regression tests"
      contains: "test_room_contextual"
  key_links:
    - from: "app/recognizers/medical.py"
      to: "app/deidentification.py"
      via: "get_medical_recognizers() import"
      pattern: "from .recognizers import get_medical_recognizers"
    - from: "tests/test_deidentification.py"
      to: "app/deidentification.py"
      via: "deidentify_text import"
      pattern: "from app.deidentification import deidentify_text"
---

<objective>
Add low-confidence contextual ROOM patterns to improve recall from 32% to >=80%.

Purpose: Current ROOM detection only catches explicit "Room X" and "Bed X" patterns. Real handoffs use conversational references like "in 8", "moved to 512", "space 5". Adding low-confidence patterns with strong context word support enables detection of these informal references without false positives on clinical numbers.

Output: Extended ROOM recognizer with 4-6 new patterns, expanded context word list, and comprehensive test coverage.
</objective>

<execution_context>
@/Users/joshpankin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joshpankin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-room-pattern-expansion/17-RESEARCH.md

@app/recognizers/medical.py
@app/config.py
@tests/test_deidentification.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Low-Confidence Contextual Room Patterns</name>
  <files>app/recognizers/medical.py</files>
  <action>
Extend the Room Number Recognizer in `get_medical_recognizers()` with the following new patterns:

1. **Room synonym patterns** (score=0.55):
   - `space\s+\d{1,3}` - "space 5", "space 12"
   - `pod\s+\d{1,3}` - "pod 3", "pod 8"
   - `cubicle\s+\d{1,3}` - "cubicle 12"
   - `crib\s+\d{1,3}` - "crib 8" (NICU)

2. **Prepositional room reference** (score=0.40):
   - `(?:in|to|from)\s+\d{1,4}(?!\s*(?:mg|ml|kg|%|liters?|L\b|days?|weeks?|months?|hours?|minutes?|years?|am|pm|doses?))`
   - This pattern matches "in 8", "to 512", "from 302"
   - The negative lookahead prevents matching clinical numbers like "in 8 mg", "to 2 liters"

3. **Standalone contextual number** (score=0.35):
   - `\b\d{1,4}\b` (very low confidence - relies entirely on context boost)
   - Only triggers with strong context words present
   - Add ONLY if prepositional pattern doesn't achieve target recall

**Expand the context word list** for the room_recognizer:
```python
context=[
    # Existing
    "room", "bed", "floor", "unit", "located", "admitted to", "transferred to",
    "bay", "isolette", "picu", "nicu", "icu", "cvicu", "ccu", "pacu", "l&d",
    # NEW: Location prepositions (enable weak pattern detection)
    "in", "to", "from",
    # NEW: Movement verbs
    "moved", "moving", "transferred", "placed", "assigned",
    # NEW: Room synonyms
    "space", "pod", "cubicle", "crib",
    # NEW: Patient location phrases
    "patient in", "currently in", "over in"
]
```

**CRITICAL - What NOT to do:**
- Do NOT use high scores (0.70+) for standalone numbers - causes massive false positives
- Do NOT remove existing high-confidence patterns - they take precedence
- Do NOT remove the unit-preserving lookbehind patterns (picu_bed, nicu_bed, etc.)
- Do NOT match numbers followed by clinical units (mg, ml, kg, %, liters, etc.)

**Pattern placement:** Add new patterns AFTER the existing explicit patterns but BEFORE the hyphenated standalone pattern (which has score=0.55).
  </action>
  <verify>
```bash
cd "/Users/joshpankin/My Drive/10-19 Projects/12 Development & AI Projects/12.09 Pediatric_Handoff_PHI_Remover"
pytest tests/test_deidentification.py -v -k "room" --tb=short
```
All existing room tests should pass.
  </verify>
  <done>
- 4+ new patterns added to Room Number Recognizer
- Context word list expanded with 15+ new terms
- Existing patterns unchanged (no regression)
- Unit-preserving lookbehind patterns still present
  </done>
</task>

<task type="auto">
  <name>Task 2: Add ROOM Pattern Tests and Validate Recall</name>
  <files>tests/test_deidentification.py</files>
  <action>
Add a new test class `TestRoomContextualPatterns` with comprehensive tests for the new patterns. The class should include:

**Positive tests (8 tests - SHOULD detect as ROOM):**

1. **test_room_prepositional_in** - Verify "in [number]" pattern detects room numbers. Input: "Patient currently in 8, stable overnight." Expect: "8" replaced with [ROOM] or removed.

2. **test_room_prepositional_to** - Verify "to [number]" pattern. Input: "We moved to 512 this morning." Expect: "512" replaced with [ROOM] or removed.

3. **test_room_prepositional_from** - Verify "from [number]" pattern. Input: "Transferred from 302 in the ED." Expect: "302" replaced with [ROOM] or removed.

4. **test_room_space_synonym** - Verify "space [number]" pattern. Input: "She's over in space 5 right now." Expect: "5" replaced with [ROOM] or removed.

5. **test_room_pod_synonym** - Verify "pod [number]" pattern. Input: "Assigned to pod 3 in PICU." Expect: "3" replaced with [ROOM] or removed.

6. **test_room_cubicle_synonym** - Verify "cubicle [number]" pattern. Input: "Patient in cubicle 12." Expect: "12" replaced with [ROOM] or removed.

7. **test_room_crib_synonym** - Verify "crib [number]" NICU pattern. Input: "Baby in crib 8 in NICU." Expect: "8" replaced with [ROOM] or removed.

8. **test_room_hyphenated_with_context** - Verify hyphenated format with room context. Input: "Patient moved to 3-22 in PICU." Expect: "3-22" replaced with [ROOM] or removed.

**Negative tests (6 tests - should NOT detect as ROOM):**

1. **test_no_room_oxygen_level** - O2 levels should NOT be room numbers. Input: "Currently on O2 at 8 liters." Expect: "8 liters" preserved in output.

2. **test_no_room_medication_dose** - Medication doses should NOT be room numbers. Input: "Give 512 mg of acetaminophen." Expect: "512 mg" preserved in output.

3. **test_no_room_age** - Ages should NOT be room numbers. Input: "She's a 3 year old with fever." Expect: "3 year old" preserved in output.

4. **test_no_room_day_of_illness** - Day of illness should NOT be room numbers. Input: "This is day 5 of illness." Expect: "day 5" preserved in output.

5. **test_no_room_percentage** - Percentages should NOT be room numbers. Input: "Sats at 94% on room air." Expect: "94%" preserved in output.

6. **test_picu_bed_preserved** - PICU unit name preserved while bed number redacted. Input: "Patient in PICU bed 7, stable." Expect: "PICU" preserved, "bed 7" has number redacted.

**After adding tests, run validation:**
1. Run the new test class to confirm all tests pass
2. Run full evaluation to verify ROOM recall >= 80%
3. If recall is below target, iterate on patterns in Task 1

  </action>
  <verify>
```bash
cd "/Users/joshpankin/My Drive/10-19 Projects/12 Development & AI Projects/12.09 Pediatric_Handoff_PHI_Remover"

# All new tests pass
pytest tests/test_deidentification.py -v -k "TestRoomContextualPatterns" --tb=short

# Full test suite passes (no regressions)
pytest tests/test_deidentification.py -v --tb=short

# Check ROOM recall (target: >=80%)
python -m tests.evaluate_presidio 2>/dev/null | grep -A2 "ROOM"
```
  </verify>
  <done>
- 14 new tests for ROOM contextual patterns (8 positive, 6 negative)
- All positive tests pass (new patterns detected)
- All negative tests pass (no false positives on clinical numbers)
- ROOM recall >=80% confirmed via evaluation
- No regressions on existing tests
  </done>
</task>

</tasks>

<verification>
Run comprehensive verification:

```bash
cd "/Users/joshpankin/My Drive/10-19 Projects/12 Development & AI Projects/12.09 Pediatric_Handoff_PHI_Remover"

# 1. Full test suite passes
pytest tests/ -v --tb=short

# 2. ROOM-specific tests pass
pytest tests/test_deidentification.py -v -k "room" --tb=short

# 3. Check ROOM recall improvement
python -m tests.evaluate_presidio 2>/dev/null | grep -A5 "ROOM"

# 4. Verify unit name preservation
python -c "
from app.deidentification import deidentify_text
result = deidentify_text('Patient in PICU bed 7, stable.')
assert 'PICU' in result.clean_text, 'PICU should be preserved'
assert 'bed 7' not in result.clean_text, 'bed 7 should be redacted'
print('Unit preservation: PASSED')
"

# 5. Verify no clinical number false positives
python -c "
from app.deidentification import deidentify_text
result = deidentify_text('Currently on O2 at 8 liters, sats 94%.')
assert '8 liters' in result.clean_text, '8 liters should not be redacted'
assert '94%' in result.clean_text, '94% should not be redacted'
print('False positive prevention: PASSED')
"
```
</verification>

<success_criteria>
1. ROOM recall improved from 32% to >=80% on validation set
2. All new contextual patterns working (prepositional, synonyms)
3. Unit names (PICU, NICU) preserved in output
4. No false positives on clinical numbers (O2, doses, ages, percentages)
5. Full test suite passes with no regressions
6. 14 new tests added for ROOM pattern coverage
</success_criteria>

<output>
After completion, create `.planning/phases/17-room-pattern-expansion/17-01-SUMMARY.md`
</output>
