---
phase: 17-room-pattern-expansion
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/recognizers/medical.py
  - tests/test_deidentification.py
autonomous: true

must_haves:
  truths:
    - "Standalone numbers in room context detected (e.g., 'in 8', 'moved to 512')"
    - "Room synonyms with numbers detected (space 5, pod 3, cubicle 12, crib 8)"
    - "Hyphenated room formats detected with context (3-22, 5-10)"
    - "ROOM recall >=80% on validation set"
    - "Unit names PICU/NICU preserved (not over-redacted)"
    - "Clinical numbers NOT falsely detected (O2 levels, doses, ages)"
  artifacts:
    - path: "app/recognizers/medical.py"
      provides: "Extended ROOM patterns with context-based detection"
      contains: "room_number_contextual"
    - path: "tests/test_deidentification.py"
      provides: "ROOM pattern regression tests"
      contains: "test_room_contextual"
  key_links:
    - from: "app/recognizers/medical.py"
      to: "app/deidentification.py"
      via: "get_medical_recognizers() import"
      pattern: "from .recognizers import get_medical_recognizers"
    - from: "tests/test_deidentification.py"
      to: "app/deidentification.py"
      via: "deidentify_text import"
      pattern: "from app.deidentification import deidentify_text"
---

<objective>
Add low-confidence contextual ROOM patterns to improve recall from 32% to >=80%.

Purpose: Current ROOM detection only catches explicit "Room X" and "Bed X" patterns. Real handoffs use conversational references like "in 8", "moved to 512", "space 5". Adding low-confidence patterns with strong context word support enables detection of these informal references without false positives on clinical numbers.

Output: Extended ROOM recognizer with 4-6 new patterns, expanded context word list, and comprehensive test coverage.
</objective>

<execution_context>
@/Users/joshpankin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joshpankin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-room-pattern-expansion/17-RESEARCH.md

@app/recognizers/medical.py
@app/config.py
@tests/test_deidentification.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Low-Confidence Contextual Room Patterns</name>
  <files>app/recognizers/medical.py</files>
  <action>
Extend the Room Number Recognizer in `get_medical_recognizers()` with the following new patterns:

1. **Room synonym patterns** (score=0.55):
   - `space\s+\d{1,3}` - "space 5", "space 12"
   - `pod\s+\d{1,3}` - "pod 3", "pod 8"
   - `cubicle\s+\d{1,3}` - "cubicle 12"
   - `crib\s+\d{1,3}` - "crib 8" (NICU)

2. **Prepositional room reference** (score=0.40):
   - `(?:in|to|from)\s+\d{1,4}(?!\s*(?:mg|ml|kg|%|liters?|L\b|days?|weeks?|months?|hours?|minutes?|years?|am|pm|doses?))`
   - This pattern matches "in 8", "to 512", "from 302"
   - The negative lookahead prevents matching clinical numbers like "in 8 mg", "to 2 liters"

3. **Standalone contextual number** (score=0.35):
   - `\b\d{1,4}\b` (very low confidence - relies entirely on context boost)
   - Only triggers with strong context words present
   - Add ONLY if prepositional pattern doesn't achieve target recall

**Expand the context word list** for the room_recognizer:
```python
context=[
    # Existing
    "room", "bed", "floor", "unit", "located", "admitted to", "transferred to",
    "bay", "isolette", "picu", "nicu", "icu", "cvicu", "ccu", "pacu", "l&d",
    # NEW: Location prepositions (enable weak pattern detection)
    "in", "to", "from",
    # NEW: Movement verbs
    "moved", "moving", "transferred", "placed", "assigned",
    # NEW: Room synonyms
    "space", "pod", "cubicle", "crib",
    # NEW: Patient location phrases
    "patient in", "currently in", "over in"
]
```

**CRITICAL - What NOT to do:**
- Do NOT use high scores (0.70+) for standalone numbers - causes massive false positives
- Do NOT remove existing high-confidence patterns - they take precedence
- Do NOT remove the unit-preserving lookbehind patterns (picu_bed, nicu_bed, etc.)
- Do NOT match numbers followed by clinical units (mg, ml, kg, %, liters, etc.)

**Pattern placement:** Add new patterns AFTER the existing explicit patterns but BEFORE the hyphenated standalone pattern (which has score=0.55).
  </action>
  <verify>
Run the existing test suite to ensure no regressions:
```bash
cd "/Users/joshpankin/My Drive/10-19 Projects/12 Development & AI Projects/12.09 Pediatric_Handoff_PHI_Remover"
pytest tests/test_deidentification.py -v -k "room" --tb=short
```
All existing room tests should pass.
  </verify>
  <done>
- 4+ new patterns added to Room Number Recognizer
- Context word list expanded with 15+ new terms
- Existing patterns unchanged (no regression)
- Unit-preserving lookbehind patterns still present
  </done>
</task>

<task type="auto">
  <name>Task 2: Add ROOM Pattern Tests and Validate Recall</name>
  <files>tests/test_deidentification.py</files>
  <action>
Add a new test class `TestRoomContextualPatterns` with the following tests:

**Positive tests (SHOULD detect as ROOM):**
```python
class TestRoomContextualPatterns:
    """Test contextual room pattern detection (Phase 17)."""

    def test_room_prepositional_in(self):
        """Test 'in [number]' pattern."""
        text = "Patient currently in 8, stable overnight."
        result = deidentify_text(text)
        assert "[ROOM]" in result.clean_text or "8" not in result.clean_text

    def test_room_prepositional_to(self):
        """Test 'to [number]' pattern."""
        text = "We moved to 512 this morning."
        result = deidentify_text(text)
        assert "[ROOM]" in result.clean_text or "512" not in result.clean_text

    def test_room_prepositional_from(self):
        """Test 'from [number]' pattern."""
        text = "Transferred from 302 in the ED."
        result = deidentify_text(text)
        assert "[ROOM]" in result.clean_text or "302" not in result.clean_text

    def test_room_space_synonym(self):
        """Test 'space [number]' pattern."""
        text = "She's over in space 5 right now."
        result = deidentify_text(text)
        assert "[ROOM]" in result.clean_text or "5" not in result.clean_text

    def test_room_pod_synonym(self):
        """Test 'pod [number]' pattern."""
        text = "Assigned to pod 3 in PICU."
        result = deidentify_text(text)
        assert "[ROOM]" in result.clean_text or "3" not in result.clean_text

    def test_room_cubicle_synonym(self):
        """Test 'cubicle [number]' pattern."""
        text = "Patient in cubicle 12."
        result = deidentify_text(text)
        assert "[ROOM]" in result.clean_text or "12" not in result.clean_text

    def test_room_crib_synonym(self):
        """Test 'crib [number]' NICU pattern."""
        text = "Baby in crib 8 in NICU."
        result = deidentify_text(text)
        assert "[ROOM]" in result.clean_text or "8" not in result.clean_text

    def test_room_hyphenated_with_context(self):
        """Test '3-22' format with room context."""
        text = "Patient moved to 3-22 in PICU."
        result = deidentify_text(text)
        assert "[ROOM]" in result.clean_text or "3-22" not in result.clean_text
```

**Negative tests (should NOT detect as ROOM - false positive prevention):**
```python
    def test_no_room_oxygen_level(self):
        """O2 levels should NOT be detected as room."""
        text = "Currently on O2 at 8 liters."
        result = deidentify_text(text)
        # "8" should remain - it's an oxygen level, not a room
        assert "8 liters" in result.clean_text

    def test_no_room_medication_dose(self):
        """Medication doses should NOT be detected as room."""
        text = "Give 512 mg of acetaminophen."
        result = deidentify_text(text)
        assert "512 mg" in result.clean_text

    def test_no_room_age(self):
        """Ages should NOT be detected as room."""
        text = "She's a 3 year old with fever."
        result = deidentify_text(text)
        assert "3 year old" in result.clean_text

    def test_no_room_day_of_illness(self):
        """Day of illness should NOT be detected as room."""
        text = "This is day 5 of illness."
        result = deidentify_text(text)
        assert "day 5" in result.clean_text

    def test_no_room_percentage(self):
        """Percentages should NOT be detected as room."""
        text = "Sats at 94% on room air."
        result = deidentify_text(text)
        assert "94%" in result.clean_text

    def test_picu_bed_preserved(self):
        """PICU unit name should be preserved, only bed number redacted."""
        text = "Patient in PICU bed 7, stable."
        result = deidentify_text(text)
        assert "PICU" in result.clean_text
        # Bed number redacted
        assert "bed 7" not in result.clean_text or "[ROOM]" in result.clean_text
```

**After adding tests, run validation to check ROOM recall:**
```bash
# Run test suite
pytest tests/test_deidentification.py -v -k "room" --tb=short

# Run full evaluation to check ROOM recall
python -m tests.evaluate_presidio --entity ROOM
```

If ROOM recall is still below 80%, consider:
1. Adding the standalone contextual number pattern (score=0.35)
2. Adjusting context_similarity_factor in deidentification.py
3. Adding more context words
  </action>
  <verify>
```bash
cd "/Users/joshpankin/My Drive/10-19 Projects/12 Development & AI Projects/12.09 Pediatric_Handoff_PHI_Remover"

# All new tests pass
pytest tests/test_deidentification.py -v -k "TestRoomContextualPatterns" --tb=short

# Full test suite passes (no regressions)
pytest tests/test_deidentification.py -v --tb=short

# Check ROOM recall (target: >=80%)
python -m tests.evaluate_presidio 2>/dev/null | grep -A2 "ROOM"
```
  </verify>
  <done>
- 15+ new tests for ROOM contextual patterns
- All positive tests pass (new patterns detected)
- All negative tests pass (no false positives on clinical numbers)
- ROOM recall >=80% confirmed via evaluation
- No regressions on existing tests
  </done>
</task>

</tasks>

<verification>
Run comprehensive verification:

```bash
cd "/Users/joshpankin/My Drive/10-19 Projects/12 Development & AI Projects/12.09 Pediatric_Handoff_PHI_Remover"

# 1. Full test suite passes
pytest tests/ -v --tb=short

# 2. ROOM-specific tests pass
pytest tests/test_deidentification.py -v -k "room" --tb=short

# 3. Check ROOM recall improvement
python -m tests.evaluate_presidio 2>/dev/null | grep -A5 "ROOM"

# 4. Verify unit name preservation
python -c "
from app.deidentification import deidentify_text
result = deidentify_text('Patient in PICU bed 7, stable.')
assert 'PICU' in result.clean_text, 'PICU should be preserved'
assert 'bed 7' not in result.clean_text, 'bed 7 should be redacted'
print('Unit preservation: PASSED')
"

# 5. Verify no clinical number false positives
python -c "
from app.deidentification import deidentify_text
result = deidentify_text('Currently on O2 at 8 liters, sats 94%.')
assert '8 liters' in result.clean_text, '8 liters should not be redacted'
assert '94%' in result.clean_text, '94% should not be redacted'
print('False positive prevention: PASSED')
"
```
</verification>

<success_criteria>
1. ROOM recall improved from 32% to >=80% on validation set
2. All new contextual patterns working (prepositional, synonyms)
3. Unit names (PICU, NICU) preserved in output
4. No false positives on clinical numbers (O2, doses, ages, percentages)
5. Full test suite passes with no regressions
6. 15+ new tests added for ROOM pattern coverage
</success_criteria>

<output>
After completion, create `.planning/phases/17-room-pattern-expansion/17-01-SUMMARY.md`
</output>
