---
phase: 17-room-pattern-expansion
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - app/recognizers/medical.py
  - tests/test_deidentification.py
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "room_number_contextual pattern does NOT match phone number digits"
    - "room_number_contextual pattern does NOT match date components (January 11)"
    - "room_number_contextual pattern does NOT match time components (08:46)"
    - "room_number_contextual pattern does NOT match street addresses"
    - "room_number_contextual pattern does NOT match list numbers (1), 2))"
    - "ROOM precision >= 40% (up from 17%)"
  artifacts:
    - path: "app/recognizers/medical.py"
      provides: "Tightened contextual pattern with expanded negatives"
      contains: "room_number_contextual"
    - path: "tests/test_deidentification.py"
      provides: "Regression tests for ROOM false positive prevention"
      contains: "test_room_false_positive_prevention"
  key_links:
    - from: "app/recognizers/medical.py"
      to: "app/deidentification.py"
      via: "get_medical_recognizers() import"
      pattern: "get_medical_recognizers"
---

<objective>
Fix ROOM precision collapse (17% -> >=40%) by tightening the `room_number_contextual` pattern

Purpose: The low-confidence contextual pattern (score=0.30) is matching numbers that are NOT room numbers: phone digits, dates, times, addresses, and list markers. This produces 236 false positives and makes transcripts unreadable.

Output: Tightened regex pattern with expanded negative lookahead/lookbehind, plus regression tests
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/17-room-pattern-expansion/17-01-SUMMARY.md
@.planning/phases/17-room-pattern-expansion/17-VERIFICATION.md

Key findings from gap analysis:
- 236 ROOM false positives in synthetic dataset (17% precision)
- False positive categories:
  - 3-digit phone parts: 73 (e.g., "808" from "+1-808-738-6379")
  - 2-digit dates/times: 57 (e.g., "11" from "January 11")
  - Overlap matches: 48 (e.g., "bed 847" when ground truth is "847")
  - Single digit list markers: 43 (e.g., "1" from "1) GI consult")
  - 4+ digit addresses: 15 (e.g., "6247" from "6247 Hickman Cliffs")
</context>

<tasks>

<task type="auto">
  <name>Task 1: Tighten room_number_contextual Pattern Negatives</name>
  <files>app/recognizers/medical.py</files>
  <action>
Update the `room_number_contextual` pattern (around line 187-191) to exclude false positive sources:

1. **Add phone number negative lookbehind:**
   - `(?<!-\d{3}-)` - Don't match if preceded by phone pattern like "-808-"
   - `(?<!\+\d-)` - Don't match if preceded by "+1-" international prefix
   - `(?<!\d{3}-)` - Don't match if preceded by 3 digits and dash (phone area)

2. **Add date/time negative lookbehind:**
   - `(?<![Jj]anuary |[Ff]ebruary |[Mm]arch |[Aa]pril |[Mm]ay |[Jj]une |[Jj]uly |[Aa]ugust |[Ss]eptember |[Oo]ctober |[Nn]ovember |[Dd]ecember )`
   - This is too long; instead use: `(?<![A-Za-z]ary |[A-Za-z]ber |[A-Za-z]ch |[A-Za-z]il |[Mm]ay |[Jj]une |[Jj]uly )`
   - Or simpler: just add month-related words to negative lookbehind

3. **Add list number negative lookbehind:**
   - `(?<![:\s])` before numbers followed by `)` - catches "1) GI consult"
   - Or add `)` to negative lookahead

4. **Add address negative context:**
   - Enhance negative lookahead to include common address suffixes: `Street|Drive|Road|Avenue|Blvd|Lane|Way|Court|Place|Circle`

5. **Tighten the pattern to require room-like context:**
   - Consider requiring preceding room-context word within N characters
   - Alternative: Raise score from 0.30 to 0.45 to reduce marginal matches

**Simpler approach:** Since the issue is the pattern is too broad, the fix is to REMOVE the `room_number_contextual` pattern entirely and rely on the explicit patterns (room_standard, bed_standard, isolette_number, etc.) which have proper context built in.

**Recommended fix:** Change `room_number_contextual` to only match numbers that follow specific context words, not standalone numbers with context boost:

```python
# OLD (too broad):
Pattern(
    name="room_number_contextual",
    regex=r"(?<!\b(?:day|DOL|week|month|year|dose|at|FiO2|O2|sats)\s)\b\d{1,4}(?!\s*(?:mg|ml|mcg|kg|...))\b",
    score=0.30
)

# NEW (context-required):
# Remove this pattern entirely OR replace with explicit context prefix patterns
Pattern(
    name="room_number_in_context",
    regex=r"(?i)(?:patient in|over in|moved to|currently in|staying in|from)\s+(\d{1,4})\b",
    score=0.55  # Higher score since context explicitly required
)
```

Run `pytest tests/test_deidentification.py -v -k "room" --tb=short` to verify no regressions on existing tests.
  </action>
  <verify>
Run evaluation and check precision:
```bash
source venv/bin/activate
python -c "
import sys
sys.path.insert(0, '.')
from tests.generate_test_data import load_dataset
from tests.evaluate_presidio import PresidioEvaluator
from pathlib import Path

dataset = load_dataset(Path('tests/synthetic_handoffs.json'))
evaluator = PresidioEvaluator()
metrics, results = evaluator.evaluate_dataset(dataset)

room_tp = sum(1 for r in results for s in r.true_positives if s.entity_type == 'ROOM')
room_fn = sum(1 for r in results for s in r.false_negatives if s.entity_type == 'ROOM')
room_fp = sum(1 for r in results for s in r.false_positives if s['entity_type'] == 'ROOM')

precision = room_tp / (room_tp + room_fp) if (room_tp + room_fp) > 0 else 0
recall = room_tp / (room_tp + room_fn) if (room_tp + room_fn) > 0 else 0
print(f'ROOM: P={precision:.1%} R={recall:.1%} (TP={room_tp}, FP={room_fp}, FN={room_fn})')
print(f'Target: P>=40%')
"
```
Precision should be >= 40% (up from 17%).
  </verify>
  <done>ROOM precision >= 40% on synthetic dataset. Phone numbers, dates, times, addresses, and list markers no longer falsely detected as ROOM.</done>
</task>

<task type="auto">
  <name>Task 2: Add ROOM False Positive Prevention Tests</name>
  <files>tests/test_deidentification.py</files>
  <action>
Add regression tests to `TestRoomContextualPatterns` class to prevent reintroduction of false positives:

```python
@pytest.mark.parametrize("text,description", [
    # Phone number digits should NOT be detected as ROOM
    ("Contact dad at +1-808-738-6379 for updates.", "phone international format"),
    ("Call mom at 555-123-4567 extension 890.", "phone with extension"),
    ("Reach nurse at (212) 555-0123.", "phone with parens"),

    # Date components should NOT be detected as ROOM
    ("Born January 11, admitted January 19.", "date day numbers"),
    ("Previous admission on 01/15/2024.", "date slash format"),
    ("DOB: December 25, 2023.", "date with month name"),

    # Time components should NOT be detected as ROOM
    ("Albuterol given at 08:46 AM.", "time HH:MM format"),
    ("Next dose at 14:30.", "24-hour time"),
    ("Started continuous at 3:15 PM.", "12-hour time"),

    # Street addresses should NOT be detected as ROOM
    ("Patient from 6247 Hickman Cliffs.", "street number"),
    ("Lives at 1565 Brooks Drive Suite 111.", "address with suite"),
    ("Transferred from 425 Oak Street.", "street address"),

    # List numbers should NOT be detected as ROOM
    ("Action items: 1) GI consult 2) Labs 3) Imaging.", "list markers"),
    ("To do: 1. Call mom 2. Check vitals.", "numbered list dots"),
])
def test_room_false_positive_prevention(self, text, description):
    """Numbers in non-room context should NOT be detected as ROOM."""
    result = deidentify_text(text)
    # Should not contain [ROOM] marker for non-room numbers
    assert "[ROOM]" not in result, f"False positive ROOM in {description}: {result}"
```

Run tests to verify they pass:
```bash
pytest tests/test_deidentification.py -v -k "test_room_false_positive" --tb=short
```
  </action>
  <verify>`pytest tests/test_deidentification.py -v -k "test_room_false_positive" --tb=short` shows all tests pass</verify>
  <done>14 new regression tests for ROOM false positive prevention added and passing</done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `pytest tests/test_deidentification.py -v -k "room" --tb=short` - all room tests pass
2. ROOM precision >= 40% on full evaluation (up from 17%)
3. No new failing tests introduced
</verification>

<success_criteria>
- ROOM precision improved from 17% to >= 40%
- Phone number digits not falsely detected as ROOM
- Date components not falsely detected as ROOM
- Time components not falsely detected as ROOM
- Address numbers not falsely detected as ROOM
- List markers not falsely detected as ROOM
- Regression tests prevent reintroduction
</success_criteria>

<output>
After completion, create `.planning/phases/17-room-pattern-expansion/17-02-SUMMARY.md`
</output>
