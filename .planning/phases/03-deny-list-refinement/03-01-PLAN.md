---
phase: 03-deny-list-refinement
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/config.py
  - app/deidentification.py
autonomous: true

must_haves:
  truths:
    - "LOCATION deny list uses case-insensitive matching (NC, nc, Nc all filtered)"
    - "DATE_TIME deny list filters dosing schedules (q4h, BID, PRN not flagged)"
    - "GUARDIAN_NAME deny list filters generic relationship terms"
    - "PEDIATRIC_AGE deny list filters generic age categories"
  artifacts:
    - path: "app/config.py"
      provides: "New deny lists for DATE_TIME, GUARDIAN_NAME, PEDIATRIC_AGE"
      contains: "deny_list_date_time"
    - path: "app/deidentification.py"
      provides: "Deny list filtering for new entity types"
      contains: "deny_list_date_time"
  key_links:
    - from: "app/deidentification.py"
      to: "app/config.py"
      via: "settings.deny_list_date_time"
      pattern: "settings\\.deny_list_"
---

<objective>
Fix case-insensitive deny list bug and add new deny lists for all entity types.

Purpose: Reduce false positives by filtering medical abbreviations and clinical terms that are not PHI. The current LOCATION deny list has a case-sensitive bug that misses lowercase variants.
Output: Updated config.py with new deny lists and deidentification.py with case-insensitive filtering for all entity types.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-deny-list-refinement/03-RESEARCH.md
@app/config.py
@app/deidentification.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add new deny lists to config.py</name>
  <files>app/config.py</files>
  <action>
Add three new deny lists to the Settings class. Insert them immediately after the deny_list_person field (which ends at line 141, before the MRN Patterns section starting at line 143).

EXACT PLACEMENT: After line 141 (the closing `)` of deny_list_person), add these fields before the "# =========================================================================\n    # Custom MRN Patterns" comment:

1. deny_list_guardian_name:
```python
    deny_list_guardian_name: List[str] = Field(
        default=["parent", "guardian", "caregiver", "family"],
        description="Generic relationship terms not flagged as GUARDIAN_NAME"
    )
```

2. deny_list_pediatric_age:
```python
    deny_list_pediatric_age: List[str] = Field(
        default=["infant", "toddler", "child", "adolescent", "teen", "newborn", "neonate"],
        description="Generic age categories not flagged as PEDIATRIC_AGE"
    )
```

3. deny_list_date_time:
```python
    deny_list_date_time: List[str] = Field(
        default=[
            "today", "tonight", "yesterday", "tomorrow",
            "q4h", "q6h", "q8h", "q12h",
            "BID", "TID", "QID", "PRN", "prn",
            "daily", "nightly", "qd", "qhs",
        ],
        description="Generic time references and dosing schedules not flagged as DATE_TIME"
    )
```

ALSO: Remove redundant capitalized variants from deny_list_person. Delete these two lines (122-123):
```python
            "Mom",   # Generic relationship
            "Dad",   # Generic relationship
```
Keep only the lowercase "mom" and "dad" entries (lines 120-121) since case-insensitive matching in deidentification.py handles all variants.
  </action>
  <verify>
Run: python -c "from app.config import settings; print('deny_list_date_time' in dir(settings)); print(len(settings.deny_list_date_time) > 0)"
Expected: True, True
  </verify>
  <done>
Three new deny lists exist in config.py with appropriate terms for GUARDIAN_NAME, PEDIATRIC_AGE, and DATE_TIME.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix LOCATION case-insensitive bug and add deny list filtering</name>
  <files>app/deidentification.py</files>
  <action>
In deidentify_text function, update the deny list filtering section (around lines 182-193):

1. Fix LOCATION deny list to use case-insensitive matching:
CHANGE:
```python
if result.entity_type == "LOCATION" and detected_text in settings.deny_list_location:
```
TO:
```python
if result.entity_type == "LOCATION" and detected_text.lower() in [w.lower() for w in settings.deny_list_location]:
```

2. Add new deny list checks after the PERSON deny list check (after line 192):
```python
# Check GUARDIAN_NAME deny list
if result.entity_type == "GUARDIAN_NAME" and detected_text.lower() in [w.lower() for w in settings.deny_list_guardian_name]:
    logger.debug(f"Filtered out deny-listed GUARDIAN_NAME: {detected_text}")
    continue

# Check PEDIATRIC_AGE deny list
if result.entity_type == "PEDIATRIC_AGE" and detected_text.lower() in [w.lower() for w in settings.deny_list_pediatric_age]:
    logger.debug(f"Filtered out deny-listed PEDIATRIC_AGE: {detected_text}")
    continue

# Check DATE_TIME deny list
if result.entity_type == "DATE_TIME" and detected_text.lower() in [w.lower() for w in settings.deny_list_date_time]:
    logger.debug(f"Filtered out deny-listed DATE_TIME: {detected_text}")
    continue
```

Ensure all deny list comparisons use consistent case-insensitive matching pattern.
  </action>
  <verify>
Run: grep -n "deny_list" app/deidentification.py | head -20
Expected: Shows case-insensitive matching for LOCATION, PERSON, GUARDIAN_NAME, PEDIATRIC_AGE, DATE_TIME

ALSO verify both case variants:
Run: python -c "from app.deidentification import deidentify_text; r1 = deidentify_text('Patient on NC'); r2 = deidentify_text('Patient on nc'); print('NC' in r1.clean_text and 'nc' in r2.clean_text)"
Expected: True (both uppercase NC and lowercase nc preserved)
  </verify>
  <done>
- LOCATION deny list uses case-insensitive matching (NC and nc both filtered)
- GUARDIAN_NAME, PEDIATRIC_AGE, DATE_TIME deny list filtering added
- All deny list checks use consistent .lower() comparison pattern
  </done>
</task>

</tasks>

<verification>
1. Run: python -c "from app.config import settings; print([x for x in dir(settings) if 'deny' in x])"
   Expected: Shows deny_list_location, deny_list_person, deny_list_guardian_name, deny_list_pediatric_age, deny_list_date_time

2. Run: python -c "from app.deidentification import deidentify_text; r1 = deidentify_text('Patient on NC'); r2 = deidentify_text('Patient on nc'); print('NC' in r1.clean_text and 'nc' in r2.clean_text)"
   Expected: True (both uppercase and lowercase NC/nc preserved, not flagged as location)

3. Run: python -c "from app.deidentification import deidentify_text; r = deidentify_text('Give medication BID'); print('BID' in r.clean_text)"
   Expected: True (BID preserved, not flagged as DATE_TIME)
</verification>

<success_criteria>
- DENY-01: LOCATION deny list uses case-insensitive matching (nc, NC, Nc all filtered)
- DENY-02: Medical abbreviation deny lists include dosing schedules
- DENY-03: Deny lists exist for GUARDIAN_NAME, PEDIATRIC_AGE, DATE_TIME entity types
- All deny list comparisons use consistent case-insensitive pattern
</success_criteria>

<output>
After completion, create `.planning/phases/03-deny-list-refinement/03-01-SUMMARY.md`
</output>
