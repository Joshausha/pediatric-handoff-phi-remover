---
phase: 03-deny-list-refinement
plan: 02
type: execute
wave: 2
depends_on: [03-01]
files_modified:
  - tests/evaluate_presidio.py
  - tests/calibrate_thresholds.py
  - tests/test_deidentification.py
  - .planning/phases/01-baseline-measurement/BASELINE_METRICS.md
autonomous: true

must_haves:
  truths:
    - "Test files use same deny list filtering as production code"
    - "Case-insensitive matching works for all deny lists in test files"
    - "Regression tests verify deny list filtering prevents false positives"
    - "False positive reduction is measured and documented (DENY-04: >20% reduction, precision 87.4%->90%+)"
  artifacts:
    - path: "tests/evaluate_presidio.py"
      provides: "Consistent deny list filtering with production"
      contains: "deny_list_date_time"
    - path: "tests/calibrate_thresholds.py"
      provides: "Consistent deny list filtering with production"
      contains: "deny_list_date_time"
    - path: "tests/test_deidentification.py"
      provides: "Regression tests for deny list filtering"
      contains: "test_medical_abbreviation"
    - path: ".planning/phases/01-baseline-measurement/BASELINE_METRICS.md"
      provides: "Precision improvement documentation"
      contains: "Phase 03"
  key_links:
    - from: "tests/evaluate_presidio.py"
      to: "app/config.py"
      via: "settings.deny_list_*"
      pattern: "settings\\.deny_list_"

# Note: Tasks 1-3 intentionally duplicate deny list filtering logic across test files.
# This maintains test isolation and keeps evaluation/calibration scripts self-contained.
# Accepted pattern per scope_sanity review.
---

<objective>
Mirror deny list changes in test files, add regression tests, and measure precision improvement.

Purpose: Ensure evaluation and calibration scripts use the same deny list filtering as production code. Add regression tests to prevent future false positive regressions. Measure and document precision improvement per DENY-04 requirement.
Output: Updated test files with consistent deny list handling, new regression tests, and documented precision metrics in BASELINE_METRICS.md.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-deny-list-refinement/03-01-SUMMARY.md
@tests/evaluate_presidio.py
@tests/calibrate_thresholds.py
@tests/test_deidentification.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update deny list filtering in evaluate_presidio.py</name>
  <files>tests/evaluate_presidio.py</files>
  <action>
In the analyze_text method (around line 168-186), update deny list filtering to match production code:

1. Fix LOCATION deny list case-insensitive matching (line 173):
CHANGE:
```python
if result.entity_type == "LOCATION" and detected_text in settings.deny_list_location:
```
TO:
```python
if result.entity_type == "LOCATION" and detected_text.lower() in [w.lower() for w in settings.deny_list_location]:
```

2. Add new deny list checks after PERSON check:
```python
if result.entity_type == "GUARDIAN_NAME" and detected_text.lower() in [w.lower() for w in settings.deny_list_guardian_name]:
    continue
if result.entity_type == "PEDIATRIC_AGE" and detected_text.lower() in [w.lower() for w in settings.deny_list_pediatric_age]:
    continue
if result.entity_type == "DATE_TIME" and detected_text.lower() in [w.lower() for w in settings.deny_list_date_time]:
    continue
```
  </action>
  <verify>
Run: grep -n "deny_list" tests/evaluate_presidio.py | head -20
Expected: Shows case-insensitive matching for all deny lists
  </verify>
  <done>
evaluate_presidio.py uses same deny list filtering as app/deidentification.py
  </done>
</task>

<task type="auto">
  <name>Task 2: Update deny list filtering in calibrate_thresholds.py</name>
  <files>tests/calibrate_thresholds.py</files>
  <action>
In the _analyze_text_raw method (around line 130-148), update deny list filtering to match production code:

1. Fix LOCATION deny list case-insensitive matching (line 135):
CHANGE:
```python
if result.entity_type == "LOCATION" and detected_text in settings.deny_list_location:
```
TO:
```python
if result.entity_type == "LOCATION" and detected_text.lower() in [w.lower() for w in settings.deny_list_location]:
```

2. Add new deny list checks after PERSON check:
```python
if result.entity_type == "GUARDIAN_NAME" and detected_text.lower() in [w.lower() for w in settings.deny_list_guardian_name]:
    continue
if result.entity_type == "PEDIATRIC_AGE" and detected_text.lower() in [w.lower() for w in settings.deny_list_pediatric_age]:
    continue
if result.entity_type == "DATE_TIME" and detected_text.lower() in [w.lower() for w in settings.deny_list_date_time]:
    continue
```
  </action>
  <verify>
Run: grep -n "deny_list" tests/calibrate_thresholds.py | head -20
Expected: Shows case-insensitive matching for all deny lists
  </verify>
  <done>
calibrate_thresholds.py uses same deny list filtering as app/deidentification.py
  </done>
</task>

<task type="auto">
  <name>Task 3: Add regression tests for deny list filtering</name>
  <files>tests/test_deidentification.py</files>
  <action>
Add a new test class for deny list filtering at the end of test_deidentification.py:

```python
class TestDenyListFiltering:
    """Test deny list filtering for false positive prevention."""

    @pytest.mark.parametrize("abbreviation", [
        "NC", "nc", "Nc",  # Case variants - nasal cannula
        "RA", "ra",        # Room air
        "OR", "or",        # Operating room
        "ER", "er",        # Emergency room
        "IV", "iv",        # Intravenous
        "PO", "po",        # By mouth
    ])
    def test_medical_abbreviation_not_flagged_as_location(self, abbreviation):
        """Test that medical abbreviations are not flagged as LOCATION."""
        text = f"Patient on {abbreviation} oxygen at bedside."
        result = deidentify_text(text)

        # Abbreviation should be preserved (not redacted)
        assert abbreviation in result.clean_text or abbreviation.lower() in result.clean_text.lower(), \
            f"'{abbreviation}' was incorrectly redacted as LOCATION"

    @pytest.mark.parametrize("role_word", [
        "mom", "Mom", "MOM",  # Case variants
        "dad", "Dad",
        "nurse", "doctor", "guardian",
    ])
    def test_role_words_not_flagged_as_person(self, role_word):
        """Test that standalone role words are not flagged as PERSON."""
        text = f"Contact {role_word} for updates."
        result = deidentify_text(text)

        # Role word should be preserved
        assert role_word in result.clean_text or role_word.lower() in result.clean_text.lower(), \
            f"'{role_word}' was incorrectly redacted as PERSON"

    @pytest.mark.parametrize("dosing_schedule", [
        "BID", "bid",
        "TID", "tid",
        "QID", "qid",
        "PRN", "prn",
        "q4h", "Q4H",
        "daily", "nightly",
    ])
    def test_dosing_schedules_not_flagged_as_datetime(self, dosing_schedule):
        """Test that dosing schedules are not flagged as DATE_TIME."""
        text = f"Give medication {dosing_schedule} as ordered."
        result = deidentify_text(text)

        # Dosing schedule should be preserved
        assert dosing_schedule in result.clean_text or dosing_schedule.lower() in result.clean_text.lower(), \
            f"'{dosing_schedule}' was incorrectly redacted as DATE_TIME"
```

Make sure pytest is imported at the top of the file if not already.
  </action>
  <verify>
Run: pytest tests/test_deidentification.py::TestDenyListFiltering -v --tb=short
Expected: All parameterized tests pass
  </verify>
  <done>
- Regression tests exist for LOCATION deny list (case variants)
- Regression tests exist for PERSON deny list (role words)
- Regression tests exist for DATE_TIME deny list (dosing schedules)
- All tests use pytest parameterization for comprehensive coverage
  </done>
</task>

<task type="auto">
  <name>Task 4: Measure and document precision improvement (DENY-04)</name>
  <files>.planning/phases/01-baseline-measurement/BASELINE_METRICS.md</files>
  <action>
Run evaluate_presidio.py to measure precision improvement and update the existing baseline metrics file.

1. Run evaluation to capture post-change metrics:
```bash
python tests/evaluate_presidio.py --input tests/synthetic_handoffs.json 2>&1 | tee /tmp/phase03_metrics.txt
```

2. Extract key metrics from output:
   - Overall precision (target: >90%, baseline was 87.4%)
   - False positive count (target: >20% reduction)
   - Per-entity precision for LOCATION, DATE_TIME

3. Append a new Phase 03 section to the existing `.planning/phases/01-baseline-measurement/BASELINE_METRICS.md` file (which already contains Phase 01 baseline data). Add this section before the "Raw Data References" section at the end:

```markdown
## Phase 03: Deny List Refinement (2026-01-XX)

### Precision Improvement
| Metric | Baseline (Phase 01) | Post-Phase 03 | Change |
|--------|---------------------|---------------|--------|
| Overall Precision | 66.3% | XX.X% | +X.X% |
| False Positives | 662 | XXX | -XX% |
| LOCATION Precision | 80.6% | XX.X% | +X.X% |
| DATE_TIME Precision | 35.5% | XX.X% | +X.X% |

### Changes Made
- Fixed LOCATION deny list case-insensitive matching (NC/nc/Nc all filtered)
- Added deny lists for GUARDIAN_NAME, PEDIATRIC_AGE, DATE_TIME
- Added dosing schedule filtering (BID, TID, PRN, q4h, etc.)

### DENY-04 Requirement Status
- [ ] False positive reduction >20%: (actual: XX%)
- [ ] Precision improvement toward 90%: (actual: XX.X%)
```

Note: The file already exists at `.planning/phases/01-baseline-measurement/BASELINE_METRICS.md` with Phase 01 baseline data. Append Phase 03 results to this file. Fill in actual values from evaluation output. If targets not met, document gap for Phase 04.
  </action>
  <verify>
Run: grep -A5 "Phase 03" .planning/phases/01-baseline-measurement/BASELINE_METRICS.md
Expected: Shows Phase 03 section with precision metrics
  </verify>
  <done>
- DENY-04 precision improvement measured and documented
- Baseline vs post-change metrics captured in existing BASELINE_METRICS.md
- Gap analysis documented if targets not fully met
  </done>
</task>

</tasks>

<verification>
1. Run: pytest tests/test_deidentification.py -v --tb=short
   Expected: All tests pass including new deny list tests

2. Run: python tests/evaluate_presidio.py --input tests/synthetic_handoffs.json 2>/dev/null | tail -20
   Expected: Evaluation runs without errors, uses updated deny lists

3. Run: diff <(grep -c "deny_list" app/deidentification.py) <(grep -c "deny_list" tests/evaluate_presidio.py)
   Expected: Similar deny list usage between production and test code

4. Run: grep "Precision" .planning/phases/01-baseline-measurement/BASELINE_METRICS.md | head -5
   Expected: Shows precision metrics for Phase 03
</verification>

<success_criteria>
- DENY-01: All files use case-insensitive deny list matching
- DENY-03: Test files filter GUARDIAN_NAME, PEDIATRIC_AGE, DATE_TIME
- DENY-04: Precision improvement measured (target: 87.4%->90%+, >20% FP reduction)
- DENY-04: Results documented in BASELINE_METRICS.md
- Consistency: Production and test code use identical deny list logic
</success_criteria>

<output>
After completion, create `.planning/phases/03-deny-list-refinement/03-02-SUMMARY.md`
</output>
