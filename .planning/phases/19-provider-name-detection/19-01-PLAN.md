---
phase: 19-provider-name-detection
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/recognizers/provider.py
  - app/recognizers/__init__.py
  - app/config.py
  - app/deidentification.py
  - test_presidio.py
autonomous: true

must_haves:
  truths:
    - "Dr. Smith" detected as PROVIDER_NAME
    - "Dr Smith" (no period) detected as PROVIDER_NAME
    - Generic "Dr." without name NOT flagged
    - Context words preserved ("Dr." visible in output)
  artifacts:
    - path: "app/recognizers/provider.py"
      provides: "PROVIDER_NAME recognizer with title-prefixed patterns"
      exports: ["get_provider_recognizers"]
    - path: "app/config.py"
      provides: "PROVIDER_NAME entity type and deny list"
      contains: "PROVIDER_NAME"
  key_links:
    - from: "app/recognizers/__init__.py"
      to: "app/recognizers/provider.py"
      via: "import get_provider_recognizers"
      pattern: "from .provider import get_provider_recognizers"
    - from: "app/deidentification.py"
      to: "app/recognizers/__init__.py"
      via: "import recognizers"
      pattern: "get_provider_recognizers"
---

<objective>
Implement title-prefixed provider name patterns (Dr., NP, PA, RN) as the foundation for provider name detection.

Purpose: Title-prefixed patterns ("Dr. Smith", "NP Johnson") are the most common provider reference pattern in clinical handoffs. Establishing the recognizer infrastructure and core title patterns enables subsequent plans to add context-based patterns.

Output: New provider.py recognizer module with ~15 title patterns, config integration, and 3-4 test cases passing.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-provider-name-detection/19-CONTEXT.md
@.planning/phases/19-provider-name-detection/19-RESEARCH.md
@app/recognizers/pediatric.py
@app/config.py
@app/deidentification.py
@test_presidio.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create provider.py recognizer module</name>
  <files>app/recognizers/provider.py</files>
  <action>
Create new provider.py module following the pediatric.py pattern architecture:

1. Add module docstring explaining purpose (provider names in handoffs)
2. Create `get_provider_recognizers()` function returning list[PatternRecognizer]
3. Add title-prefixed patterns using lookbehind (matches name only, preserves title):

Title patterns (score 0.85):
- "Dr. " (4 chars) -> `(?<=Dr\. )[A-Z][a-z]+\b`
- "Dr " (3 chars, no period) -> `(?<=Dr )[A-Z][a-z]+\b`
- "NP " (3 chars) -> `(?<=NP )[A-Z][a-z]+\b`
- "PA " (3 chars) -> `(?<=PA )[A-Z][a-z]+\b`
- "RN " (3 chars) -> `(?<=RN )[A-Z][a-z]+\b`

Suffix patterns (score 0.80, slightly lower - less common in speech):
- " MD" -> `\b[A-Z][a-z]+(?= MD\b)` (lookahead)
- " RN" (as suffix) -> `\b[A-Z][a-z]+(?= RN\b)`

4. Create PatternRecognizer with:
   - supported_entity="PROVIDER_NAME"
   - name="Provider Name Recognizer"
   - context=["doctor", "physician", "attending", "fellow", "resident", "nurse", "Dr", "NP", "PA", "RN"]

CRITICAL: All patterns require [A-Z][a-z]+ to prevent matching verbs like "is", "at"
  </action>
  <verify>python -c "from app.recognizers.provider import get_provider_recognizers; r = get_provider_recognizers(); print(f'Loaded {len(r)} recognizers with {sum(len(rec.patterns) for rec in r)} patterns')"</verify>
  <done>Provider recognizer loads with ~10 title-prefixed patterns</done>
</task>

<task type="auto">
  <name>Task 2: Integrate provider recognizer into system</name>
  <files>app/recognizers/__init__.py, app/config.py, app/deidentification.py</files>
  <action>
1. Update app/recognizers/__init__.py:
   - Add: `from .provider import get_provider_recognizers`
   - Update __all__ to include "get_provider_recognizers"

2. Update app/config.py:
   - Add "PROVIDER_NAME" to phi_entities list (after GUARDIAN_NAME)
   - Add "PROVIDER_NAME": 0.30 to phi_score_thresholds
   - Add spoken_handoff_weights["PROVIDER_NAME"] = 3.0 (commonly spoken in handoffs)
   - Add spoken_handoff_risk_weights["PROVIDER_NAME"] = 2.0 (moderate risk - providers are less identifying than patients)
   - Add deny_list_provider_name with:
     ["attending", "fellow", "resident", "intern", "doctor", "nurse", "nursing",
      "physician", "provider", "clinician", "Dr", "NP", "PA", "RN", "LPN", "CNA", "MD",
      "uh", "um", "the"]

3. Update app/deidentification.py:
   - Add import: get_provider_recognizers to the imports from .recognizers
   - Add registration loop in _get_engines() after pediatric recognizers:
     ```python
     for recognizer in get_provider_recognizers():
         registry.add_recognizer(recognizer)
         logger.debug(f"Added recognizer: {recognizer.name}")
     ```
   - Add deny list filtering after GUARDIAN_NAME check (~line 200):
     ```python
     if result.entity_type == "PROVIDER_NAME" and detected_text.lower() in [w.lower() for w in settings.deny_list_provider_name]:
         logger.debug(f"Filtered out deny-listed PROVIDER_NAME: {detected_text}")
         continue
     ```
   - Add marker mapping: "[Provider Name]": "[NAME]" in marker_map dict
  </action>
  <verify>python -c "from app.deidentification import deidentify_text; r = deidentify_text('Dr. Smith is on service.'); print(r.clean_text)"</verify>
  <done>PROVIDER_NAME entity detected and replaced with [NAME] marker</done>
</task>

<task type="auto">
  <name>Task 3: Add provider name test cases</name>
  <files>test_presidio.py</files>
  <action>
Add test cases to TEST_CASES list in test_presidio.py, after the existing "Provider name" test:

```python
# === PROVIDER NAME PATTERNS (Phase 19) ===
{
    "name": "Provider - Dr. with period",
    "input": "Spoke with Dr. Martinez about the plan.",
    "must_redact": ["Martinez"],
    "must_preserve": ["Dr.", "Spoke", "plan"],
},
{
    "name": "Provider - Dr without period",
    "input": "Paged Dr Chen for the consult.",
    "must_redact": ["Chen"],
    "must_preserve": ["Dr", "Paged", "consult"],
},
{
    "name": "Provider - NP title",
    "input": "NP Williams did the admission.",
    "must_redact": ["Williams"],
    "must_preserve": ["NP", "admission"],
},
{
    "name": "Provider - standalone title (should NOT redact)",
    "input": "The attending is on call.",
    "must_redact": [],
    "must_preserve": ["attending", "call"],
},
```

Note: Update the existing "Provider name" test case if needed to align with new patterns.
  </action>
  <verify>python test_presidio.py 2>&1 | grep -E "(PASS|FAIL|Provider)"</verify>
  <done>Provider name tests pass, existing tests unaffected</done>
</task>

</tasks>

<verification>
1. Run test harness: `python test_presidio.py` - all tests pass (including new provider tests)
2. Run full test suite: `pytest tests/ -v -k "not integration"` - no regressions
3. Manual verification: "Dr. Smith" -> "[NAME]" with "Dr." preserved
4. Deny list verification: "the attending" not flagged as provider name
</verification>

<success_criteria>
- [ ] provider.py module exists with get_provider_recognizers() function
- [ ] ~10 title-prefixed patterns using lookbehind/lookahead
- [ ] PROVIDER_NAME entity type in config.py with weights and deny list
- [ ] Provider recognizers loaded in deidentification.py
- [ ] 4 new provider test cases passing
- [ ] No regressions on existing tests
- [ ] "Dr. Smith" -> "Dr. [NAME]" with title preserved
</success_criteria>

<output>
After completion, create `.planning/phases/19-provider-name-detection/19-01-SUMMARY.md`
</output>
