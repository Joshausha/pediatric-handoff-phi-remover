---
phase: 19-provider-name-detection
plan: 02
type: execute
wave: 2
depends_on: ["19-01"]
files_modified:
  - app/recognizers/provider.py
  - test_presidio.py
autonomous: true

must_haves:
  truths:
    - "the attending is Rodriguez" detected (role context without title)
    - "his nurse Sarah" detected (possessive + role)
    - "her doctor Dr. Chen" detected (possessive with title)
    - Generic "the nurse" NOT flagged as provider name
  artifacts:
    - path: "app/recognizers/provider.py"
      provides: "Role context patterns (attending, nurse, fellow, resident)"
      contains: "attending_is_name"
  key_links:
    - from: "test_presidio.py"
      to: "app/recognizers/provider.py"
      via: "test case execution"
      pattern: "attending is"
---

<objective>
Add role context patterns for detecting provider names without formal titles ("the attending is Rodriguez", "his nurse Sarah").

Purpose: Handoffs often reference providers by role rather than title. Patterns like "the attending is [Name]" and possessive forms "his nurse [Name]" catch informal references that title-prefixed patterns miss.

Output: ~35 new role context patterns added to provider.py, 4 new test cases passing.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/19-provider-name-detection/19-01-SUMMARY.md
@.planning/phases/19-provider-name-detection/19-RESEARCH.md
@app/recognizers/provider.py
@app/recognizers/pediatric.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add "the [role] is [Name]" patterns</name>
  <files>app/recognizers/provider.py</files>
  <action>
Add role context patterns to the provider_patterns list following Phase 18 fixed-width lookbehind architecture:

Role "is" patterns (score 0.85 - strong context):
```python
# =================================================================
# Role context patterns: "the attending is [Name]" (score 0.85)
# Using lookbehind to match ONLY the name
# =================================================================
# "the attending is " = 17 chars
Pattern(name="attending_is_name", regex=r"(?<=the attending is )[A-Z][a-z]+\b", score=0.85),
# "the fellow is " = 14 chars
Pattern(name="fellow_is_name", regex=r"(?<=the fellow is )[A-Z][a-z]+\b", score=0.85),
# "the resident is " = 16 chars
Pattern(name="resident_is_name", regex=r"(?<=the resident is )[A-Z][a-z]+\b", score=0.85),
# "the intern is " = 14 chars
Pattern(name="intern_is_name", regex=r"(?<=the intern is )[A-Z][a-z]+\b", score=0.85),
# "the nurse is " = 13 chars
Pattern(name="nurse_is_name", regex=r"(?<=the nurse is )[A-Z][a-z]+\b", score=0.85),
# "the doctor is " = 14 chars
Pattern(name="doctor_is_name", regex=r"(?<=the doctor is )[A-Z][a-z]+\b", score=0.85),
# "the NP is " = 10 chars
Pattern(name="np_is_name", regex=r"(?<=the NP is )[A-Z][a-z]+\b", score=0.85),
# "the PA is " = 10 chars
Pattern(name="pa_is_name", regex=r"(?<=the PA is )[A-Z][a-z]+\b", score=0.85),
```

CRITICAL: All patterns require [A-Z][a-z]+ to prevent matching common words.
  </action>
  <verify>python -c "from app.recognizers.provider import get_provider_recognizers; import re; patterns = [p for r in get_provider_recognizers() for p in r.patterns]; [re.compile(p.regex) for p in patterns]; print(f'{len(patterns)} patterns compile OK')"</verify>
  <done>Role "is" patterns added and compile successfully</done>
</task>

<task type="auto">
  <name>Task 2: Add possessive role patterns</name>
  <files>app/recognizers/provider.py</files>
  <action>
Add possessive pronoun + role patterns following Phase 18 Guardian pattern architecture:

Possessive patterns (score 0.85):
```python
# =================================================================
# Possessive role patterns: "his nurse Sarah" (score 0.85)
# Following Phase 18 Guardian pattern architecture
# Each pronoun length requires separate pattern (fixed-width lookbehind)
# =================================================================

# --- his + role (3 + space + role + space) ---
# "his nurse " = 10 chars
Pattern(name="his_nurse_name", regex=r"(?<=his nurse )[A-Z][a-z]+\b", score=0.85),
# "his doctor " = 11 chars
Pattern(name="his_doctor_name", regex=r"(?<=his doctor )[A-Z][a-z]+\b", score=0.85),
# "his attending " = 14 chars
Pattern(name="his_attending_name", regex=r"(?<=his attending )[A-Z][a-z]+\b", score=0.85),
# "his fellow " = 11 chars
Pattern(name="his_fellow_name", regex=r"(?<=his fellow )[A-Z][a-z]+\b", score=0.85),
# "his resident " = 13 chars
Pattern(name="his_resident_name", regex=r"(?<=his resident )[A-Z][a-z]+\b", score=0.85),

# --- her + role (3 + space + role + space) ---
# "her nurse " = 10 chars
Pattern(name="her_nurse_name", regex=r"(?<=her nurse )[A-Z][a-z]+\b", score=0.85),
# "her doctor " = 11 chars
Pattern(name="her_doctor_name", regex=r"(?<=her doctor )[A-Z][a-z]+\b", score=0.85),
# "her attending " = 14 chars
Pattern(name="her_attending_name", regex=r"(?<=her attending )[A-Z][a-z]+\b", score=0.85),
# "her fellow " = 11 chars
Pattern(name="her_fellow_name", regex=r"(?<=her fellow )[A-Z][a-z]+\b", score=0.85),
# "her resident " = 13 chars
Pattern(name="her_resident_name", regex=r"(?<=her resident )[A-Z][a-z]+\b", score=0.85),

# --- their + role (5 + space + role + space) ---
# "their nurse " = 12 chars
Pattern(name="their_nurse_name", regex=r"(?<=their nurse )[A-Z][a-z]+\b", score=0.85),
# "their doctor " = 13 chars
Pattern(name="their_doctor_name", regex=r"(?<=their doctor )[A-Z][a-z]+\b", score=0.85),
# "their attending " = 16 chars
Pattern(name="their_attending_name", regex=r"(?<=their attending )[A-Z][a-z]+\b", score=0.85),
# "their fellow " = 13 chars
Pattern(name="their_fellow_name", regex=r"(?<=their fellow )[A-Z][a-z]+\b", score=0.85),
# "their resident " = 15 chars
Pattern(name="their_resident_name", regex=r"(?<=their resident )[A-Z][a-z]+\b", score=0.85),
```

Add nurse is pattern variations:
```python
# "nurse is " = 9 chars (informal)
Pattern(name="nurse_is_informal", regex=r"(?<=nurse is )[A-Z][a-z]+\b", score=0.80),
```
  </action>
  <verify>python -c "from app.recognizers.provider import get_provider_recognizers; patterns = [p for r in get_provider_recognizers() for p in r.patterns]; poss = [p for p in patterns if 'his_' in p.name or 'her_' in p.name or 'their_' in p.name]; print(f'{len(poss)} possessive patterns')"</verify>
  <done>15+ possessive role patterns added</done>
</task>

<task type="auto">
  <name>Task 3: Add role context test cases</name>
  <files>test_presidio.py</files>
  <action>
Add test cases to TEST_CASES list after the Phase 19 title tests:

```python
# === PROVIDER ROLE CONTEXT PATTERNS (Phase 19-02) ===
{
    "name": "Provider - the attending is",
    "input": "The attending is Rodriguez, on until 7pm.",
    "must_redact": ["Rodriguez"],
    "must_preserve": ["attending", "7pm"],
},
{
    "name": "Provider - his nurse",
    "input": "His nurse Sarah gave meds at 2pm.",
    "must_redact": ["Sarah"],
    "must_preserve": ["His", "nurse", "meds"],
},
{
    "name": "Provider - her doctor",
    "input": "Her doctor Dr. Patel ordered labs.",
    "must_redact": ["Patel"],
    "must_preserve": ["Her", "doctor", "Dr.", "labs"],
},
{
    "name": "Provider - standalone role (should NOT redact)",
    "input": "The nurse is busy with another patient.",
    "must_redact": [],
    "must_preserve": ["nurse", "busy", "patient"],
},
```
  </action>
  <verify>python test_presidio.py 2>&1 | grep -E "(PASS|FAIL|Provider.*attending|Provider.*nurse|Provider.*doctor)"</verify>
  <done>Role context tests pass, no regressions</done>
</task>

</tasks>

<verification>
1. Run test harness: `python test_presidio.py` - all tests pass
2. Verify pattern count: 30+ role context patterns loaded
3. Manual: "the attending is Smith" -> "the attending is [NAME]"
4. Manual: "his nurse Sarah" -> "his nurse [NAME]"
5. Negative: "The nurse is busy" -> no redaction
</verification>

<success_criteria>
- [ ] 8+ role "is" patterns (attending, fellow, resident, intern, nurse, doctor, NP, PA)
- [ ] 15+ possessive role patterns (his/her/their x 5 roles)
- [ ] 4 new test cases passing
- [ ] No regressions on existing tests
- [ ] Generic role references not flagged ("the nurse" without name)
</success_criteria>

<output>
After completion, create `.planning/phases/19-provider-name-detection/19-02-SUMMARY.md`
</output>
