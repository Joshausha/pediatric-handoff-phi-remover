---
phase: 19-provider-name-detection
plan: 03
type: execute
wave: 3
depends_on: ["19-01", "19-02"]
files_modified:
  - app/recognizers/provider.py
  - test_presidio.py
autonomous: true

must_haves:
  truths:
    - "paged Dr. Smith" detected (action + title + name)
    - "called Dr. Chen" detected
    - "spoke with Dr. Williams" detected
    - "discussed with the attending" NOT flagged (no name)
  artifacts:
    - path: "app/recognizers/provider.py"
      provides: "Action context patterns (paged, called, spoke with)"
      contains: "paged_dr_name"
  key_links:
    - from: "test_presidio.py"
      to: "app/recognizers/provider.py"
      via: "test case execution"
      pattern: "paged Dr"
---

<objective>
Add action context patterns for detecting provider names in communication contexts ("paged Dr. Smith", "called Dr. Chen", "spoke with NP Williams").

Purpose: Clinical handoffs frequently describe communication with providers. Action verbs like "paged", "called", "spoke with" provide strong context for provider name detection.

Output: ~20 action context patterns added to provider.py, 3 test cases passing.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/19-provider-name-detection/19-01-SUMMARY.md
@.planning/phases/19-provider-name-detection/19-02-SUMMARY.md
@.planning/phases/19-provider-name-detection/19-RESEARCH.md
@app/recognizers/provider.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add action + title patterns</name>
  <files>app/recognizers/provider.py</files>
  <action>
Add action context patterns combining communication verbs with titles:

Action + Title patterns (score 0.80 - action verbs are less specific than role context):
```python
# =================================================================
# Action context patterns: "paged Dr. Smith" (score 0.80)
# Communication verbs + title provide context for provider names
# =================================================================

# --- paged + title ---
# "paged Dr. " = 10 chars
Pattern(name="paged_dr_period_name", regex=r"(?<=paged Dr\. )[A-Z][a-z]+\b", score=0.80),
# "paged Dr " = 9 chars
Pattern(name="paged_dr_name", regex=r"(?<=paged Dr )[A-Z][a-z]+\b", score=0.80),
# "paged NP " = 9 chars
Pattern(name="paged_np_name", regex=r"(?<=paged NP )[A-Z][a-z]+\b", score=0.80),

# --- called + title ---
# "called Dr. " = 11 chars
Pattern(name="called_dr_period_name", regex=r"(?<=called Dr\. )[A-Z][a-z]+\b", score=0.80),
# "called Dr " = 10 chars
Pattern(name="called_dr_name", regex=r"(?<=called Dr )[A-Z][a-z]+\b", score=0.80),

# --- with + title ---
# "with Dr. " = 9 chars
Pattern(name="with_dr_period_name", regex=r"(?<=with Dr\. )[A-Z][a-z]+\b", score=0.80),
# "with Dr " = 8 chars
Pattern(name="with_dr_name", regex=r"(?<=with Dr )[A-Z][a-z]+\b", score=0.80),
# "with NP " = 8 chars
Pattern(name="with_np_name", regex=r"(?<=with NP )[A-Z][a-z]+\b", score=0.80),
# "with PA " = 8 chars
Pattern(name="with_pa_name", regex=r"(?<=with PA )[A-Z][a-z]+\b", score=0.80),

# --- spoke with + title ---
# "spoke with Dr. " = 15 chars
Pattern(name="spoke_with_dr_period_name", regex=r"(?<=spoke with Dr\. )[A-Z][a-z]+\b", score=0.80),
# "spoke with Dr " = 14 chars
Pattern(name="spoke_with_dr_name", regex=r"(?<=spoke with Dr )[A-Z][a-z]+\b", score=0.80),

# --- discussed with + title ---
# "discussed with Dr. " = 19 chars
Pattern(name="discussed_with_dr_period_name", regex=r"(?<=discussed with Dr\. )[A-Z][a-z]+\b", score=0.80),
# "discussed with Dr " = 18 chars
Pattern(name="discussed_with_dr_name", regex=r"(?<=discussed with Dr )[A-Z][a-z]+\b", score=0.80),

# --- by + title (passive voice) ---
# "by Dr. " = 7 chars
Pattern(name="by_dr_period_name", regex=r"(?<=by Dr\. )[A-Z][a-z]+\b", score=0.80),
# "by Dr " = 6 chars
Pattern(name="by_dr_name", regex=r"(?<=by Dr )[A-Z][a-z]+\b", score=0.80),
```

CRITICAL: Use score 0.80 (slightly lower than role context 0.85) since action verbs are less specific.
  </action>
  <verify>python -c "from app.recognizers.provider import get_provider_recognizers; patterns = [p for r in get_provider_recognizers() for p in r.patterns]; action = [p for p in patterns if 'paged' in p.name or 'called' in p.name or 'with_' in p.name or 'by_' in p.name]; print(f'{len(action)} action patterns')"</verify>
  <done>15+ action context patterns added</done>
</task>

<task type="auto">
  <name>Task 2: Add action + role patterns (informal)</name>
  <files>app/recognizers/provider.py</files>
  <action>
Add patterns for action verbs with role words (informal references):

Action + Role patterns (score 0.75 - less specific):
```python
# =================================================================
# Action + role patterns: "paged the attending" (lower score)
# These need the name to follow, not just role reference
# =================================================================

# "paged the attending " = 20 chars (needs name after)
Pattern(name="paged_attending_name", regex=r"(?<=paged the attending )[A-Z][a-z]+\b", score=0.75),
# "called the attending " = 21 chars
Pattern(name="called_attending_name", regex=r"(?<=called the attending )[A-Z][a-z]+\b", score=0.75),
# "paged the fellow " = 17 chars
Pattern(name="paged_fellow_name", regex=r"(?<=paged the fellow )[A-Z][a-z]+\b", score=0.75),
# "called the fellow " = 18 chars
Pattern(name="called_fellow_name", regex=r"(?<=called the fellow )[A-Z][a-z]+\b", score=0.75),
```

Note: Keep these lower priority (0.75) since "paged the attending" often doesn't include a name.
  </action>
  <verify>python -c "from app.recognizers.provider import get_provider_recognizers; patterns = [p for r in get_provider_recognizers() for p in r.patterns]; print(f'Total: {len(patterns)} patterns')"</verify>
  <done>Action + role patterns added, total pattern count increased</done>
</task>

<task type="auto">
  <name>Task 3: Add action context test cases</name>
  <files>test_presidio.py</files>
  <action>
Add test cases to TEST_CASES list after the Phase 19-02 tests:

```python
# === PROVIDER ACTION CONTEXT PATTERNS (Phase 19-03) ===
{
    "name": "Provider - paged Dr",
    "input": "Paged Dr. Martinez at 3am for fever.",
    "must_redact": ["Martinez"],
    "must_preserve": ["Paged", "Dr.", "3am", "fever"],
},
{
    "name": "Provider - spoke with",
    "input": "Spoke with Dr Chen about discharge.",
    "must_redact": ["Chen"],
    "must_preserve": ["Spoke", "Dr", "discharge"],
},
{
    "name": "Provider - by Dr passive",
    "input": "Labs ordered by Dr. Williams earlier.",
    "must_redact": ["Williams"],
    "must_preserve": ["Labs", "ordered", "by", "Dr."],
},
```
  </action>
  <verify>python test_presidio.py 2>&1 | grep -E "(PASS|FAIL|paged|spoke|by Dr)"</verify>
  <done>Action context tests pass, no regressions</done>
</task>

</tasks>

<verification>
1. Run test harness: `python test_presidio.py` - all tests pass
2. Verify total pattern count: 50+ patterns across all categories
3. Manual: "paged Dr. Smith" -> "paged Dr. [NAME]"
4. Manual: "spoke with Dr Chen" -> "spoke with Dr [NAME]"
5. Negative: "paged the attending" without name -> no redaction
</verification>

<success_criteria>
- [ ] 15+ action + title patterns (paged, called, with, spoke with, discussed with, by)
- [ ] 4+ action + role patterns (paged the attending, etc.)
- [ ] 3 new test cases passing
- [ ] No regressions on existing tests
- [ ] Total provider patterns: ~50+
</success_criteria>

<output>
After completion, create `.planning/phases/19-provider-name-detection/19-03-SUMMARY.md`
</output>
