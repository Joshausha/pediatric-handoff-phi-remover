---
phase: 05-validation-compliance
plan: 04
type: execute
wave: 3
depends_on: ["05-03"]
files_modified:
  - .planning/phases/05-validation-compliance/EXPERT_REVIEW.md
  - .planning/phases/05-validation-compliance/expert_review_sample.json
autonomous: false
user_setup: []

must_haves:
  truths:
    - "A random sample of de-identified outputs has been manually reviewed by a clinical expert"
    - "Any missed PHI found during expert review is documented"
    - "Expert sign-off confirms system is safe for personal clinical use"
  artifacts:
    - path: ".planning/phases/05-validation-compliance/EXPERT_REVIEW.md"
      provides: "Expert review documentation with findings"
      contains: "Expert Sign-off"
    - path: ".planning/phases/05-validation-compliance/expert_review_sample.json"
      provides: "Random sample of outputs reviewed by expert"
      contains: "reviewed_at"
  key_links:
    - from: ".planning/phases/05-validation-compliance/EXPERT_REVIEW.md"
      to: ".planning/phases/05-validation-compliance/VALIDATION_REPORT.md"
      via: "Cross-reference to automated validation"
      pattern: "VALIDATION_REPORT"
---

<objective>
Expert review of random sample for VALD-03 compliance

Purpose: HIPAA Expert Determination requires human expert review, not just automated metrics. For this personal QI project (no IRB, no research team), the USER (Josh, pediatric resident and system developer) serves as the clinical expert reviewer. This is appropriate because:
1. Personal use tool - Josh is both developer and end user
2. Clinical domain expertise - PGY-3 pediatric resident understands PHI in clinical context
3. No external deployment - validation is for personal confidence, not regulatory approval

Output: Expert review documentation with random sample analysis, findings, and sign-off.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-validation-compliance/05-03-SUMMARY.md
@.planning/phases/05-validation-compliance/VALIDATION_REPORT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Generate random sample for expert review</name>
  <files>
    .planning/phases/05-validation-compliance/expert_review_sample.json
  </files>
  <action>
Create a script that:
1. Loads synthetic_handoffs.json
2. Runs Presidio de-identification on each handoff
3. Selects 10 random handoffs (stratified by error type if possible)
4. Exports both original text and de-identified output for manual review

Create .planning/phases/05-validation-compliance/expert_review_sample.json with structure:
```json
{
  "sample_info": {
    "generated_at": "[TIMESTAMP]",
    "sample_size": 10,
    "selection_method": "random_stratified",
    "seed": 42
  },
  "samples": [
    {
      "id": 1,
      "original_text": "[SYNTHETIC HANDOFF TEXT]",
      "deidentified_text": "[OUTPUT AFTER PRESIDIO]",
      "expected_phi": [
        {"entity_type": "PERSON", "text": "John Smith", "start": 8, "end": 18}
      ],
      "detected_phi": [
        {"entity_type": "PERSON", "text": "John Smith", "start": 8, "end": 18, "score": 0.95}
      ],
      "expert_review": {
        "reviewed_at": null,
        "missed_phi": [],
        "false_redactions": [],
        "notes": ""
      }
    }
  ]
}
```

Use this inline script:
```python
import json
import random
import sys
from pathlib import Path
from datetime import datetime

sys.path.insert(0, str(Path(__file__).parent.parent.parent))

from tests.generate_test_data import load_dataset
from app.deidentification import deidentify_text

# Load dataset
dataset = load_dataset(Path("tests/synthetic_handoffs.json"))

# Select random sample
random.seed(42)
sample_indices = random.sample(range(len(dataset)), min(10, len(dataset)))
samples = []

for idx in sample_indices:
    handoff = dataset[idx]
    original = handoff.text
    deidentified = deidentify_text(original)

    # Get detected PHI (run Presidio analysis)
    from app.deidentification import create_analyzer, create_anonymizer
    analyzer = create_analyzer()
    results = analyzer.analyze(text=original, language="en")

    detected = [
        {
            "entity_type": r.entity_type,
            "text": original[r.start:r.end],
            "start": r.start,
            "end": r.end,
            "score": r.score
        }
        for r in results
    ]

    expected = [
        {
            "entity_type": span.entity_type,
            "text": span.text,
            "start": span.start,
            "end": span.end
        }
        for span in handoff.phi_spans
    ]

    samples.append({
        "id": idx,
        "original_text": original,
        "deidentified_text": deidentified,
        "expected_phi": expected,
        "detected_phi": detected,
        "expert_review": {
            "reviewed_at": None,
            "missed_phi": [],
            "false_redactions": [],
            "notes": ""
        }
    })

output = {
    "sample_info": {
        "generated_at": datetime.now().isoformat(),
        "sample_size": len(samples),
        "selection_method": "random_stratified",
        "seed": 42
    },
    "samples": samples
}

output_path = Path(".planning/phases/05-validation-compliance/expert_review_sample.json")
output_path.parent.mkdir(parents=True, exist_ok=True)
output_path.write_text(json.dumps(output, indent=2))
print(f"Generated expert review sample with {len(samples)} handoffs")
```
  </action>
  <verify>
```bash
cd "/Users/joshpankin/My Drive/10-19 Projects/12 Development & AI Projects/12.09 Pediatric_Handoff_PHI_Remover"
cat .planning/phases/05-validation-compliance/expert_review_sample.json | python -c "import json,sys; d=json.load(sys.stdin); print(f'Sample size: {d[\"sample_info\"][\"sample_size\"]} handoffs')"
```
  </verify>
  <done>
- expert_review_sample.json exists with 10 handoff samples
- Each sample has original_text, deidentified_text, expected_phi, detected_phi
- expert_review section initialized for manual annotation
  </done>
</task>

<task type="auto">
  <name>Task 2: Create expert review template</name>
  <files>
    .planning/phases/05-validation-compliance/EXPERT_REVIEW.md
  </files>
  <action>
Create .planning/phases/05-validation-compliance/EXPERT_REVIEW.md:

```markdown
# Expert Review of PHI De-identification

**Reviewer:** Josh Pankin, MD (PGY-3 Pediatric Resident)
**Date:** [TO BE FILLED]
**Review Type:** Manual inspection of random sample

## Review Protocol

### Qualification
The reviewer is the developer and sole intended user of this personal clinical tool. As a PGY-3 pediatric resident with daily exposure to patient handoffs, the reviewer has domain expertise in:
- Pediatric clinical documentation patterns
- Common PHI types in handoff communications
- Clinical context for identifying protected information

### Methodology
1. Reviewed 10 randomly selected synthetic handoffs
2. For each handoff, examined:
   - Original text (simulated PHI)
   - De-identified output (PHI redacted)
   - Expected PHI vs detected PHI comparison
3. Flagged any:
   - **Missed PHI** (false negatives) - PHI visible in output that should have been redacted
   - **False redactions** (false positives) - Non-PHI inappropriately redacted
   - **Partial redactions** - PHI only partially redacted

## Sample Review Results

| Sample ID | Missed PHI | False Redactions | Notes |
|-----------|------------|------------------|-------|
| 1 | [TBD] | [TBD] | [TBD] |
| 2 | [TBD] | [TBD] | [TBD] |
| 3 | [TBD] | [TBD] | [TBD] |
| 4 | [TBD] | [TBD] | [TBD] |
| 5 | [TBD] | [TBD] | [TBD] |
| 6 | [TBD] | [TBD] | [TBD] |
| 7 | [TBD] | [TBD] | [TBD] |
| 8 | [TBD] | [TBD] | [TBD] |
| 9 | [TBD] | [TBD] | [TBD] |
| 10 | [TBD] | [TBD] | [TBD] |

## Findings Summary

### Missed PHI (Critical)
[TO BE FILLED - List any PHI that was not properly redacted]

### False Redactions (Non-critical)
[TO BE FILLED - List any non-PHI that was unnecessarily redacted]

### Patterns Observed
[TO BE FILLED - Any systematic issues noticed]

## Expert Sign-off

### Automated Validation Reference
See [VALIDATION_REPORT.md](./VALIDATION_REPORT.md) for statistical metrics:
- Recall: [FROM REPORT]
- Precision: [FROM REPORT]
- 95% CI: [FROM REPORT]

### Expert Determination

Based on manual review of 10 randomly selected outputs:

- [ ] **APPROVED for personal use**: No critical PHI leakage observed, false negative rate acceptable for personal clinical workflow tool
- [ ] **REQUIRES IMPROVEMENT**: Critical issues found (document below)

### Issues Requiring Remediation
[TO BE FILLED if not approved]

### Signature

```
Reviewed by: ________________________
Date: ________________________
```

---

*This expert review satisfies VALD-03 (expert review of random sample) for this personal QI project. For deployment beyond personal use, formal IRB review and external expert panel would be required.*
```
  </action>
  <verify>
```bash
cd "/Users/joshpankin/My Drive/10-19 Projects/12 Development & AI Projects/12.09 Pediatric_Handoff_PHI_Remover"
head -50 .planning/phases/05-validation-compliance/EXPERT_REVIEW.md
```
  </verify>
  <done>
- EXPERT_REVIEW.md template exists with reviewer qualification section
- Sample review table initialized for 10 samples
- Expert sign-off section with approval checkbox
- Reference to VALIDATION_REPORT.md for automated metrics
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Expert review infrastructure for VALD-03 compliance:
1. Random sample of 10 handoffs generated (expert_review_sample.json)
2. Review template created (EXPERT_REVIEW.md)
3. Ready for manual expert review by Josh
  </what-built>
  <how-to-verify>
**This checkpoint requires YOU (Josh) to perform the expert review:**

1. Open expert_review_sample.json and review each of the 10 samples
2. For each sample, compare `original_text` with `deidentified_text`
3. Check if any PHI is still visible in the deidentified output
4. Update EXPERT_REVIEW.md with your findings:
   - Fill in the Sample Review Results table
   - Document any missed PHI in "Findings Summary"
   - Check the approval box if acceptable
   - Sign and date

Commands to view samples:
```bash
cd "/Users/joshpankin/My Drive/10-19 Projects/12 Development & AI Projects/12.09 Pediatric_Handoff_PHI_Remover"

# View sample 1
cat .planning/phases/05-validation-compliance/expert_review_sample.json | python -c "
import json, sys
d = json.load(sys.stdin)
s = d['samples'][0]
print('=== ORIGINAL ===')
print(s['original_text'][:500])
print()
print('=== DE-IDENTIFIED ===')
print(s['deidentified_text'][:500])
"

# View all samples side-by-side (open in editor recommended)
code .planning/phases/05-validation-compliance/expert_review_sample.json
```

After reviewing all 10 samples, edit EXPERT_REVIEW.md with your findings.
  </how-to-verify>
  <resume-signal>Type "approved" after completing expert review and signing EXPERT_REVIEW.md, or describe issues found</resume-signal>
</task>

</tasks>

<verification>
1. expert_review_sample.json exists with 10 samples
2. EXPERT_REVIEW.md template exists
3. After human review, EXPERT_REVIEW.md is filled in with findings
4. Expert sign-off checkbox marked

```bash
cd "/Users/joshpankin/My Drive/10-19 Projects/12 Development & AI Projects/12.09 Pediatric_Handoff_PHI_Remover"

# Verify sample generated
cat .planning/phases/05-validation-compliance/expert_review_sample.json | python -c "import json,sys; d=json.load(sys.stdin); print(f'Samples: {len(d[\"samples\"])}')"

# Verify template exists
grep "Expert Sign-off" .planning/phases/05-validation-compliance/EXPERT_REVIEW.md

# After human review, verify approval
grep -E "\[x\] \*\*APPROVED" .planning/phases/05-validation-compliance/EXPERT_REVIEW.md || echo "Awaiting expert approval"
```
</verification>

<success_criteria>
- [ ] expert_review_sample.json contains 10 random handoff samples with original and de-identified text
- [ ] EXPERT_REVIEW.md template exists with review protocol and sign-off section
- [ ] Human expert (Josh) reviews all 10 samples
- [ ] EXPERT_REVIEW.md updated with findings (missed PHI, false redactions)
- [ ] Expert sign-off checkbox marked (APPROVED or REQUIRES IMPROVEMENT)
- [ ] If issues found, documented for Phase 4 remediation
</success_criteria>

<output>
After completion, create `.planning/phases/05-validation-compliance/05-04-SUMMARY.md`
</output>
