---
phase: 20-phone-pager-patterns
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/deidentification.py
  - tests/test_deidentification.py
autonomous: true

must_haves:
  truths:
    - "Phone numbers with extensions (e.g., 264-517-0805x310) are detected as PHONE_NUMBER"
    - "Standard dash-separated phones (e.g., 576-959-1803) are detected as PHONE_NUMBER"
    - "PHONE_NUMBER recall improves from 75.7% to >=90% on validation set"
    - "No false positives on clinical numbers (vitals, doses, weights)"
    - "No regression on existing phone detection (international formats, parentheses, dots)"
  artifacts:
    - path: "app/deidentification.py"
      provides: "Custom PhoneRecognizer with leniency=0"
      contains: "registry.remove_recognizer"
    - path: "tests/test_deidentification.py"
      provides: "Regression tests for phone edge cases"
      contains: "test_phone_extension"
  key_links:
    - from: "app/deidentification.py"
      to: "presidio_analyzer.predefined_recognizers.PhoneRecognizer"
      via: "import and registry replacement"
      pattern: "PhoneRecognizer\\(.*leniency=0"
---

<objective>
Override Presidio's PhoneRecognizer with lenient matching to fix all phone number false negatives.

Purpose: The default Presidio PhoneRecognizer uses leniency=1, which is too strict for clinical handoff transcripts. By switching to leniency=0 (most lenient), we catch all valid phone formats including extensions and standard dash-separated numbers that are currently missed.

Output: PHONE_NUMBER recall >=90% (up from 75.7%), zero new false positives on clinical numbers.
</objective>

<execution_context>
@/Users/joshpankin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joshpankin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-phone-pager-patterns/20-RESEARCH.md
@app/deidentification.py
@app/config.py
@tests/test_deidentification.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Override PhoneRecognizer with leniency=0</name>
  <files>app/deidentification.py</files>
  <action>
Modify `_get_engines()` in `app/deidentification.py` to:

1. Add import at top of file:
   ```python
   from presidio_analyzer.predefined_recognizers import PhoneRecognizer
   ```

2. After `registry.load_predefined_recognizers(nlp_engine=nlp_engine)`, add:
   ```python
   # Override default PhoneRecognizer with lenient matching (Phase 20)
   # Default leniency=1 is too strict for clinical handoffs; leniency=0 catches
   # extensions (x310) and standard dash-separated formats that were missed.
   registry.remove_recognizer("PhoneRecognizer")
   custom_phone = PhoneRecognizer(
       supported_regions=("US",),
       leniency=0,  # Most lenient - catches all valid formats
   )
   registry.add_recognizer(custom_phone)
   logger.debug("Added custom PhoneRecognizer with leniency=0")
   ```

Key points:
- MUST remove default PhoneRecognizer before adding custom one (prevents duplicates)
- Keep supported_regions=("US",) for now (sufficient for hospital handoffs)
- Log the addition for debugging
  </action>
  <verify>
Run quick test:
```bash
cd "/Users/joshpankin/My Drive/10-19 Projects/12 Development & AI Projects/12.09 Pediatric_Handoff_PHI_Remover"
python -c "
from app.deidentification import deidentify_text
# Test a known false negative
result = deidentify_text('Contact dad at 264-517-0805x310 for updates')
print(result.clean_text)
assert '[PHONE]' in result.clean_text, 'Extension phone should be detected'
print('SUCCESS: Phone with extension detected')
"
```
  </verify>
  <done>
Phone numbers with extensions (264-517-0805x310) and standard dash-separated formats are now detected. The PhoneRecognizer override is in place with leniency=0.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add regression tests and validate recall</name>
  <files>tests/test_deidentification.py</files>
  <action>
Add regression tests for the 5 false negatives identified in research:

1. Add to `PHONE_NUMBER_EDGE_CASES` list (around line 1261):
   ```python
   # Phase 20: Leniency=0 fixes for false negatives
   ("Contact dad at 264-517-0805x310 for updates", "264-517-0805x310", "domestic_ext_x"),
   ("Call Mark Warner at 576-959-1803 for pickup", "576-959-1803", "standard_dash"),
   ("Call Dr. Scott at 291-938-0003", "291-938-0003", "standard_dash_2"),
   ("Reach Dr. Huang at 560-913-6730x371", "560-913-6730x371", "domestic_ext_x_2"),
   ("Dr. Carson at 394-678-7300x2447", "394-678-7300x2447", "domestic_ext_long"),
   ```

2. Run the full phone number test suite to verify:
   - All 5 new edge cases pass
   - No regressions on existing phone tests
   - PHONE_NUMBER_EDGE_CASES tests all green

3. Run validation to measure recall improvement:
   ```bash
   python tests/evaluate_presidio.py --quick
   ```
   Check that PHONE_NUMBER recall is >=90% (target).

Negative test - verify NO false positives:
- "Patient weight 12345 grams" - should NOT flag as phone
- "Room 12345" - should NOT flag as phone (ROOM entity, not phone)
- "Heart rate 120/80" - should NOT flag as phone
  </action>
  <verify>
```bash
cd "/Users/joshpankin/My Drive/10-19 Projects/12 Development & AI Projects/12.09 Pediatric_Handoff_PHI_Remover"

# Run phone-specific tests
pytest tests/test_deidentification.py -v -k "phone" --tb=short

# Run full test suite to check for regressions
pytest tests/ -v --tb=short -x

# Run validation for recall measurement
python tests/evaluate_presidio.py --quick 2>/dev/null | grep -E "(PHONE|Recall|recall)"
```
  </verify>
  <done>
All phone edge case tests pass. PHONE_NUMBER recall >=90% verified on validation set. No false positives on clinical numbers. Full test suite passes with no regressions.
  </done>
</task>

</tasks>

<verification>
1. All phone edge cases detected:
   - `264-517-0805x310` (extension format)
   - `576-959-1803` (standard dash)
   - `291-938-0003` (standard dash)
   - `560-913-6730x371` (extension format)
   - `394-678-7300x2447` (long extension)

2. No false positives:
   - Clinical numbers (vitals, weights, doses) NOT flagged
   - Room numbers NOT flagged as phones

3. Recall target met:
   - PHONE_NUMBER recall >=90% on validation set
   - No regression on other entity types

4. Full test suite green:
   - `pytest tests/ -v` all pass
   - CI-equivalent tests pass
</verification>

<success_criteria>
- [ ] PhoneRecognizer override implemented with leniency=0
- [ ] All 5 known false negatives now detected
- [ ] Regression tests added for phone edge cases
- [ ] PHONE_NUMBER recall >=90% on validation set
- [ ] No false positives on clinical numbers
- [ ] Full test suite passes (no regressions)
</success_criteria>

<output>
After completion, create `.planning/phases/20-phone-pager-patterns/20-01-SUMMARY.md`
</output>
