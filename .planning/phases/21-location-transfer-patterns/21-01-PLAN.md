---
phase: 21-location-transfer-patterns
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/recognizers/medical.py
  - test_presidio.py
autonomous: true

must_haves:
  truths:
    - "Transfer phrases like 'transferred from Memorial Hospital' detect hospital name as LOCATION"
    - "Admission phrases like 'admitted from home' detect location as LOCATION"
    - "Movement phrases like 'sent from urgent care' detect location as LOCATION"
    - "Context words (transferred, admitted, sent) are preserved, only location is redacted"
  artifacts:
    - path: "app/recognizers/medical.py"
      provides: "Transfer context LOCATION patterns"
      contains: "transferred_from"
    - path: "test_presidio.py"
      provides: "Transfer context LOCATION test cases"
      contains: "Location - transferred from"
  key_links:
    - from: "app/recognizers/medical.py"
      to: "app/deidentification.py"
      via: "get_medical_recognizers() returns LOCATION recognizer"
      pattern: "LOCATION"
---

<objective>
Add transfer context patterns for LOCATION detection using lookbehind patterns.

Purpose: Transfer contexts ("transferred from", "admitted from", "sent from") account for 50% of LOCATION entities in the dataset. These patterns have high confidence due to explicit transfer language.

Output: LOCATION recognizer with transfer context patterns, test cases validating detection.
</objective>

<execution_context>
@/Users/joshpankin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joshpankin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/21-location-transfer-patterns/21-RESEARCH.md
@app/recognizers/medical.py
@app/config.py
@test_presidio.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add transfer context LOCATION patterns to medical.py</name>
  <files>app/recognizers/medical.py</files>
  <action>
Add a new LOCATION recognizer section after the Phone Number Recognizer section in get_medical_recognizers().

Create transfer context patterns using lookbehind (proven approach from ROOM patterns):

```python
# =========================================================================
# Location Recognizer (Transfer/Medical Context)
# =========================================================================
# Pattern-based LOCATION detection for clinical handoff contexts.
# Supplements spaCy NER baseline (20% recall) with context-specific patterns.
# Target: â‰¥60% recall with lookbehind patterns preserving context words.

location_patterns = [
    # === TRANSFER CONTEXT PATTERNS (50% of dataset) ===
    # High confidence - explicit transfer language indicates location follows

    # "transferred from Memorial Hospital" -> matches "Memorial Hospital"
    # Fixed-width lookbehind: "transferred from " = 17 chars
    Pattern(
        name="transferred_from",
        regex=r"(?i)(?<=transferred from )[A-Z][A-Za-z'\s]+(?:Hospital|Medical Center|Clinic|Home|Urgent Care)?",
        score=0.80
    ),
    # "admitted from Springfield" -> matches "Springfield"
    # Fixed-width lookbehind: "admitted from " = 14 chars
    Pattern(
        name="admitted_from",
        regex=r"(?i)(?<=admitted from )[A-Z][A-Za-z'\s]+(?:Hospital|Clinic|Home)?",
        score=0.80
    ),
    # "sent from Children's Hospital" -> matches "Children's Hospital"
    # Fixed-width lookbehind: "sent from " = 10 chars
    Pattern(
        name="sent_from",
        regex=r"(?i)(?<=sent from )[A-Z][A-Za-z'\s]+(?:Hospital|Medical Center|Clinic)?",
        score=0.75
    ),
    # "came from Mass General" -> matches "Mass General"
    # Fixed-width lookbehind: "came from " = 10 chars
    Pattern(
        name="came_from",
        regex=r"(?i)(?<=came from )[A-Z][A-Za-z'\s]+(?:Hospital|Medical Center)?",
        score=0.75
    ),
    # "en route from Boston" -> matches "Boston"
    # Fixed-width lookbehind: "en route from " = 14 chars
    Pattern(
        name="en_route_from",
        regex=r"(?i)(?<=en route from )[A-Z][A-Za-z'\s]+",
        score=0.75
    ),
]

location_recognizer = PatternRecognizer(
    supported_entity="LOCATION",
    name="Location Recognizer",
    patterns=location_patterns,
    context=[
        # Transfer context words
        "transferred", "admitted", "sent", "came", "en route",
        # Medical facility keywords
        "hospital", "clinic", "medical center", "urgent care",
        # Residential context
        "home", "lives", "discharge"
    ]
)
recognizers.append(location_recognizer)
```

Key implementation notes:
- Use fixed-width lookbehind (Python regex requirement)
- Score 0.80 for transfer verbs (high confidence)
- Score 0.75 for less common verbs
- Allow optional facility suffixes to capture both "Memorial Hospital" and "Springfield"
- Include apostrophes in character class for "Children's Hospital"

Avoid:
- Variable-width lookbehind (Python regex will reject)
- Overly broad patterns without context (causes false positives)
- Matching hospital unit names (PICU, NICU) - already on deny list
  </action>
  <verify>
Run `python -c "from app.recognizers.medical import get_medical_recognizers; recs = get_medical_recognizers(); print([r.name for r in recs])"` - should list "Location Recognizer"

Run `python -c "import re; re.compile(r'(?i)(?<=transferred from )[A-Z][A-Za-z\\'\\s]+(?:Hospital|Medical Center|Clinic|Home|Urgent Care)?')"` - should compile without error
  </verify>
  <done>
LOCATION recognizer exists with 5 transfer context patterns, all patterns compile successfully
  </done>
</task>

<task type="auto">
  <name>Task 2: Add transfer context LOCATION test cases to test_presidio.py</name>
  <files>test_presidio.py</files>
  <action>
Add test cases after the existing "=== LOCATIONS ===" section in TEST_CASES list:

```python
    # === LOCATION - TRANSFER CONTEXT (Phase 21-01) ===
    {
        "name": "Location - transferred from hospital",
        "input": "Patient was transferred from Memorial Hospital yesterday.",
        "must_redact": ["Memorial Hospital"],
        "must_preserve": ["Patient", "transferred", "yesterday"],
    },
    {
        "name": "Location - admitted from home",
        "input": "Child admitted from home with respiratory distress.",
        "must_redact": ["home"],
        "must_preserve": ["Child", "admitted", "respiratory distress"],
    },
    {
        "name": "Location - sent from clinic",
        "input": "Sent from Springfield Pediatric Clinic for evaluation.",
        "must_redact": ["Springfield Pediatric Clinic"],
        "must_preserve": ["Sent", "evaluation"],
    },
    {
        "name": "Location - en route from city",
        "input": "Family en route from Boston, ETA 30 minutes.",
        "must_redact": ["Boston"],
        "must_preserve": ["Family", "en route", "ETA", "30 minutes"],
    },
    {
        "name": "Location - came from hospital",
        "input": "Came from Children's Medical Center via ambulance.",
        "must_redact": ["Children's Medical Center"],
        "must_preserve": ["Came", "ambulance"],
    },
```

Key test case design:
- Cover all 5 transfer patterns (transferred, admitted, sent, came, en route)
- Test hospital names with spaces ("Memorial Hospital")
- Test possessive forms ("Children's Medical Center")
- Test cities without facility suffix ("Boston")
- Verify context words are preserved (transferred, admitted, sent)
  </action>
  <verify>
Run `python test_presidio.py` - all tests should pass including new transfer context cases
  </verify>
  <done>
5 new LOCATION transfer context test cases pass, existing tests continue to pass
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify integration and commit</name>
  <files>app/recognizers/medical.py, test_presidio.py</files>
  <action>
1. Run full test suite to confirm no regressions:
   `pytest tests/ -v --tb=short`

2. Run test_presidio.py standalone:
   `python test_presidio.py`

3. Verify LOCATION recognizer is loaded by deidentification pipeline:
   ```python
   from app.deidentification import get_analyzer
   analyzer = get_analyzer()
   recognizers = [r.name for r in analyzer.registry.get_recognizers(language="en")]
   print("Location Recognizer" in recognizers)  # Should be True
   ```

4. Commit changes with atomic commit:
   ```bash
   git add app/recognizers/medical.py test_presidio.py
   git commit -m "feat(21-01): add transfer context LOCATION patterns

   - Add LOCATION recognizer to medical.py with 5 transfer patterns
   - transferred from, admitted from, sent from, came from, en route from
   - Use fixed-width lookbehind (Python regex requirement)
   - Score 0.80 for high-confidence transfer verbs
   - Add 5 test cases validating transfer context detection

   Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>"
   ```
  </action>
  <verify>
Git log shows commit with correct message and file changes

All tests pass: pytest reports 0 failures

test_presidio.py reports all cases pass including new LOCATION transfer context tests
  </verify>
  <done>
Transfer context LOCATION patterns committed, all tests pass, no regressions
  </done>
</task>

</tasks>

<verification>
1. `python test_presidio.py` - all tests pass (including 5 new transfer context cases)
2. `pytest tests/ -v --tb=short` - no regressions
3. LOCATION recognizer appears in analyzer registry
4. Transfer patterns correctly detect hospital names and cities
</verification>

<success_criteria>
- [ ] LOCATION recognizer exists in medical.py with 5 transfer context patterns
- [ ] All transfer patterns use fixed-width lookbehind (Python regex compliant)
- [ ] 5 new test cases for transfer context detection pass
- [ ] No regressions on existing tests (200+ tests)
- [ ] Context words (transferred, admitted, sent) are preserved
- [ ] Hospital names with spaces/apostrophes detected correctly
</success_criteria>

<output>
After completion, create `.planning/phases/21-location-transfer-patterns/21-01-SUMMARY.md`
</output>
