---
phase: 21-location-transfer-patterns
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - app/recognizers/medical.py
  - test_presidio.py
autonomous: true

must_haves:
  truths:
    - "Hospital names with facility keywords detected ('Memorial Hospital', 'Children's Medical Center')"
    - "Clinic names detected ('Springfield Pediatrics', 'Oak Clinic')"
    - "Residential addresses detected ('lives at 123 Main Street', 'discharge to home')"
    - "PCP office context detected ('PCP at Springfield Pediatrics')"
    - "Medical abbreviations (PICU, NICU, OR, ER) NOT flagged as locations"
  artifacts:
    - path: "app/recognizers/medical.py"
      provides: "Facility name and residential address LOCATION patterns"
      contains: "hospital_name"
    - path: "test_presidio.py"
      provides: "Hospital, clinic, address test cases"
      contains: "Location - hospital name"
  key_links:
    - from: "app/recognizers/medical.py"
      to: "app/config.py"
      via: "deny_list_location filters medical abbreviations"
      pattern: "deny_list_location"
---

<objective>
Add hospital/clinic name patterns and residential address patterns for LOCATION detection.

Purpose: Facility names (19% of dataset) and residential addresses (16% of dataset) require explicit patterns beyond spaCy NER. Combined with transfer context patterns from Plan 01, these patterns target >=60% LOCATION recall.

Output: Extended LOCATION recognizer with facility and address patterns, test cases validating detection.
</objective>

<execution_context>
@/Users/joshpankin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joshpankin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/21-location-transfer-patterns/21-RESEARCH.md
@app/recognizers/medical.py
@app/config.py
@test_presidio.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add hospital/clinic name patterns to medical.py</name>
  <files>app/recognizers/medical.py</files>
  <action>
Extend the LOCATION recognizer in medical.py (created in 21-01) by adding facility name patterns.

Add these patterns to the existing location_patterns list:

```python
    # === FACILITY NAME PATTERNS (19% of dataset) ===
    # Detect medical facilities by explicit keywords (Hospital, Clinic, Medical Center)

    # "[Name] Hospital" -> matches entire phrase
    # Examples: "Memorial Hospital", "Children's Hospital"
    Pattern(
        name="hospital_name",
        regex=r"\b[A-Z][A-Za-z'\s]+\s+Hospital\b",
        score=0.70
    ),
    # "[Name] Medical Center" -> matches entire phrase
    # Examples: "Boston Medical Center", "Children's Medical Center"
    Pattern(
        name="medical_center_name",
        regex=r"\b[A-Z][A-Za-z'\s]+\s+Medical Center\b",
        score=0.70
    ),
    # "[Name] Clinic" -> matches entire phrase
    # Examples: "Springfield Clinic", "Oak Street Clinic"
    Pattern(
        name="clinic_name",
        regex=r"\b[A-Z][A-Za-z'\s]+\s+Clinic\b",
        score=0.65
    ),
    # "[Name] Pediatrics" -> matches entire phrase
    # Examples: "Springfield Pediatrics", "Main Street Pediatrics"
    Pattern(
        name="pediatrics_office",
        regex=r"\b[A-Z][A-Za-z'\s]+\s+Pediatrics\b",
        score=0.65
    ),
    # "[Name] Health System" / "[Name] Health Center" -> matches entire phrase
    Pattern(
        name="health_system",
        regex=r"\b[A-Z][A-Za-z'\s]+\s+Health\s+(?:System|Center)\b",
        score=0.65
    ),
    # "Urgent Care" with name prefix -> matches entire phrase
    Pattern(
        name="urgent_care",
        regex=r"\b[A-Z][A-Za-z'\s]+\s+Urgent Care\b",
        score=0.65
    ),
```

Key implementation notes:
- Score 0.70 for Hospital/Medical Center (high confidence keywords)
- Score 0.65 for Clinic/Pediatrics (slightly lower - more ambiguous)
- Allow apostrophes for "Children's" and spaces for "Medical Center"
- Word boundary prevents partial matches

Avoid:
- Matching standalone "Hospital" without name prefix
- Matching medical abbreviations (handled by deny list)
  </action>
  <verify>
Run `python -c "import re; re.compile(r'\\b[A-Z][A-Za-z\\'\\s]+\\s+Hospital\\b')"` - should compile without error

Run test_presidio.py - existing tests should pass
  </verify>
  <done>
6 facility name patterns added to LOCATION recognizer, all patterns compile successfully
  </done>
</task>

<task type="auto">
  <name>Task 2: Add residential address patterns to medical.py</name>
  <files>app/recognizers/medical.py</files>
  <action>
Continue extending the LOCATION recognizer by adding residential address patterns:

```python
    # === RESIDENTIAL ADDRESS PATTERNS (16% of dataset) ===
    # Detect addresses in residential context (lives at, discharge to)

    # "lives at 123 Main Street" -> matches "123 Main Street"
    # Fixed-width lookbehind: "lives at " = 9 chars
    # Covers common street type suffixes
    Pattern(
        name="lives_at_address",
        regex=r"(?i)(?<=lives at )\d+\s+[A-Za-z'\s]+(?:Street|Drive|Avenue|Road|Lane|Way|Court|Place|Circle|Boulevard|Heights|Manor|Hill)\b(?:\s+(?:Apt|Suite|Unit)\.\s*\w+)?",
        score=0.75
    ),
    # "lives in Boston" -> matches "Boston"
    # Fixed-width lookbehind: "lives in " = 9 chars
    Pattern(
        name="lives_in_city",
        regex=r"(?i)(?<=lives in )[A-Z][A-Za-z'\s]+",
        score=0.70
    ),
    # "discharge to home" or "discharge to 456 Oak Lane" -> matches location
    # Fixed-width lookbehind: "discharge to " = 13 chars
    Pattern(
        name="discharge_to",
        regex=r"(?i)(?<=discharge to )[A-Za-z0-9'\s]+(?:Street|Drive|Avenue|Road|Lane|Way|Court|Home)?\b",
        score=0.70
    ),
    # "from [City]" with common city suffixes (ville, ton, port, etc.)
    # Helps detect city names that spaCy might miss
    # Fixed-width lookbehind: "from " = 5 chars
    Pattern(
        name="from_city",
        regex=r"(?i)(?<=from )[A-Z][a-z]+(?:ville|ton|burg|port|haven|chester|wood|field|land)\b",
        score=0.65
    ),
```

Key implementation notes:
- Score 0.75 for "lives at" (explicit address context)
- Score 0.70 for "lives in" / "discharge to" (strong context)
- Score 0.65 for "from [City]" with suffix pattern (lower confidence)
- Include diverse street suffixes from dataset analysis
- Handle apartment/suite numbers with optional suffix

Also add PCP/clinic context pattern:

```python
    # === PCP/CLINIC CONTEXT PATTERNS ===
    # "PCP is Dr. Smith at Springfield Pediatrics" -> matches "Springfield Pediatrics"
    # Fixed-width lookbehind: "at " = 3 chars (short, need facility keyword)
    Pattern(
        name="pcp_at_facility",
        regex=r"(?i)(?<=\bat )[A-Z][A-Za-z'\s]+(?:Pediatrics|Clinic|Associates|Medical)\b",
        score=0.60  # Lower score - indirect context
    ),
```

Update context list to include residential terms:
```python
context=[
    # Transfer context words (from 21-01)
    "transferred", "admitted", "sent", "came", "en route",
    # Medical facility keywords
    "hospital", "clinic", "medical center", "urgent care", "pediatrics",
    # Residential context
    "home", "lives", "discharge", "address", "family",
    # PCP context
    "pcp", "doctor", "office"
]
```
  </action>
  <verify>
Run `python -c "import re; re.compile(r'(?i)(?<=lives at )\\d+\\s+[A-Za-z\\'\\s]+(?:Street|Drive|Avenue|Road|Lane|Way|Court|Place|Circle|Boulevard|Heights|Manor|Hill)\\b')"` - should compile without error

Run test_presidio.py - all tests should pass
  </verify>
  <done>
5 residential address patterns + 1 PCP context pattern added, patterns compile, tests pass
  </done>
</task>

<task type="auto">
  <name>Task 3: Add facility and address test cases to test_presidio.py</name>
  <files>test_presidio.py</files>
  <action>
Add test cases after the transfer context test cases added in 21-01:

```python
    # === LOCATION - FACILITY NAMES (Phase 21-02) ===
    {
        "name": "Location - hospital name",
        "input": "Born at Children's Hospital, now stable.",
        "must_redact": ["Children's Hospital"],
        "must_preserve": ["Born", "stable"],
    },
    {
        "name": "Location - medical center",
        "input": "Previously seen at Boston Medical Center.",
        "must_redact": ["Boston Medical Center"],
        "must_preserve": ["Previously", "seen"],
    },
    {
        "name": "Location - clinic name",
        "input": "Follow-up scheduled at Oak Street Clinic.",
        "must_redact": ["Oak Street Clinic"],
        "must_preserve": ["Follow-up", "scheduled"],
    },
    {
        "name": "Location - pediatrics office",
        "input": "PCP is Dr. Jones at Springfield Pediatrics.",
        "must_redact": ["Springfield Pediatrics"],
        "must_preserve": ["PCP", "Dr."],
    },

    # === LOCATION - RESIDENTIAL ADDRESSES (Phase 21-02) ===
    {
        "name": "Location - lives at address",
        "input": "Family lives at 425 Oak Street, third floor.",
        "must_redact": ["425 Oak Street"],
        "must_preserve": ["Family", "lives", "third floor"],
    },
    {
        "name": "Location - lives in city",
        "input": "Patient lives in Brookfield with grandparents.",
        "must_redact": ["Brookfield"],
        "must_preserve": ["Patient", "lives", "grandparents"],
    },
    {
        "name": "Location - discharge to home",
        "input": "Discharge to home planned for tomorrow.",
        "must_redact": ["home"],
        "must_preserve": ["Discharge", "planned", "tomorrow"],
    },

    # === LOCATION - MUST PRESERVE (no false positives) ===
    {
        "name": "Location - preserve PICU",
        "input": "Transferred to PICU for closer monitoring.",
        "must_redact": [],
        "must_preserve": ["PICU", "monitoring"],
    },
    {
        "name": "Location - preserve OR",
        "input": "Going to OR for appendectomy.",
        "must_redact": [],
        "must_preserve": ["OR", "appendectomy"],
    },
```

Key test case design:
- Test facility keywords (Hospital, Medical Center, Clinic, Pediatrics)
- Test possessive forms (Children's Hospital)
- Test residential addresses with street types
- Test city names in "lives in" context
- Verify medical abbreviations (PICU, OR) are NOT flagged
  </action>
  <verify>
Run `python test_presidio.py` - all tests pass including new facility and address cases

Run `python test_presidio.py 2>&1 | grep -E "(PASS|FAIL)"` - count pass/fail
  </verify>
  <done>
9 new LOCATION test cases pass (4 facility, 3 residential, 2 preserve), no regressions
  </done>
</task>

<task type="auto">
  <name>Task 4: Verify integration and commit</name>
  <files>app/recognizers/medical.py, test_presidio.py</files>
  <action>
1. Run full test suite to confirm no regressions:
   `pytest tests/ -v --tb=short`

2. Run test_presidio.py standalone:
   `python test_presidio.py`

3. Verify LOCATION patterns count:
   ```python
   from app.recognizers.medical import get_medical_recognizers
   for r in get_medical_recognizers():
       if r.name == "Location Recognizer":
           print(f"LOCATION patterns: {len(r.patterns)}")
   ```
   Expected: 17 patterns (5 transfer + 6 facility + 5 residential + 1 PCP)

4. Test that deny list still filters medical abbreviations:
   ```python
   from app.deidentification import analyze_text
   result = analyze_text("Patient in PICU bed 7.")
   print([r.entity_type for r in result])  # Should NOT include LOCATION
   ```

5. Commit changes with atomic commit:
   ```bash
   git add app/recognizers/medical.py test_presidio.py
   git commit -m "feat(21-02): add facility name and address LOCATION patterns

   - Add 6 facility name patterns (Hospital, Medical Center, Clinic, Pediatrics, Health System, Urgent Care)
   - Add 5 residential address patterns (lives at, lives in, discharge to, from city)
   - Add 1 PCP context pattern (at Pediatrics/Clinic)
   - LOCATION recognizer now has 17 patterns total
   - Add 9 test cases (facility names, addresses, medical abbreviation preservation)

   Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>"
   ```
  </action>
  <verify>
Git log shows commit with correct message

LOCATION recognizer has 17 patterns

All tests pass: pytest reports 0 failures, test_presidio.py reports all cases pass

Medical abbreviations (PICU, NICU, OR) are NOT flagged as LOCATION
  </verify>
  <done>
Facility and address LOCATION patterns committed, 17 total patterns, all tests pass, deny list verified
  </done>
</task>

</tasks>

<verification>
1. `python test_presidio.py` - all tests pass (including 9 new facility/address cases)
2. `pytest tests/ -v --tb=short` - no regressions
3. LOCATION recognizer has 17 patterns
4. Medical abbreviations (PICU, NICU, OR, ER) NOT flagged as LOCATION
5. Hospital names with apostrophes detected correctly
6. Street addresses with various suffixes detected correctly
</verification>

<success_criteria>
- [ ] 6 facility name patterns added (Hospital, Medical Center, Clinic, Pediatrics, Health System, Urgent Care)
- [ ] 5 residential address patterns added (lives at, lives in, discharge to, from city, discharge to)
- [ ] 1 PCP context pattern added
- [ ] 9 new test cases pass
- [ ] Medical abbreviations remain on deny list and are NOT flagged
- [ ] No regressions on existing tests
</success_criteria>

<output>
After completion, create `.planning/phases/21-location-transfer-patterns/21-02-SUMMARY.md`
</output>
