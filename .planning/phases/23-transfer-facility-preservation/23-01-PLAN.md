---
phase: 23-transfer-facility-preservation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/config.py
  - app/deidentification.py
  - tests/test_transfer_facility_mode.py
autonomous: true

must_haves:
  truths:
    - "Setting transfer_facility_mode='conservative' redacts all LOCATION entities"
    - "Setting transfer_facility_mode='clinical' preserves LOCATION entities (keep operator)"
    - "Default mode is conservative (HIPAA Safe Harbor compliance)"
    - "Invalid mode values fail fast with clear error on startup"
    - "Deny list filtering still applies in both modes"
  artifacts:
    - path: "app/config.py"
      provides: "transfer_facility_mode setting with validation"
      contains: "transfer_facility_mode"
    - path: "app/deidentification.py"
      provides: "Conditional LOCATION operator (keep vs replace)"
      contains: 'OperatorConfig("keep"'
    - path: "tests/test_transfer_facility_mode.py"
      provides: "Unit tests for mode switching behavior"
      contains: "test_clinical_mode_preserves_location"
  key_links:
    - from: "app/deidentification.py"
      to: "app/config.py"
      via: "settings.transfer_facility_mode"
      pattern: "settings\\.transfer_facility_mode"
    - from: "app/deidentification.py"
      to: "presidio_anonymizer"
      via: "keep operator import"
      pattern: 'OperatorConfig\\("keep"'
---

<objective>
Implement backend configuration and logic for transfer facility mode.

Purpose: Enable configurable selective preservation of LOCATION entities via Presidio's "keep" operator, defaulting to conservative HIPAA Safe Harbor compliance while allowing clinical mode for care coordination workflows.

Output: Settings configuration, conditional anonymization logic, and comprehensive unit tests.
</objective>

<execution_context>
@/Users/joshpankin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joshpankin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-transfer-facility-preservation/23-RESEARCH.md
@app/config.py
@app/deidentification.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add transfer_facility_mode setting to config.py</name>
  <files>app/config.py</files>
  <action>
Add transfer_facility_mode configuration to the Settings class in `app/config.py`.

Add after the SpaCy Configuration section (around line 385):

```python
    # =========================================================================
    # Transfer Facility Configuration (Phase 23 - v2.4)
    # =========================================================================
    transfer_facility_mode: str = Field(
        default="conservative",
        description=(
            "Transfer facility handling mode:\n"
            "- 'conservative' (default): Redact all locations per HIPAA Safe Harbor\n"
            "- 'clinical': Preserve transfer facility names for care coordination\n"
            "WARNING: Clinical mode does not meet HIPAA Safe Harbor requirements"
        )
    )

    @field_validator("transfer_facility_mode")
    @classmethod
    def validate_transfer_mode(cls, v):
        allowed = ["conservative", "clinical"]
        if v not in allowed:
            raise ValueError(
                f"transfer_facility_mode must be one of {allowed}, got '{v}'"
            )
        return v
```

Required import at top of file (add if not present):
```python
from pydantic import Field, field_validator
```

Key design decisions:
- Default is "conservative" (HIPAA Safe Harbor compliant)
- Pydantic validation fails fast with clear error message
- Documentation includes warning about clinical mode
- Environment variable override supported via Pydantic Settings pattern
  </action>
  <verify>
1. Run `python -c "from app.config import settings; print(settings.transfer_facility_mode)"` - should print "conservative"
2. Run `python -c "import os; os.environ['TRANSFER_FACILITY_MODE']='clinical'; from app.config import Settings; s=Settings(); print(s.transfer_facility_mode)"` - should print "clinical"
3. Run `python -c "import os; os.environ['TRANSFER_FACILITY_MODE']='invalid'; from app.config import Settings; s=Settings()"` - should raise ValueError
  </verify>
  <done>
transfer_facility_mode setting added with validation, defaulting to conservative
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement conditional LOCATION operator in deidentification.py</name>
  <files>app/deidentification.py</files>
  <action>
Modify `deidentify_text()` function in `app/deidentification.py` to accept transfer_facility_mode parameter and apply conditional LOCATION handling.

1. Update function signature (around line 159):
```python
def deidentify_text(
    text: str,
    strategy: str = "type_marker",
    transfer_facility_mode: str | None = None  # NEW parameter
) -> DeidentificationResult:
```

2. Add mode resolution after docstring (around line 176):
```python
    # Resolve transfer facility mode (use setting if not specified)
    if transfer_facility_mode is None:
        transfer_facility_mode = settings.transfer_facility_mode
```

3. Modify the type_marker operator configuration (around line 266-286).

Replace the existing loop:
```python
    if strategy == "type_marker":
        # Replace with type marker: [NAME], [PHONE], etc.
        operators = {}
        for entity_type in settings.phi_entities:
```

With conditional logic:
```python
    if strategy == "type_marker":
        # Replace with type marker: [NAME], [PHONE], etc.
        operators = {}
        for entity_type in settings.phi_entities:
            # Create readable marker
            marker = f"[{entity_type.replace('_', ' ').title()}]"
            # Simplify common markers
            marker_map = {
                "[Person]": "[NAME]",
                "[Phone Number]": "[PHONE]",
                "[Email Address]": "[EMAIL]",
                "[Date Time]": "[DATE]",
                "[Medical Record Number]": "[MRN]",
                "[Guardian Name]": "[NAME]",
                "[Provider Name]": "[NAME]",
                "[Pediatric Age]": "[AGE]",
                "[Room]": "[ROOM]",
                "[Location]": "[LOCATION]",
            }
            marker = marker_map.get(marker, marker)

            # LOCATION handling: conditional on transfer_facility_mode (Phase 23)
            if entity_type == "LOCATION" and transfer_facility_mode == "clinical":
                # Clinical mode: preserve LOCATION entities (for transfer facilities)
                # Uses Presidio "keep" operator which leaves text unchanged
                operators[entity_type] = OperatorConfig("keep", {})
                logger.debug("Clinical mode: LOCATION entities will be preserved")
            else:
                # Conservative mode (default): redact all PHI
                operators[entity_type] = OperatorConfig("replace", {"new_value": marker})
```

Key design decisions:
- Parameter defaults to None, resolves from settings if not provided
- Only LOCATION entity is affected by mode
- Uses Presidio's built-in "keep" operator (no custom filtering)
- Debug logging indicates mode choice
- Deny list filtering still applies (happens before operator selection)
  </action>
  <verify>
1. Start Python REPL and test both modes:
```python
from app.deidentification import deidentify_text

# Test conservative mode (default)
result = deidentify_text("Transferred from Memorial Hospital")
assert "[LOCATION]" in result.clean_text, f"Conservative mode failed: {result.clean_text}"

# Test clinical mode
result = deidentify_text("Transferred from Memorial Hospital", transfer_facility_mode="clinical")
assert "Memorial Hospital" in result.clean_text, f"Clinical mode failed: {result.clean_text}"

print("Both modes work correctly!")
```
  </verify>
  <done>
Conditional LOCATION operator implemented with keep vs replace based on mode
  </done>
</task>

<task type="auto">
  <name>Task 3: Create unit tests for transfer facility mode</name>
  <files>tests/test_transfer_facility_mode.py</files>
  <action>
Create `tests/test_transfer_facility_mode.py` with comprehensive tests:

```python
"""
Phase 23: Transfer Facility Mode Tests

Tests for configurable LOCATION preservation:
- Conservative mode (default): Redacts all LOCATION entities
- Clinical mode: Preserves LOCATION entities for care coordination

WARNING: Clinical mode does not meet HIPAA Safe Harbor requirements.
"""

import os
import pytest
from app.deidentification import deidentify_text
from app.config import Settings


class TestTransferFacilityModeConfig:
    """Test configuration and validation."""

    def test_default_mode_is_conservative(self):
        """Default should be conservative for HIPAA compliance."""
        settings = Settings()
        assert settings.transfer_facility_mode == "conservative"

    def test_clinical_mode_allowed(self):
        """Clinical mode should be valid option."""
        # Use environment variable to set mode
        os.environ["TRANSFER_FACILITY_MODE"] = "clinical"
        try:
            settings = Settings()
            assert settings.transfer_facility_mode == "clinical"
        finally:
            del os.environ["TRANSFER_FACILITY_MODE"]

    def test_invalid_mode_raises_error(self):
        """Invalid mode should fail fast with clear error."""
        os.environ["TRANSFER_FACILITY_MODE"] = "invalid_mode"
        try:
            with pytest.raises(ValueError, match="must be one of"):
                Settings()
        finally:
            del os.environ["TRANSFER_FACILITY_MODE"]


class TestConservativeMode:
    """Test conservative mode (default) - redacts all LOCATION."""

    def test_transfer_context_redacted(self):
        """Transfer facility names should be redacted in conservative mode."""
        text = "The patient was transferred from Children's Hospital."
        result = deidentify_text(text, transfer_facility_mode="conservative")

        assert "[LOCATION]" in result.clean_text
        assert "Children's Hospital" not in result.clean_text

    def test_admitted_from_redacted(self):
        """Admitted from context should be redacted."""
        text = "Admitted from Springfield Medical Center yesterday."
        result = deidentify_text(text, transfer_facility_mode="conservative")

        assert "[LOCATION]" in result.clean_text
        assert "Springfield Medical Center" not in result.clean_text

    def test_came_from_redacted(self):
        """Came from context should be redacted."""
        text = "Patient came from Memorial General Hospital."
        result = deidentify_text(text, transfer_facility_mode="conservative")

        assert "[LOCATION]" in result.clean_text
        assert "Memorial General Hospital" not in result.clean_text

    def test_home_address_redacted(self):
        """Home addresses should always be redacted."""
        text = "Patient lives at 425 Oak Street in Portland."
        result = deidentify_text(text, transfer_facility_mode="conservative")

        # Address detection depends on spaCy NER
        # At minimum, city names should be caught
        assert "Portland" not in result.clean_text or "[LOCATION]" in result.clean_text


class TestClinicalMode:
    """Test clinical mode - preserves LOCATION for care coordination."""

    def test_transfer_context_preserved(self):
        """Transfer facility names should be preserved in clinical mode."""
        text = "The patient was transferred from Children's Hospital."
        result = deidentify_text(text, transfer_facility_mode="clinical")

        # Clinical mode preserves LOCATION
        assert "[LOCATION]" not in result.clean_text
        assert "Children's Hospital" in result.clean_text

    def test_admitted_from_preserved(self):
        """Admitted from context should be preserved."""
        text = "Admitted from Springfield Medical Center yesterday."
        result = deidentify_text(text, transfer_facility_mode="clinical")

        assert "[LOCATION]" not in result.clean_text
        assert "Springfield Medical Center" in result.clean_text

    def test_came_from_preserved(self):
        """Came from context should be preserved."""
        text = "Patient came from Memorial General Hospital."
        result = deidentify_text(text, transfer_facility_mode="clinical")

        assert "[LOCATION]" not in result.clean_text
        assert "Memorial General Hospital" in result.clean_text

    def test_other_phi_still_redacted(self):
        """Non-LOCATION PHI should still be redacted in clinical mode."""
        text = "Dr. Sarah Johnson transferred the patient from Memorial Hospital."
        result = deidentify_text(text, transfer_facility_mode="clinical")

        # LOCATION preserved
        assert "Memorial Hospital" in result.clean_text
        # PERSON redacted
        assert "Sarah Johnson" not in result.clean_text
        assert "[NAME]" in result.clean_text

    def test_home_address_also_preserved(self):
        """Note: Clinical mode preserves ALL LOCATION entities.

        This is intentional - clinical mode is an explicit user choice
        to prioritize care coordination over Safe Harbor compliance.
        Users who need address redaction should use conservative mode.
        """
        text = "Patient lives at 425 Oak Street."
        result = deidentify_text(text, transfer_facility_mode="clinical")

        # Clinical mode preserves all LOCATION (including addresses if detected)
        # This is a documented tradeoff
        assert "[LOCATION]" not in result.clean_text


class TestDenyListInteraction:
    """Test that deny list filtering works in both modes."""

    def test_deny_list_conservative_mode(self):
        """Deny list should filter false positives in conservative mode."""
        text = "Patient on high flow NC at 2L via nasal cannula."
        result = deidentify_text(text, transfer_facility_mode="conservative")

        # NC should not be flagged as LOCATION (deny list)
        assert "NC" in result.clean_text
        assert "nasal cannula" in result.clean_text

    def test_deny_list_clinical_mode(self):
        """Deny list should filter false positives in clinical mode."""
        text = "Patient on high flow NC at 2L via nasal cannula."
        result = deidentify_text(text, transfer_facility_mode="clinical")

        # NC should not be flagged as LOCATION (deny list)
        assert "NC" in result.clean_text
        assert "nasal cannula" in result.clean_text


class TestParameterOverride:
    """Test that function parameter overrides config setting."""

    def test_parameter_overrides_config(self):
        """Function parameter should override settings."""
        text = "Transferred from Memorial Hospital."

        # Even with conservative default, clinical parameter should work
        result = deidentify_text(text, transfer_facility_mode="clinical")
        assert "Memorial Hospital" in result.clean_text

        # Conservative parameter should redact
        result = deidentify_text(text, transfer_facility_mode="conservative")
        assert "[LOCATION]" in result.clean_text
```

Run tests: `pytest tests/test_transfer_facility_mode.py -v`
  </action>
  <verify>
Run `pytest tests/test_transfer_facility_mode.py -v --tb=short` - all tests should pass:
- TestTransferFacilityModeConfig: 3 tests
- TestConservativeMode: 4 tests
- TestClinicalMode: 4 tests
- TestDenyListInteraction: 2 tests
- TestParameterOverride: 1 test

Total: 14 tests passing
  </verify>
  <done>
14 unit tests created covering config validation, both modes, deny list interaction, and parameter override
  </done>
</task>

</tasks>

<verification>
1. app/config.py has transfer_facility_mode field with default "conservative"
2. app/config.py has field_validator for transfer_facility_mode
3. app/deidentification.py accepts transfer_facility_mode parameter
4. deidentify_text uses "keep" operator for LOCATION when mode is "clinical"
5. tests/test_transfer_facility_mode.py exists with 14 tests
6. All tests pass: `pytest tests/test_transfer_facility_mode.py -v`
7. Existing tests still pass: `pytest tests/ -v --ignore=tests/integration`
</verification>

<success_criteria>
- [ ] transfer_facility_mode setting added to config.py
- [ ] Default mode is "conservative"
- [ ] Invalid mode values raise ValueError on startup
- [ ] deidentify_text accepts transfer_facility_mode parameter
- [ ] Clinical mode uses Presidio "keep" operator for LOCATION
- [ ] Conservative mode uses "replace" operator for LOCATION
- [ ] Deny list filtering works in both modes
- [ ] 14 unit tests pass covering all scenarios
- [ ] No regression on existing test suite
</success_criteria>

<output>
After completion, create `.planning/phases/23-transfer-facility-preservation/23-01-SUMMARY.md`
</output>
