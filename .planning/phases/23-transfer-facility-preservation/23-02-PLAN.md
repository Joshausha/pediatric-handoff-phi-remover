---
phase: 23-transfer-facility-preservation
plan: 02
type: execute
wave: 2
depends_on: ["23-01"]
files_modified:
  - static/index.html
  - static/app.js
  - static/styles.css
  - app/main.py
  - .planning/phases/23-transfer-facility-preservation/23-VERIFICATION.md
autonomous: false

must_haves:
  truths:
    - "User can select transfer facility mode via radio buttons in UI"
    - "Conservative mode selected by default in UI"
    - "Clinical mode shows clear warning about HIPAA implications"
    - "API accepts transfer_mode parameter and passes to deidentification"
    - "Mode selection persists in form submission"
  artifacts:
    - path: "static/index.html"
      provides: "Radio button group for mode selection"
      contains: 'name="transfer-mode"'
    - path: "static/app.js"
      provides: "Form data includes transfer_mode"
      contains: "transfer_mode"
    - path: "app/main.py"
      provides: "API accepts transfer_mode Form field"
      contains: "transfer_mode"
  key_links:
    - from: "static/app.js"
      to: "/api/process"
      via: "FormData.append('transfer_mode')"
      pattern: "formData.append.*transfer_mode"
    - from: "app/main.py"
      to: "app/deidentification.py"
      via: "deidentify_text(transfer_facility_mode=)"
      pattern: "deidentify_text.*transfer_facility_mode"
---

<objective>
Implement frontend UI and API integration for transfer facility mode selection.

Purpose: Enable users to explicitly choose between conservative (HIPAA Safe Harbor) and clinical (care coordination) modes with clear warning about compliance implications.

Output: UI radio buttons, API parameter handling, integration verification, and Phase 23 verification report.
</objective>

<execution_context>
@/Users/joshpankin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/joshpankin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-transfer-facility-preservation/23-RESEARCH.md
@.planning/phases/23-transfer-facility-preservation/23-01-SUMMARY.md
@static/index.html
@static/app.js
@static/styles.css
@app/main.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add mode selection UI to index.html</name>
  <files>static/index.html</files>
  <action>
Add transfer facility mode radio buttons to `static/index.html`.

Insert after the recording panel section (after `</section>` for recording-panel, around line 56) and before the processing panel:

```html
        <!-- Transfer Mode Selection -->
        <section class="panel mode-panel">
            <h2>Processing Mode</h2>
            <div class="mode-selection">
                <label class="mode-option">
                    <input type="radio" name="transfer-mode" value="conservative" checked>
                    <div class="mode-content">
                        <span class="mode-title">Conservative Mode</span>
                        <span class="mode-desc">HIPAA Safe Harbor compliant - redacts all location information including transfer facilities</span>
                        <span class="mode-badge mode-default">Default</span>
                    </div>
                </label>
                <label class="mode-option">
                    <input type="radio" name="transfer-mode" value="clinical">
                    <div class="mode-content">
                        <span class="mode-title">Clinical Mode</span>
                        <span class="mode-desc">Preserves transfer facility names for care coordination</span>
                        <span class="mode-badge mode-warning">Does not meet Safe Harbor</span>
                    </div>
                </label>
            </div>
        </section>
```

Key design decisions:
- Radio buttons ensure mutually exclusive selection
- Conservative mode is checked by default
- Clinical mode has clear warning badge
- Descriptive text explains what each mode does
- Uses consistent panel styling with existing UI
  </action>
  <verify>
1. Open `static/index.html` in browser - mode selection panel should appear
2. Conservative mode should be selected by default
3. Can switch between modes using radio buttons
4. Clinical mode shows warning badge
  </verify>
  <done>
Mode selection radio buttons added to UI with conservative default
  </done>
</task>

<task type="auto">
  <name>Task 2: Add CSS styling for mode selection</name>
  <files>static/styles.css</files>
  <action>
Add styles for the mode selection panel to `static/styles.css`.

Add at the end of the file (before any closing comments):

```css
/* =========================================================================
   Transfer Facility Mode Selection (Phase 23)
   ========================================================================= */

.mode-panel {
    margin-bottom: 1.5rem;
}

.mode-selection {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.mode-option {
    display: flex;
    align-items: flex-start;
    padding: 1rem;
    border: 2px solid var(--border-color, #e2e8f0);
    border-radius: 8px;
    cursor: pointer;
    transition: border-color 0.2s, background-color 0.2s;
}

.mode-option:hover {
    border-color: var(--primary-color, #3b82f6);
    background-color: var(--hover-bg, #f8fafc);
}

.mode-option:has(input:checked) {
    border-color: var(--primary-color, #3b82f6);
    background-color: var(--selected-bg, #eff6ff);
}

.mode-option input[type="radio"] {
    margin-right: 0.75rem;
    margin-top: 0.25rem;
    width: 18px;
    height: 18px;
    cursor: pointer;
}

.mode-content {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.mode-title {
    font-weight: 600;
    color: var(--text-primary, #1e293b);
}

.mode-desc {
    font-size: 0.875rem;
    color: var(--text-secondary, #64748b);
    line-height: 1.4;
}

.mode-badge {
    display: inline-block;
    font-size: 0.75rem;
    font-weight: 500;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    margin-top: 0.25rem;
    width: fit-content;
}

.mode-default {
    background-color: var(--success-bg, #dcfce7);
    color: var(--success-text, #166534);
}

.mode-warning {
    background-color: var(--warning-bg, #fef3c7);
    color: var(--warning-text, #92400e);
}
```

Key design decisions:
- Uses :has() selector for checked state styling (modern CSS)
- Consistent with existing panel styling
- Clear visual distinction between modes
- Warning badge uses amber/yellow color scheme
- Default badge uses green color scheme
  </action>
  <verify>
1. Refresh browser - mode options should have proper styling
2. Hovering over mode options changes border color
3. Selected mode has blue border and light blue background
4. Default badge is green, warning badge is amber
  </verify>
  <done>
Mode selection styling added with visual state indicators
  </done>
</task>

<task type="auto">
  <name>Task 3: Update app.js to send transfer_mode in FormData</name>
  <files>static/app.js</files>
  <action>
Update `static/app.js` to include transfer_mode in the API request.

Modify the `processAudio()` method (around line 190-220).

Find the FormData construction:
```javascript
const formData = new FormData();
formData.append('file', this.audioBlob, 'recording.webm');
```

Replace with:
```javascript
const formData = new FormData();
formData.append('file', this.audioBlob, 'recording.webm');

// Get selected transfer mode (Phase 23)
const transferModeInput = document.querySelector('input[name="transfer-mode"]:checked');
const transferMode = transferModeInput ? transferModeInput.value : 'conservative';
formData.append('transfer_mode', transferMode);
```

Key design decisions:
- Uses querySelector to get checked radio button
- Falls back to 'conservative' if no selection (defensive)
- Appends as 'transfer_mode' to match FastAPI Form field
  </action>
  <verify>
1. Open browser DevTools Network tab
2. Record and process short audio clip
3. Check POST /api/process request - should include transfer_mode in FormData
4. Verify correct mode value is sent based on radio selection
  </verify>
  <done>
Frontend sends transfer_mode in FormData to API
  </done>
</task>

<task type="auto">
  <name>Task 4: Update API to accept transfer_mode parameter</name>
  <files>app/main.py</files>
  <action>
Update `/api/process` endpoint in `app/main.py` to accept and use transfer_mode.

1. Update the endpoint signature (around line 327-329):
```python
@app.post("/api/process", response_model=ProcessResponse, tags=["processing"])
@limiter.limit(f"{settings.rate_limit_requests}/{settings.rate_limit_window_seconds}seconds")
async def process_audio(
    request: Request,
    file: Annotated[UploadFile, File()],
    transfer_mode: Annotated[str, Form()] = "conservative"  # NEW: Phase 23
):
```

2. Add Form import at top of file (around line 14):
```python
from fastapi import FastAPI, File, Form, HTTPException, Query, Request, UploadFile
```

3. Validate transfer_mode early (after file validation, around line 365):
```python
    # Validate transfer mode (Phase 23)
    allowed_modes = ["conservative", "clinical"]
    if transfer_mode not in allowed_modes:
        raise HTTPException(
            status_code=400,
            detail=f"Invalid transfer_mode '{transfer_mode}'. Must be one of: {allowed_modes}"
        )

    logger.info(f"[{request_id}] Transfer facility mode: {transfer_mode}")
```

4. Pass transfer_mode to deidentify_text (around line 407):
```python
        # Step 2: De-identify
        logger.info(f"[{request_id}] Step 2: De-identifying PHI...")
        result = deidentify_text(transcript, "type_marker", transfer_facility_mode=transfer_mode)
```

5. Update audit logging to include mode (around line 420):
```python
        # Log successful completion
        audit_logger.log_request_complete(
            request_id=request_id,
            file_size_bytes=file_size,
            audio_duration_seconds=metadata.get("duration"),
            phi_entities_removed=result.entity_count,
            phi_by_type=result.entity_counts_by_type,
            processing_time_seconds=processing_time,
            client_ip_hash=client_ip_hash,
            # Phase 23: Log mode selection for audit
            transfer_mode=transfer_mode  # NOTE: audit.py may need update if this fails
        )
```

If audit.py doesn't accept transfer_mode, just add it to the log message instead:
```python
        logger.info(f"[{request_id}] Processing complete in {processing_time:.2f}s (mode: {transfer_mode})")
```

Key design decisions:
- Form() annotation for multipart form data
- Validation happens early (fail fast)
- Mode logged for audit trail
- Passed through to deidentify_text function
  </action>
  <verify>
1. Start server: `uvicorn app.main:app --reload`
2. Use curl to test API directly:
```bash
# Test conservative mode (default)
curl -X POST "http://localhost:8000/api/process" \
  -F "file=@test_audio.webm" \
  -F "transfer_mode=conservative"

# Test clinical mode
curl -X POST "http://localhost:8000/api/process" \
  -F "file=@test_audio.webm" \
  -F "transfer_mode=clinical"

# Test invalid mode (should return 400)
curl -X POST "http://localhost:8000/api/process" \
  -F "file=@test_audio.webm" \
  -F "transfer_mode=invalid"
```
  </verify>
  <done>
API accepts transfer_mode parameter and passes to deidentification
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete transfer facility mode feature:
- Backend: Config setting, conditional LOCATION operator (keep vs replace)
- Frontend: Radio button mode selection with warning badges
- API: transfer_mode parameter passed through to deidentification
- Tests: 14 unit tests for mode behavior
  </what-built>
  <how-to-verify>
1. Start the server: `uvicorn app.main:app --reload`
2. Open http://localhost:8000 in browser
3. Verify mode selection panel appears between recording and processing panels
4. Verify conservative mode is selected by default
5. Record or upload a short audio clip mentioning "transferred from Children's Hospital"
6. Process with **Conservative mode** - verify "Children's Hospital" is replaced with [LOCATION]
7. Process same/similar clip with **Clinical mode** - verify "Children's Hospital" is preserved
8. Verify other PHI (names, dates) is still redacted in clinical mode

Expected behavior:
- Conservative: "transferred from [LOCATION]"
- Clinical: "transferred from Children's Hospital"
- Both modes: Names replaced with [NAME]
  </how-to-verify>
  <resume-signal>Type "approved" if mode switching works correctly, or describe any issues found</resume-signal>
</task>

<task type="auto">
  <name>Task 5: Create Phase 23 Verification Report</name>
  <files>.planning/phases/23-transfer-facility-preservation/23-VERIFICATION.md</files>
  <action>
Create verification report documenting Phase 23 completion.

```markdown
# Phase 23: Transfer Facility Preservation - Verification Report

**Phase:** 23-transfer-facility-preservation
**Verified:** [DATE]
**Status:** COMPLETE

## Success Criteria Verification

### 1. Conservative Mode (Default)
| Criterion | Status | Evidence |
|-----------|--------|----------|
| "Transferred from Children's Hospital" redacts facility | PASS | [LOCATION] in output |
| "Came from Springfield Medical Center" redacts facility | PASS | [LOCATION] in output |
| Default mode is conservative | PASS | Radio checked, config default |
| Patient addresses still redacted | PASS | [LOCATION] in output |

### 2. Clinical Mode
| Criterion | Status | Evidence |
|-----------|--------|----------|
| "Transferred from Children's Hospital" preserves facility | PASS | "Children's Hospital" in output |
| "Came from Springfield Medical Center" preserves facility | PASS | "Springfield Medical Center" in output |
| Other PHI still redacted | PASS | Names show [NAME] |
| Warning displayed in UI | PASS | "Does not meet Safe Harbor" badge |

### 3. Configuration
| Criterion | Status | Evidence |
|-----------|--------|----------|
| transfer_facility_mode setting exists | PASS | config.py field |
| Invalid mode raises ValueError | PASS | test_invalid_mode_raises_error |
| Environment variable override works | PASS | test_clinical_mode_allowed |

### 4. Integration
| Criterion | Status | Evidence |
|-----------|--------|----------|
| Frontend sends transfer_mode | PASS | Network tab verification |
| API accepts transfer_mode | PASS | curl tests |
| Mode logged for audit | PASS | server logs |

### 5. No Regressions
| Criterion | Status | Evidence |
|-----------|--------|----------|
| Deny list filtering works | PASS | "NC" not flagged |
| Other LOCATION detection unchanged | PASS | lives_at patterns work |
| Existing tests pass | PASS | pytest tests/ |

## Test Results

```
pytest tests/test_transfer_facility_mode.py -v
# 14 passed

pytest tests/ -v --ignore=tests/integration
# All existing tests pass
```

## Key Decisions Documented

- **TRANSFER-MODE-BINARY** (Phase 23): Two-mode configuration (conservative/clinical) rather than fine-grained entity type splitting. Clinical mode preserves ALL LOCATION entities (including addresses) as documented tradeoff.
- **TRANSFER-MODE-DEFAULT-CONSERVATIVE** (Phase 23): Default to HIPAA Safe Harbor compliant mode; clinical mode requires explicit user selection with warning.
- **TRANSFER-MODE-KEEP-OPERATOR** (Phase 23): Use Presidio's built-in "keep" operator rather than custom filtering for cleaner implementation.

## Phase 23 Complete

All success criteria met. v2.4 Clinical Utility Refinement milestone can proceed.
```

Update with actual test results and date during execution.
  </action>
  <verify>
File exists and contains:
- All success criteria tables filled with PASS/FAIL status
- Test results section with actual pytest output
- Key decisions documented
- No FAIL or TODO items remaining
  </verify>
  <done>
Phase 23 verification report created documenting feature completion
  </done>
</task>

</tasks>

<verification>
1. static/index.html has mode selection radio buttons
2. static/styles.css has mode selection styling
3. static/app.js sends transfer_mode in FormData
4. app/main.py accepts transfer_mode Form parameter
5. API passes transfer_mode to deidentify_text
6. Mode logging appears in server output
7. All 14 unit tests pass
8. Human verification confirms end-to-end functionality
9. Verification report documents all success criteria
</verification>

<success_criteria>
- [ ] Mode selection panel appears in UI
- [ ] Conservative mode selected by default
- [ ] Clinical mode shows warning badge
- [ ] Frontend sends transfer_mode to API
- [ ] API validates and accepts transfer_mode
- [ ] Conservative mode: LOCATION entities redacted
- [ ] Clinical mode: LOCATION entities preserved
- [ ] Other PHI types still redacted in clinical mode
- [ ] Human verification confirms feature works end-to-end
- [ ] Verification report created
</success_criteria>

<output>
After completion, create `.planning/phases/23-transfer-facility-preservation/23-02-SUMMARY.md`
</output>
