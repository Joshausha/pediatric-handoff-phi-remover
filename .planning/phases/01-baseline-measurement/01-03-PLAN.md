---
phase: 01-baseline-measurement
plan: 03
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - tests/handoff_templates.py
  - tests/adversarial_handoffs.json
autonomous: true

must_haves:
  truths:
    - "Adversarial dataset includes speech artifact templates (stutters, corrections)"
    - "Adversarial dataset includes diverse name patterns (Hispanic, Asian, African)"
    - "Adversarial dataset includes transcription error patterns"
    - "Adversarial dataset includes edge case punctuation and word boundaries"
    - "100+ adversarial samples generated with seed=43"
  artifacts:
    - path: "tests/handoff_templates.py"
      provides: "Extended templates with adversarial edge cases"
      contains: "ADVERSARIAL_TEMPLATES"
      min_lines: 300
    - path: "tests/adversarial_handoffs.json"
      provides: "100+ synthetic handoffs for edge case testing"
      min_lines: 500
  key_links:
    - from: "tests/adversarial_handoffs.json"
      to: "tests/evaluate_presidio.py"
      via: "can be evaluated using same evaluation script"
      pattern: "load_dataset"
---

<objective>
Create an adversarial synthetic dataset with edge cases that stress-test the PHI detection system.

Purpose: The current synthetic dataset (seed=42) uses standard templates that may not expose weaknesses in regex patterns, deny lists, or threshold settings. Adversarial samples test edge cases like speech-to-text artifacts, cultural name diversity, punctuation variations, and transcription errors.

Output: Extended `tests/handoff_templates.py` with ADVERSARIAL_TEMPLATES and `tests/adversarial_handoffs.json` with 100+ samples (seed=43).
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-baseline-measurement/01-01-SUMMARY.md
@tests/handoff_templates.py
@tests/generate_test_data.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add adversarial template categories to handoff_templates.py</name>
  <files>tests/handoff_templates.py</files>
  <action>
Add new template categories to `tests/handoff_templates.py`. Create a new section at the end of the file with:

```python
# =============================================================================
# ADVERSARIAL TEMPLATES - Edge cases for PHI detection stress testing
# =============================================================================

# Speech artifacts: stutters, corrections, hesitations typical in speech-to-text
SPEECH_ARTIFACT_TEMPLATES = [
    # Stutters and filler words
    "Um, this is uh {{person}}, a {{pediatric_age}} old with um {{condition}}.",
    "So, like, contact {{person}} at like {{phone_number}} for uh questions.",
    "The uh the patient {{person}} was seen on um {{date}}.",
    "Room room {{room_number}}, I mean room {{room_number}}, for {{person}}.",

    # Self-corrections common in dictation
    "Patient is John no wait {{person}}, age {{pediatric_age}}.",
    "Call mom at 555 uh {{phone_number}} for updates.",
    "MRN is 12 no sorry {{mrn}} for this patient.",
    "Admitted to bed 12 I mean {{room_number}} on {{date}}.",

    # Hesitation mid-name
    "Contact parent, um, {{person}}, at {{phone_number}}.",
    "The attending, uh, Dr. {{last_name}}, will follow up.",
]

# Cultural name diversity patterns
DIVERSE_NAME_TEMPLATES = [
    # Hispanic names with multiple surnames
    "Patient {{person}} admitted to {{room_number}} with {{condition}}.",
    "Mom {{person}} can be reached at {{phone_number}}.",
    "Dad {{person}} present at bedside, email {{email}}.",

    # Hyphenated names
    "Attending is Dr. {{last_name}} on service.",
    "Contact {{person}} at {{phone_number}} for family updates.",

    # Names with titles/suffixes
    "Patient {{person}} Jr., age {{pediatric_age}}, has {{condition}}.",
    "Grandmother {{person}} is primary caregiver.",
]

# Edge case word boundaries and punctuation
BOUNDARY_EDGE_TEMPLATES = [
    # Start of line/sentence (lookbehind edge case)
    "{{person}} is a {{pediatric_age}} old admitted for {{condition}}.",
    "{{phone_number}} is the callback number for the family.",
    "{{room_number}} is where patient will be transferred.",

    # End of line/sentence
    "Patient admitted is {{person}}.",
    "Family contact: {{person}}.",
    "Best number to call: {{phone_number}}.",

    # Punctuation adjacent to PHI
    "Call ({{phone_number}}) for updates.",
    "Patient: {{person}}, MRN: {{mrn}}.",
    "Room: {{room_number}}; Bed: A.",
    "Email: <{{email}}>",

    # Comma-separated lists
    "Present: {{person}}, {{person}}, and nurse.",
    "Contacts: {{phone_number}}, {{phone_number}}.",
    "Seen on {{date}}, {{date}}, and {{date}}.",

    # Reversed relationship patterns (miss "Jessica is Mom")
    "{{person}} is mom and primary decision maker.",
    "{{person}} is dad, cell {{phone_number}}.",
    "{{person}} is the grandmother, contact at {{email}}.",

    # Lowercase relationship words
    "mom {{person}} at bedside.",
    "dad {{person}} called for update.",
    "patient {{person}} stable overnight.",
]

# Transcription errors and misheard words
TRANSCRIPTION_ERROR_TEMPLATES = [
    # Numbers that could be misheard
    "MRN {{mrn}}, or is it {{mrn}}? Please verify.",
    "Call {{phone_number}} or {{phone_number}} for mom.",
    "Weight is {{weight}} kg, repeat {{weight}} kilograms.",

    # Words that sound like PHI
    "Patient stable on NC, not in NC (the state).",
    "Give IV fluids, patient from OR (operating room).",
    "Patient in ER, not from the city called ER.",

    # Partial information repeated
    "{{person}}... {{person}} is the patient name.",
    "Room {{room_number}}, that's {{room_number}}.",
    "Email again: {{email}}, {{email}}.",
]

# Complex compound patterns
COMPOUND_PATTERN_TEMPLATES = [
    # Multiple PHI in close proximity
    "{{person}} (MRN {{mrn}}) admitted to {{room_number}} on {{date}}.",
    "Mom {{person}} ({{phone_number}}) and dad {{person}} ({{phone_number}}) available.",
    "Patient {{person}}, {{pediatric_age}}, from {{city}}, MRN {{mrn}}.",

    # PHI embedded in clinical context
    "If {{person}}'s condition worsens, call {{phone_number}} immediately.",
    "{{person}} at {{email}} is the case manager.",
    "Transfer to {{room_number}} per Dr. {{last_name}}.",

    # Nested context (harder to parse)
    "According to mom ({{person}}), patient ({{person}}) has {{condition}}.",
    "Dr. {{last_name}} spoke with {{person}} at {{phone_number}} on {{date}}.",
]

# Age patterns that are tricky
AGE_EDGE_TEMPLATES = [
    # Non-standard age formats
    "Baby is {{pediatric_age}} old.",
    "Infant born on {{date}}, now {{pediatric_age}}.",
    "Patient is approximately {{pediatric_age}}.",

    # Ages that look like other numbers
    "3 week old patient, weight 3.2kg.",
    "5 day old infant in room 5.",
    "Patient 2 years 3 months, give 2.3 mL.",
]

# Combine all adversarial templates
ADVERSARIAL_TEMPLATES = (
    SPEECH_ARTIFACT_TEMPLATES +
    DIVERSE_NAME_TEMPLATES +
    BOUNDARY_EDGE_TEMPLATES +
    TRANSCRIPTION_ERROR_TEMPLATES +
    COMPOUND_PATTERN_TEMPLATES +
    AGE_EDGE_TEMPLATES
)
```

Also update the existing code to make ADVERSARIAL_TEMPLATES importable by adding it to the module's exports if there's an __all__ list.
  </action>
  <verify>
Run: `cd "/Users/joshpankin/My Drive/10-19 Projects/12 Development & AI Projects/12.09 Pediatric_Handoff_PHI_Remover" && python -c "from tests.handoff_templates import ADVERSARIAL_TEMPLATES; print(f'Adversarial templates: {len(ADVERSARIAL_TEMPLATES)}')"` should show 40+ templates.
  </verify>
  <done>ADVERSARIAL_TEMPLATES added to handoff_templates.py with 40+ edge case templates.</done>
</task>

<task type="auto">
  <name>Task 2: Generate adversarial dataset with seed=43</name>
  <files>tests/adversarial_handoffs.json</files>
  <action>
Generate the adversarial dataset using the new templates:

```bash
cd "/Users/joshpankin/My Drive/10-19 Projects/12 Development & AI Projects/12.09 Pediatric_Handoff_PHI_Remover"

# Create a temporary script to generate adversarial dataset
python -c "
import sys
sys.path.insert(0, '.')
from tests.generate_test_data import PediatricHandoffGenerator, save_dataset
from tests.handoff_templates import ADVERSARIAL_TEMPLATES
from pathlib import Path

# Generate 100 adversarial samples with seed=43 (different from main dataset seed=42)
generator = PediatricHandoffGenerator(seed=43)
dataset = generator.generate_dataset(n_samples=100, templates=ADVERSARIAL_TEMPLATES)

# Save to separate file
save_dataset(dataset, Path('tests/adversarial_handoffs.json'))

# Print summary
print(f'Generated {len(dataset)} adversarial handoffs')
print(f'Template coverage: {len(set(h.template_id for h in dataset))}/{len(ADVERSARIAL_TEMPLATES)} templates used')
"
```

If the above doesn't work due to import issues, create a dedicated generate_adversarial.py script:

1. Copy generate_test_data.py logic
2. Import ADVERSARIAL_TEMPLATES instead of ALL_TEMPLATES
3. Use seed=43
4. Output to tests/adversarial_handoffs.json
  </action>
  <verify>
1. File exists: `tests/adversarial_handoffs.json`
2. Contains 100 samples: `python -c "import json; d=json.load(open('tests/adversarial_handoffs.json')); print(f'Samples: {len(d[\"handoffs\"])}')"` outputs "Samples: 100"
3. Metadata shows seed=43 or generated_at timestamp
  </verify>
  <done>tests/adversarial_handoffs.json created with 100 adversarial samples.</done>
</task>

<task type="auto">
  <name>Task 3: Evaluate adversarial dataset and document gaps</name>
  <files>None (evaluation and analysis)</files>
  <action>
Run evaluation on the adversarial dataset to identify gaps:

```bash
cd "/Users/joshpankin/My Drive/10-19 Projects/12 Development & AI Projects/12.09 Pediatric_Handoff_PHI_Remover"

# Run evaluation on adversarial dataset
python tests/evaluate_presidio.py --input tests/adversarial_handoffs.json --verbose 2>&1 | tee /tmp/adversarial_report.txt

# Get JSON metrics
python tests/evaluate_presidio.py --input tests/adversarial_handoffs.json --json 2>/dev/null > /tmp/adversarial_metrics.json

# Export confusion matrix
python tests/evaluate_presidio.py --input tests/adversarial_handoffs.json --export-confusion-matrix /tmp/adversarial_confusion.json 2>/dev/null
```

Document the findings:
1. Compare adversarial recall vs standard dataset recall
2. Identify which template categories have worst performance
3. List specific patterns that fail (false negatives)

This analysis informs Phase 4 (Pattern Improvements).
  </action>
  <verify>
1. Evaluation completes without error
2. Report shows per-entity metrics
3. JSON output can be parsed
4. At least some gaps identified (adversarial dataset SHOULD expose weaknesses)
  </verify>
  <done>Adversarial dataset evaluated and gaps documented for Phase 4 planning.</done>
</task>

</tasks>

<verification>
Overall verification steps:
1. `tests/handoff_templates.py` contains ADVERSARIAL_TEMPLATES constant
2. ADVERSARIAL_TEMPLATES has 40+ templates across 6 categories
3. `tests/adversarial_handoffs.json` exists with 100 samples
4. Evaluation script can process adversarial dataset: `python tests/evaluate_presidio.py --input tests/adversarial_handoffs.json --json`
5. Adversarial dataset exposes weaknesses (recall < 100%)
</verification>

<success_criteria>
1. ADVERSARIAL_TEMPLATES added with speech artifacts, diverse names, boundary edges, transcription errors
2. 100+ adversarial samples generated with seed=43
3. Adversarial dataset is separate from main dataset (different seed, different file)
4. Evaluation runs successfully on adversarial dataset
5. Gaps identified for future pattern improvements
</success_criteria>

<output>
After completion, create `.planning/phases/01-baseline-measurement/01-03-SUMMARY.md`
</output>
