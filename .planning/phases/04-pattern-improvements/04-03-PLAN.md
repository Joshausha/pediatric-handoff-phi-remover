---
phase: 04-pattern-improvements
plan: 03
type: execute
wave: 2
depends_on: ["04-01", "04-02"]
files_modified:
  - app/recognizers/pediatric.py
  - tests/test_deidentification.py
autonomous: false

must_haves:
  truths:
    - "User decides whether to keep, disable, or modify PEDIATRIC_AGE recognizer"
    - "Full regression test suite runs against all pattern improvements"
    - "Recall metrics measured for ROOM and GUARDIAN_NAME entities"
    - "Phase 4 pattern improvements documented with measured impact"
  artifacts:
    - path: "tests/test_deidentification.py"
      provides: "Complete regression test coverage"
      contains: "TestPatternRegressions"
    - path: "tests/results/pattern_improvements.json"
      provides: "Measured recall improvement data"
  key_links:
    - from: "tests/evaluate_presidio.py"
      to: "app/recognizers"
      via: "evaluation measures pattern changes"
      pattern: "evaluate_dataset"
---

<objective>
Finalize Phase 4 by addressing PEDIATRIC_AGE entity handling (user decision), creating comprehensive regression tests, and measuring the recall impact of pattern improvements.

Purpose: PEDIATRIC_AGE has 35.8% recall but ages aren't PHI under HIPAA (unless 90+). User must decide whether to keep, disable, or modify this recognizer. After pattern improvements in Plans 01 and 02, we need to measure the actual recall improvement and ensure no regressions.

Output: User decision on PEDIATRIC_AGE recorded, comprehensive regression tests, and documented recall metrics showing improvement.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-pattern-improvements/04-RESEARCH.md
@.planning/phases/04-pattern-improvements/04-01-SUMMARY.md
@.planning/phases/04-pattern-improvements/04-02-SUMMARY.md
@app/recognizers/pediatric.py
@tests/evaluate_presidio.py
@tests/calibrate_thresholds.py
</context>

<tasks>

<task type="checkpoint:decision" gate="blocking">
  <decision>Should the PEDIATRIC_AGE recognizer be kept, disabled, or modified?</decision>
  <context>
PEDIATRIC_AGE currently has 35.8% recall (weakest entity). However, **ages are NOT PHI under HIPAA** (unless 90+). The user stated "Keep ages for clinical utility" in the phase context discussion.

The recognizer redacts patterns like:
- "3 weeks 2 days old"
- "32 weeker" (gestational age)
- "5 day old"

These are clinically important and NOT identifying information.
  </context>
  <options>
    <option id="disable">
      <name>Disable PEDIATRIC_AGE recognizer entirely</name>
      <pros>
        - Ages preserved for clinical utility
        - No false positives on age-related text
        - Aligns with HIPAA (ages aren't PHI unless 90+)
        - Saves pattern engineering effort
      </pros>
      <cons>
        - Very rare edge case: specific age + rare condition could be quasi-identifying
        - Requires removing recognizer from get_pediatric_recognizers()
      </cons>
    </option>
    <option id="keep-90plus">
      <name>Keep recognizer but only flag ages 90+</name>
      <pros>
        - HIPAA-compliant (90+ is the only PHI age threshold)
        - Most ages preserved for clinical utility
        - Minimal pattern work needed
      </pros>
      <cons>
        - Pediatric context rarely has 90+ ages (parents/grandparents only)
        - Still requires pattern modification
      </cons>
    </option>
    <option id="keep-improve">
      <name>Keep recognizer and improve patterns to 90% recall</name>
      <pros>
        - Conservative PHI removal
        - Covers edge case quasi-identifiers
      </pros>
      <cons>
        - Significant pattern engineering effort
        - Over-redacts clinically useful information
        - May not be necessary for HIPAA compliance
      </cons>
    </option>
  </options>
  <resume-signal>Select: disable, keep-90plus, or keep-improve</resume-signal>
</task>

<task type="auto">
  <name>Task 2: Implement PEDIATRIC_AGE decision and run full evaluation</name>
  <files>app/recognizers/pediatric.py, tests/results/pattern_improvements.json</files>
  <action>
Based on user decision from Task 1:

**If "disable":**
1. Comment out or remove the age_patterns and age_recognizer from get_pediatric_recognizers()
2. Add a comment explaining the decision:
```python
# PEDIATRIC_AGE recognizer disabled (2026-01-XX)
# Rationale: Ages are NOT PHI under HIPAA (unless 90+).
# Ages preserved for clinical utility per project decision.
# See: .planning/phases/04-pattern-improvements/04-03-SUMMARY.md
```

**If "keep-90plus":**
1. Modify age patterns to only match ages 90+:
```python
# Only match ages 90+ (HIPAA PHI threshold)
Pattern(name="age_90plus_years", regex=r"\b(9[0-9]|[1-9]\d{2})\s*(?:year|yr)s?\s*old\b", score=0.85),
```
2. Remove other age patterns (weeks, months, days)

**If "keep-improve":**
1. Add abbreviation patterns as documented in 04-RESEARCH.md:
```python
Pattern(name="age_abbreviated", regex=r"(?i)\b(\d{1,2})\s*(?:yo|y\.o\.|years?\s+old)\b", score=0.60),
Pattern(name="age_months", regex=r"(?i)\b(\d{1,2})\s*(?:mo|months?\s+old)\b", score=0.60),
Pattern(name="age_weeks", regex=r"(?i)\b(\d{1,2})\s*(?:wo|weeks?\s+old)\b", score=0.60),
Pattern(name="gestational_weeks_days", regex=r"\b(\d{2})\+(\d)\b", score=0.65),
Pattern(name="gestational_weeker", regex=r"(?i)\b(?:ex-)?(\d{2})\s*weeker\b", score=0.65),
```

**Then run full evaluation to measure improvement:**
```bash
cd "/Users/joshpankin/My Drive/10-19 Projects/12 Development & AI Projects/12.09 Pediatric_Handoff_PHI_Remover"
source venv/bin/activate

# Generate fresh evaluation with both datasets
python tests/evaluate_presidio.py \
    --output tests/results/pattern_improvements.json \
    --confusion-matrix \
    --samples 500 \
    --seed 42

# Also run on adversarial dataset
python tests/evaluate_presidio.py \
    --output tests/results/pattern_improvements_adversarial.json \
    --confusion-matrix \
    --samples 100 \
    --seed 43 \
    --templates adversarial
```

Capture the recall metrics for:
- GUARDIAN_NAME (target: >90%)
- ROOM (target: >90%, was 32.1%)
- PERSON (baseline: 98.9%, should stay high)
- Overall recall (target: >85%)
  </action>
  <verify>
```bash
cd "/Users/joshpankin/My Drive/10-19 Projects/12 Development & AI Projects/12.09 Pediatric_Handoff_PHI_Remover"
python -c "
import json
with open('tests/results/pattern_improvements.json') as f:
    data = json.load(f)

print('Pattern Improvements Results:')
print(f\"Overall Recall: {data['overall']['recall']:.1%}\")
for entity in ['PERSON', 'GUARDIAN_NAME', 'ROOM', 'PEDIATRIC_AGE']:
    if entity in data['by_entity']:
        e = data['by_entity'][entity]
        print(f\"{entity}: Recall={e['recall']:.1%}, Precision={e['precision']:.1%}\")
    else:
        print(f\"{entity}: Not present (recognizer disabled)\")
"
```
ROOM recall should show significant improvement from 32.1% baseline.
  </verify>
  <done>
PEDIATRIC_AGE decision implemented. Full evaluation completed with documented recall metrics for all entity types.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create comprehensive regression test suite</name>
  <files>tests/test_deidentification.py</files>
  <action>
Add a final test class `TestPatternRegressions` that runs bulk tests to catch any regressions:

1. **Import adversarial templates:**
```python
from tests.handoff_templates import (
    ADVERSARIAL_TEMPLATES,
    BOUNDARY_EDGE_TEMPLATES,
    SPEECH_ARTIFACT_TEMPLATES,
)
```

2. **Create regression test using real adversarial samples:**
```python
@pytest.mark.bulk
class TestPatternRegressions:
    """
    Regression tests for Phase 4 pattern improvements.

    These tests ensure pattern changes don't break existing detection
    while improving edge case coverage.
    """

    @pytest.fixture(scope="class")
    def generator(self):
        from tests.generate_test_data import PediatricHandoffGenerator
        return PediatricHandoffGenerator(seed=43)  # Adversarial seed

    @pytest.fixture(scope="class")
    def evaluator(self):
        from tests.evaluate_presidio import PresidioEvaluator
        return PresidioEvaluator(overlap_threshold=0.5)

    @pytest.mark.bulk
    def test_guardian_name_recall_improved(self, generator, evaluator):
        """GUARDIAN_NAME recall should be >80% on adversarial templates."""
        from tests.handoff_templates import BOUNDARY_EDGE_TEMPLATES

        # Generate samples with guardian patterns
        guardian_templates = [t for t in BOUNDARY_EDGE_TEMPLATES
                             if "mom" in t.lower() or "dad" in t.lower()]
        dataset = generator.generate_dataset(n_samples=50, templates=guardian_templates)

        metrics, _ = evaluator.evaluate_dataset(dataset, verbose=False)

        # Target: >80% recall on adversarial edge cases
        print(f"GUARDIAN_NAME adversarial recall: {metrics.recall:.1%}")
        assert metrics.recall >= 0.80, f"Guardian recall {metrics.recall:.1%} below 80%"

    @pytest.mark.bulk
    def test_room_recall_improved(self, generator, evaluator):
        """ROOM recall should be >70% on adversarial templates."""
        from tests.handoff_templates import HANDOFF_TEMPLATES

        room_templates = [t for t in HANDOFF_TEMPLATES if "room" in t.lower() or "bed" in t.lower()]
        dataset = generator.generate_dataset(n_samples=50, templates=room_templates[:10])

        metrics, _ = evaluator.evaluate_dataset(dataset, verbose=False)

        # Target: >70% recall (significant improvement from 32.1%)
        print(f"ROOM adversarial recall: {metrics.recall:.1%}")
        assert metrics.recall >= 0.70, f"Room recall {metrics.recall:.1%} below 70%"

    @pytest.mark.bulk
    def test_no_regression_on_standard_entities(self, generator, evaluator):
        """PERSON, PHONE, EMAIL should maintain high recall (>90%)."""
        dataset = generator.generate_dataset(n_samples=100)
        metrics, results = evaluator.evaluate_dataset(dataset, verbose=False)

        print(f"Overall recall after pattern improvements: {metrics.recall:.1%}")

        # Check per-entity for high-performing entities
        for entity in ['PERSON', 'EMAIL_ADDRESS']:
            entity_results = [r for r in results if any(
                s.entity_type == entity for s in r.true_positives + r.false_negatives
            )]
            if entity_results:
                tp = sum(len([s for s in r.true_positives if s.entity_type == entity])
                        for r in entity_results)
                fn = sum(len([s for s in r.false_negatives if s.entity_type == entity])
                        for r in entity_results)
                recall = tp / (tp + fn) if (tp + fn) > 0 else 0
                print(f"{entity} recall: {recall:.1%}")
                assert recall >= 0.90, f"{entity} recall {recall:.1%} regressed below 90%"
```

3. **Add quick smoke tests for each pattern improvement:**
```python
class TestPatternSmokeTests:
    """Quick smoke tests for pattern improvements (non-bulk)."""

    def test_lowercase_guardian_detected(self):
        """Regression test: lowercase guardian names must be caught."""
        result = deidentify_text("mom jessica is at bedside")
        assert "jessica" not in result.clean_text.lower()

    def test_bidirectional_guardian_detected(self):
        """Regression test: bidirectional patterns must be caught."""
        result = deidentify_text("Jessica is mom")
        assert "jessica" not in result.clean_text.lower()

    def test_lowercase_room_detected(self):
        """Regression test: lowercase room must be caught."""
        result = deidentify_text("patient in room 302")
        assert "302" not in result.clean_text

    def test_picu_bed_lowercase_detected(self):
        """Regression test: lowercase ICU bed must be caught."""
        result = deidentify_text("patient in picu bed 7")
        assert "7" not in result.clean_text or "[ROOM]" in result.clean_text

    def test_clinical_content_preserved(self):
        """Regression test: medical terms must not be over-redacted."""
        result = deidentify_text("Patient with RSV bronchiolitis on nasal cannula")
        assert "RSV" in result.clean_text
        assert "bronchiolitis" in result.clean_text
        assert "nasal cannula" in result.clean_text
```

Place these test classes at the end of the file.
  </action>
  <verify>
```bash
cd "/Users/joshpankin/My Drive/10-19 Projects/12 Development & AI Projects/12.09 Pediatric_Handoff_PHI_Remover"
source venv/bin/activate

# Run smoke tests (fast)
pytest tests/test_deidentification.py -v -k "PatternSmokeTests" --tb=short

# Run full test suite excluding bulk
pytest tests/test_deidentification.py -v -k "not bulk" --tb=short
```
All smoke tests and non-bulk tests should pass.
  </verify>
  <done>
Comprehensive regression test suite added. All smoke tests pass. Pattern improvements validated without regressions.
  </done>
</task>

</tasks>

<verification>
1. User decision on PEDIATRIC_AGE recorded and implemented
2. Full evaluation metrics captured in tests/results/pattern_improvements.json
3. ROOM recall improved from 32.1% baseline (target: >70% on adversarial)
4. No regression on high-performing entities (PERSON, EMAIL maintain >90%)
5. All smoke tests pass
6. All non-bulk tests pass
</verification>

<success_criteria>
- PATT-05: PEDIATRIC_AGE entity handled per user decision
- PATT-06: ROOM recall improved from 32.1% (measured improvement documented)
- All regression tests pass
- Pattern improvement metrics documented
- No regressions on existing high-performing entities
</success_criteria>

<output>
After completion, create `.planning/phases/04-pattern-improvements/04-03-SUMMARY.md`
</output>
