---
phase: 04-pattern-improvements
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - app/recognizers/medical.py
  - tests/test_deidentification.py
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Hyphenated room numbers without Room prefix detected (3-22, 5-10)"
    - "Standalone hyphenated room formats work at any position in text"
    - "Existing room patterns still work (no regression)"
  artifacts:
    - path: "app/recognizers/medical.py"
      provides: "Extended room_multipart pattern to not require Room prefix"
    - path: "tests/test_deidentification.py"
      provides: "Additional parameterized tests for hyphenated room formats"
  key_links:
    - from: "tests/test_deidentification.py"
      to: "app/recognizers/medical.py"
      via: "deidentify_text -> get_medical_recognizers"
      pattern: "from app.deidentification import deidentify_text"
---

<objective>
Fix hyphenated room number detection where the Room/rm prefix is not present.

Purpose: Validation showed 11 span_boundary failures for hyphenated rooms like `3-22`, `2-25`, `9-27`. The current `room_multipart` pattern requires "room" or "rm" prefix but these appear standalone in the data.

Output: Extended pattern to catch standalone hyphenated room formats with low false positive risk.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-pattern-improvements/04-02-SUMMARY.md
@app/recognizers/medical.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add standalone hyphenated room pattern</name>
  <files>app/recognizers/medical.py</files>
  <action>
Add a new pattern to the room_patterns list in `get_medical_recognizers()`:

```python
# Standalone hyphenated room (without prefix): "3-22", "5-10", "2-25"
# Common in PICU/NICU settings where room format is floor-bed
# Using word boundary and context to reduce false positives
Pattern(
    name="room_hyphenated_standalone",
    regex=r"\b\d{1,2}-\d{1,2}\b",
    score=0.55  # Lower score - relies on context for confirmation
),
```

Place this pattern AFTER the existing `room_multipart` pattern (which handles "Room 3-22").

The lower score (0.55) means this pattern will match but with lower confidence, allowing context words in the recognizer (room, bed, floor, unit, located, admitted to, transferred to, bay, isolette) to boost the score.

NOTE: This pattern could match age ranges (e.g., "2-3 years old") or date ranges. The low score + context requirement helps mitigate false positives. Ages like "2-3 years old" should not trigger because "years" is not in the room context words.
  </action>
  <verify>
Run `python -c "from app.recognizers.medical import get_medical_recognizers; r = get_medical_recognizers(); room = [x for x in r if x.name == 'Room Number Recognizer'][0]; print([p.name for p in room.patterns])"` and verify "room_hyphenated_standalone" appears.
  </verify>
  <done>Standalone hyphenated room pattern added with low score to rely on context boosting.</done>
</task>

<task type="auto">
  <name>Task 2: Add tests for hyphenated room edge cases</name>
  <files>tests/test_deidentification.py</files>
  <action>
Add test cases to the existing `ROOM_EDGE_CASES` list (or create new parameterized tests) for standalone hyphenated rooms:

```python
# Add to ROOM_EDGE_CASES or create HYPHENATED_ROOM_CASES:
HYPHENATED_ROOM_EDGE_CASES = [
    # Standalone hyphenated with room context
    ("3-22", "Patient in 3-22 with bronchiolitis"),
    ("5-10", "Admitted to 5-10 yesterday"),
    ("2-25", "Currently in bed 2-25"),
    ("9-27", "Transfer from 9-27"),
    ("4-37", "Located in 4-37"),
    ("8-17", "Moved to 8-17 this morning"),
    # With preceding context
    ("2-37", "PICU 2-37 is available"),
    ("5-05", "Floor 5-05 patient"),
]
```

Each test should:
1. Call `deidentify_text()` with the context sentence
2. Assert `[ROOM]` appears in the result
3. Assert the original hyphenated number does NOT appear in the result

Also add negative tests to ensure we're NOT over-detecting:
```python
HYPHENATED_NON_ROOM_CASES = [
    # Age ranges should NOT be detected as room
    ("2-3", "Child is 2-3 years old"),
    # Date ranges should NOT be detected
    ("3-5", "Treatment for 3-5 days"),
]
```
  </action>
  <verify>
Run `pytest tests/test_deidentification.py -k "hyphenated" -v` and verify room tests pass while non-room tests correctly don't over-detect.
  </verify>
  <done>8 hyphenated room tests pass, and negative tests confirm no over-detection on age/date ranges.</done>
</task>

<task type="auto">
  <name>Task 3: Verify no regression on existing room tests</name>
  <files>tests/test_deidentification.py</files>
  <action>
Run the full room test suite to ensure existing patterns still work:

```bash
pytest tests/test_deidentification.py::TestRoomMRNEdgeCases -v
```

All 27 existing room/MRN tests should still pass.

If any failures occur:
1. Check if the new pattern is conflicting with existing ones
2. Adjust the regex or score if needed
3. Document any changes in the summary
  </action>
  <verify>
All 27 tests in TestRoomMRNEdgeCases pass (15 room + 8 MRN + 4 unit preservation).
  </verify>
  <done>No regression in existing room/MRN tests, all 27 pass.</done>
</task>

</tasks>

<verification>
1. `pytest tests/test_deidentification.py -k "hyphenated" -v` - 8 positive tests pass, 2 negative tests pass
2. `pytest tests/test_deidentification.py::TestRoomMRNEdgeCases -v` - all 27 existing tests pass
3. Quick manual test:
   ```bash
   python -c "
   from app.deidentification import deidentify_text
   result = deidentify_text('Patient in 3-22 with bronchiolitis')
   print(f'3-22: {\"PASS\" if \"3-22\" not in result else \"FAIL\"}')"
   ```
</verification>

<success_criteria>
- Standalone hyphenated room pattern added with appropriate score
- 8 hyphenated room edge case tests pass
- 2 negative tests confirm no over-detection on age/date ranges
- No regression in existing 27 room/MRN tests
</success_criteria>

<output>
After completion, create `.planning/phases/04-pattern-improvements/04-05-SUMMARY.md`
</output>
