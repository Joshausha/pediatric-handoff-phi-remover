---
phase: 04-pattern-improvements
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - app/recognizers/medical.py
  - tests/test_deidentification.py
autonomous: true

must_haves:
  truths:
    - "Room numbers detected with case-insensitive keywords (Room 302, room 302, ROOM 302)"
    - "Room numbers detected at start of line (sentence-initial patterns)"
    - "Bed numbers detected with case-insensitive ICU unit names (PICU bed 7, picu bed 7)"
    - "Multi-format room numbers handled (Room 3-22, bed 4A, bay 5, isolette 21)"
    - "MRN patterns catch edge cases (start of line, after punctuation)"
  artifacts:
    - path: "app/recognizers/medical.py"
      provides: "Enhanced room and MRN patterns"
      contains: "(?i)"
    - path: "tests/test_deidentification.py"
      provides: "Parameterized room/MRN edge case tests"
      contains: "ROOM_EDGE_CASES"
  key_links:
    - from: "tests/test_deidentification.py"
      to: "app/recognizers/medical.py"
      via: "deidentify_text imports recognizers"
      pattern: "from app.deidentification import"
---

<objective>
Improve room and MRN patterns to handle case variations, start-of-line edge cases, and additional room formats (bay, isolette, multi-part numbers).

Purpose: Phase 2 showed ROOM recall at 32.1% - far below 90% target. Current patterns use lookbehind which fails at start-of-line, and are case-sensitive ("Room" not "room"). User decision: require keywords to avoid false positives on standalone numbers.

Output: Updated medical.py with case-insensitive patterns and expanded room formats. Parameterized tests covering all room/MRN edge cases.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-pattern-improvements/04-RESEARCH.md
@app/recognizers/medical.py
@tests/test_deidentification.py
@tests/handoff_templates.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite room patterns with case-insensitive matching and expanded formats</name>
  <files>app/recognizers/medical.py</files>
  <action>
Rewrite the room_patterns in get_medical_recognizers() to:

1. **Replace lookbehind with case-insensitive word boundary patterns:**
   - Current: `r"(?<=Room |room |Rm |rm )\d{1,4}[A-Za-z]?\b"` (lookbehind fails at position 0)
   - New: `r"(?i)\b(?:room|rm)\s+(\d{1,4}[A-Za-z]?)\b"` (captures only the number)
   - The capture group `(\d{1,4}[A-Za-z]?)` is what gets replaced

2. **Add expanded room/bed patterns:**
```python
# Standard room formats
Pattern(name="room_standard", regex=r"(?i)\b(?:room|rm)\s+(\d{1,4}[A-Za-z]?)\b", score=0.70),

# Bed formats
Pattern(name="bed_standard", regex=r"(?i)\bbed\s+(\d{1,2}[A-Za-z]?)\b", score=0.65),

# ICU formats with unit names (preserve unit, redact number)
Pattern(name="icu_bed", regex=r"(?i)\b(?:picu|nicu|icu)\s+bed\s+(\d{1,3}[A-Za-z]?)\b", score=0.80),

# Bay/isolette (NICU specific)
Pattern(name="bay_number", regex=r"(?i)\bbay\s+(\d{1,2}[A-Za-z]?)\b", score=0.65),
Pattern(name="isolette_number", regex=r"(?i)\bisolette\s+(\d{1,3})\b", score=0.70),

# Multi-part room numbers: "3-22", "4/11"
Pattern(name="room_multipart", regex=r"(?i)\b(?:room|rm)\s+(\d{1,2}[-/]\d{1,2})\b", score=0.70),

# Floor + direction preserved (capture only floor number)
Pattern(name="floor_unit", regex=r"(?i)\b(\d{1,2})\s*(?:north|south|east|west|tower|floor)\b", score=0.50),
```

3. **User decisions applied:**
   - Require keywords (room, bed, bay, isolette) - no standalone numbers
   - Preserve unit names (PICU, NICU) - only redact the number
   - Single-letter beds: Include alphanumeric like "bed 3A" but NOT pure letter "bed A"

4. **Context words** - keep existing context list, it helps boost confidence:
```python
context=["room", "bed", "floor", "unit", "located", "admitted to", "transferred to", "bay", "isolette"]
```

5. **MRN pattern improvements:**
   - Add `(?i)` flag to all MRN patterns for consistency
   - Current patterns mostly work but ensure case-insensitivity
```python
Pattern(name="mrn_labeled", regex=r"(?i)\b(?:mrn)[:\s#]?\s*(\d{6,10})\b", score=0.85),
Pattern(name="medical_record", regex=r"(?i)\b(?:medical\s+record|chart)\s*(?:number|#|:)?\s*(\d{6,10})\b", score=0.75),
Pattern(name="mrn_prefix", regex=r"\b[A-Z]{2}\d{6,8}\b", score=0.60),  # Keep case-sensitive for letter prefix
Pattern(name="mrn_hash", regex=r"#(\d{6,10})\b", score=0.70),
Pattern(name="patient_number", regex=r"(?i)\bpatient\s*#?\s*(\d{6,10})\b", score=0.75),
```
  </action>
  <verify>
```bash
cd "/Users/joshpankin/My Drive/10-19 Projects/12 Development & AI Projects/12.09 Pediatric_Handoff_PHI_Remover"
python -c "
from app.recognizers.medical import get_medical_recognizers
from presidio_analyzer import AnalyzerEngine

engine = AnalyzerEngine()
for r in get_medical_recognizers():
    engine.registry.add_recognizer(r)

# Test cases
tests = [
    ('Room 302', 'ROOM'),           # Standard capitalized
    ('room 302', 'ROOM'),           # Lowercase
    ('PICU bed 7', 'ROOM'),         # ICU bed
    ('picu bed 7', 'ROOM'),         # ICU lowercase
    ('bay 5', 'ROOM'),              # Bay
    ('isolette 21', 'ROOM'),        # Isolette
    ('Room 3-22', 'ROOM'),          # Multi-part
    ('MRN 12345678', 'MEDICAL_RECORD_NUMBER'),  # MRN standard
    ('mrn 12345678', 'MEDICAL_RECORD_NUMBER'),  # MRN lowercase
]

for text, expected_entity in tests:
    results = engine.analyze(text, language='en', entities=[expected_entity])
    found = any(r.entity_type == expected_entity for r in results)
    status = 'PASS' if found else 'FAIL'
    print(f'{status}: \"{text}\" -> {expected_entity}')
"
```
All 9 test cases should show PASS.
  </verify>
  <done>
Room and MRN patterns catch all case variations, multi-part formats, and NICU-specific patterns (bay, isolette). All test cases pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add parameterized edge case tests for room and MRN patterns</name>
  <files>tests/test_deidentification.py</files>
  <action>
Add a new test class `TestRoomMRNEdgeCases` with parameterized tests:

1. **Create room edge case test data:**
```python
ROOM_EDGE_CASES = [
    # (input_text, phi_that_must_be_removed, description)
    ("Patient in Room 302", "302", "room_standard"),
    ("Patient in room 302", "302", "room_lowercase"),
    ("ROOM 302 is occupied", "302", "room_uppercase"),
    ("Rm 404 available", "404", "rm_abbreviation"),
    ("Bed 12 in PICU", "12", "bed_standard"),
    ("bed 12 in picu", "12", "bed_lowercase"),
    ("PICU bed 7", "7", "picu_bed"),
    ("picu bed 7", "7", "picu_lowercase"),
    ("NICU bed 3A", "3A", "nicu_alphanumeric"),
    ("nicu bed 3a", "3a", "nicu_lowercase_alpha"),
    ("Bay 5 in NICU", "5", "bay_number"),
    ("Isolette 21", "21", "isolette_number"),
    ("Room 3-22", "3-22", "multipart_dash"),
    ("Room 4/11", "4/11", "multipart_slash"),
    ("4 West room 412", "412", "floor_unit_room"),
]
```

2. **Create MRN edge case test data:**
```python
MRN_EDGE_CASES = [
    ("MRN 12345678", "12345678", "mrn_standard"),
    ("mrn 12345678", "12345678", "mrn_lowercase"),
    ("MRN: 12345678", "12345678", "mrn_colon"),
    ("MRN#12345678", "12345678", "mrn_hash"),
    ("#12345678", "12345678", "hash_only"),
    ("Medical record number: 87654321", "87654321", "full_label"),
    ("Patient #12345678", "12345678", "patient_hash"),
    ("AB12345678", "AB12345678", "letter_prefix"),
]
```

3. **Create parameterized tests:**
```python
class TestRoomMRNEdgeCases:
    """Test room and MRN pattern edge cases."""

    @pytest.mark.parametrize("text,phi,desc", ROOM_EDGE_CASES,
                             ids=lambda x: x[2] if isinstance(x, tuple) else x)
    def test_room_edge_case(self, text, phi, desc):
        result = deidentify_text(text)
        assert phi not in result.clean_text, f"Room '{phi}' should be removed ({desc})"

    @pytest.mark.parametrize("text,phi,desc", MRN_EDGE_CASES,
                             ids=lambda x: x[2] if isinstance(x, tuple) else x)
    def test_mrn_edge_case(self, text, phi, desc):
        result = deidentify_text(text)
        assert phi not in result.clean_text, f"MRN '{phi}' should be removed ({desc})"
```

4. **Add unit name preservation tests:**
```python
@pytest.mark.parametrize("text,word_to_preserve", [
    ("PICU bed 7", "PICU"),
    ("picu bed 7", "picu"),
    ("NICU bed 3A", "NICU"),
    ("4 West room 412", "West"),
])
def test_unit_name_preserved(self, text, word_to_preserve):
    result = deidentify_text(text)
    assert word_to_preserve.lower() in result.clean_text.lower(), \
        f"Unit name '{word_to_preserve}' should be preserved"
```

Place the new test class after `TestGuardianPatternEdgeCases` (created in Plan 01).
  </action>
  <verify>
```bash
cd "/Users/joshpankin/My Drive/10-19 Projects/12 Development & AI Projects/12.09 Pediatric_Handoff_PHI_Remover"
source venv/bin/activate
pytest tests/test_deidentification.py -v -k "room_edge or mrn_edge or unit_name" --tb=short
```
All parameterized edge case tests should pass.
  </verify>
  <done>
Parameterized tests added for all room and MRN edge cases. Tests pass, confirming pattern improvements work correctly.
  </done>
</task>

</tasks>

<verification>
1. All 9 inline verification tests pass (room and MRN variations)
2. All parameterized edge case tests pass
3. Existing tests still pass (no regressions):
   ```bash
   pytest tests/test_deidentification.py -v -k "not bulk" --tb=short
   ```
4. Unit names (PICU, NICU, West) are preserved in output
</verification>

<success_criteria>
- Room patterns catch case variations (room, Room, ROOM)
- Room patterns handle start-of-line cases
- ICU unit names preserved while numbers redacted
- Bay/isolette formats supported
- Multi-part room numbers (3-22, 4/11) handled
- MRN patterns case-insensitive
- All existing tests pass (no regressions)
- New parameterized tests cover all edge cases
</success_criteria>

<output>
After completion, create `.planning/phases/04-pattern-improvements/04-02-SUMMARY.md`
</output>
