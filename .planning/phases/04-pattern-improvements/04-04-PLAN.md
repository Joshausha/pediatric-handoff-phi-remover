---
phase: 04-pattern-improvements
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - app/recognizers/medical.py
  - tests/test_deidentification.py
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "International phone formats with 001- prefix detected"
    - "Phone numbers with +1- prefix and extensions detected"
    - "Phone numbers with dot separators detected"
    - "Phone numbers with parentheses and extensions detected"
    - "10-digit phone numbers without separators detected"
  artifacts:
    - path: "app/recognizers/medical.py"
      provides: "Extended phone number patterns for international/extension formats"
    - path: "tests/test_deidentification.py"
      provides: "Parameterized tests for phone number edge cases"
  key_links:
    - from: "tests/test_deidentification.py"
      to: "app/recognizers/medical.py"
      via: "deidentify_text -> get_medical_recognizers"
      pattern: "from app.deidentification import deidentify_text"
---

<objective>
Add phone number patterns to catch international formats and extensions that Presidio's default recognizer misses.

Purpose: Validation showed 40+ missed phone numbers with formats like `001-xxx-xxx-xxxx`, `+1-xxx-xxx-xxxxxx`, `xxx.xxx.xxxxxx`, and 10-digit unformatted numbers. These are low false-positive risk additions.

Output: Extended phone patterns in medical.py with parameterized test coverage.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-pattern-improvements/04-02-SUMMARY.md
@app/recognizers/medical.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add phone number recognizer to medical.py</name>
  <files>app/recognizers/medical.py</files>
  <action>
Create a new PHONE_NUMBER PatternRecognizer in `get_medical_recognizers()` to catch formats Presidio misses:

1. **International with 001 prefix** (seen: `001-411-671-8227`, `001-723-437-4989x41343`)
   - Pattern: `(?i)001[-.]?\d{3}[-.]?\d{3}[-.]?\d{4}(?:x\d{1,5})?\b`
   - Score: 0.85

2. **International with +1 prefix** (seen: `+1-899-904-9027x87429`, `+1-788-499-2107`)
   - Pattern: `\+1[-.]?\d{3}[-.]?\d{3}[-.]?\d{4}(?:x\d{1,5})?\b`
   - Score: 0.90

3. **Dot-separated with extensions** (seen: `538.372.6247`, `200.954.1199x867`)
   - Pattern: `\b\d{3}\.\d{3}\.\d{4}(?:x\d{1,5})?\b`
   - Score: 0.80

4. **Parentheses format with extensions** (seen: `(392)832-2602x56342`, `(288)857-4489`)
   - Pattern: `\(\d{3}\)\d{3}[-.]?\d{4}(?:x\d{1,5})?\b`
   - Score: 0.85

5. **10-digit unformatted** (seen: `3405785932`, `2385860868`)
   - Pattern: `\b\d{10}\b` with context words: ["call", "phone", "contact", "reach", "pager"]
   - Score: 0.60 (lower score, context-dependent)

Add the recognizer after the existing ROOM recognizer section.
  </action>
  <verify>
Run `python -c "from app.recognizers.medical import get_medical_recognizers; r = get_medical_recognizers(); print([x.name for x in r])"` and verify "Phone Number Recognizer" appears.
  </verify>
  <done>Phone number patterns added to medical.py covering all 5 missed format types.</done>
</task>

<task type="auto">
  <name>Task 2: Add parameterized phone number edge case tests</name>
  <files>tests/test_deidentification.py</files>
  <action>
Add a new test class `TestPhoneNumberEdgeCases` with parameterized tests:

```python
PHONE_NUMBER_EDGE_CASES = [
    # International with 001 prefix
    ("001-411-671-8227", "Contact number is 001-411-671-8227 for mom"),
    ("001-723-437-4989x41343", "Call dad at 001-723-437-4989x41343"),
    ("001-922-421-9693", "Reach family at 001-922-421-9693"),
    # International with +1 prefix
    ("+1-899-904-9027x87429", "Parent phone +1-899-904-9027x87429"),
    ("+1-788-499-2107", "Contact +1-788-499-2107 for discharge"),
    ("+1-932-580-6346x1571", "Reach at +1-932-580-6346x1571"),
    # Dot-separated
    ("538.372.6247", "Mom's cell 538.372.6247"),
    ("200.954.1199x867", "Dad at 200.954.1199x867"),
    ("399.807.7262x570", "Call 399.807.7262x570"),
    # Parentheses format
    ("(392)832-2602x56342", "Contact (392)832-2602x56342"),
    ("(288)857-4489", "Mom (288)857-4489"),
    ("(394)256-5118", "Reach (394)256-5118"),
    # 10-digit unformatted (with context)
    ("3405785932", "Call phone 3405785932 for updates"),
    ("2385860868", "Contact number 2385860868"),
]
```

Each test should:
1. Call `deidentify_text()` with the context sentence
2. Assert `[PHONE_NUMBER]` appears in the result
3. Assert the original phone number does NOT appear in the result
  </action>
  <verify>
Run `pytest tests/test_deidentification.py::TestPhoneNumberEdgeCases -v` and verify all tests pass.
  </verify>
  <done>14 phone number edge case tests pass, covering all 5 missed format categories.</done>
</task>

<task type="auto">
  <name>Task 3: Run manual verification of phone pattern improvements</name>
  <files></files>
  <action>
Run a quick manual verification to confirm the new phone patterns are working:

```bash
python -c "
from app.deidentification import deidentify_text
tests = [
    ('001-411-671-8227', 'Contact at 001-411-671-8227'),
    ('+1-899-904-9027x87429', 'Call +1-899-904-9027x87429'),
    ('538.372.6247', 'Mom cell 538.372.6247'),
    ('(392)832-2602x56342', 'Reach (392)832-2602x56342'),
]
passed = 0
for phone, text in tests:
    result = deidentify_text(text)
    status = 'PASS' if phone not in result else 'FAIL'
    if status == 'PASS':
        passed += 1
    print(f'{phone}: {status}')
print(f'\nTotal: {passed}/{len(tests)} patterns detected')
"
```

Expected: All 4 patterns show "PASS" indicating phone numbers are being detected.

**Improvement estimate:**
- Baseline PHONE_NUMBER recall: 73.9% (170 TP, 60 FN, 230 total phone spans)
- Patterns addressed: ~40 FNs (international, dot-separated, parentheses, unformatted)
- Expected new recall: ~73.9% + (40/230) = ~91.3%
- Note: Actual improvement depends on overlap between pattern categories in test data
  </action>
  <verify>
All 4 quick test patterns show "PASS" indicating phone numbers are being detected.
  </verify>
  <done>PHONE_NUMBER patterns verified working with manual tests. Expected recall improvement to ~91%.</done>
</task>

</tasks>

<verification>
1. `pytest tests/test_deidentification.py::TestPhoneNumberEdgeCases -v` - all 14 tests pass
2. Manual verification of 4 sample formats shows [PHONE_NUMBER] replacement
3. No regression in existing tests: `pytest tests/test_deidentification.py -v --tb=short`
</verification>

<success_criteria>
- Phone patterns for international (001-, +1-), dot-separated, parentheses, and 10-digit formats added
- 14 parameterized edge case tests pass
- No regressions in existing phone number tests
- Quick manual tests confirm detection
</success_criteria>

<output>
After completion, create `.planning/phases/04-pattern-improvements/04-04-SUMMARY.md`
</output>
