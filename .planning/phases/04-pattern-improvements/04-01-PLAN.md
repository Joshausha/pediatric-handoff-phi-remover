---
phase: 04-pattern-improvements
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/recognizers/pediatric.py
  - tests/test_deidentification.py
autonomous: true

must_haves:
  truths:
    - "Guardian names detected regardless of capitalization (Mom Jessica, mom jessica, MOM JESSICA)"
    - "Guardian names detected at start of line (sentence-initial patterns)"
    - "Bidirectional patterns catch both 'Mom Jessica' and 'Jessica is Mom'"
    - "Baby names detected with case-insensitive patterns (Baby Smith, baby smith)"
    - "Speech artifacts (um, uh) do not break guardian name detection"
  artifacts:
    - path: "app/recognizers/pediatric.py"
      provides: "Enhanced guardian and baby name patterns"
      contains: "(?i)"
    - path: "tests/test_deidentification.py"
      provides: "Parameterized edge case tests"
      contains: "pytest.mark.parametrize"
  key_links:
    - from: "tests/test_deidentification.py"
      to: "app/recognizers/pediatric.py"
      via: "deidentify_text imports recognizers"
      pattern: "from app.deidentification import"
---

<objective>
Improve guardian and baby name patterns to handle case variations, start-of-line edge cases, bidirectional relationships, and speech artifacts.

Purpose: Phase 2 discovered that threshold tuning cannot fix pattern gaps - entities are either detected (0.85+ score) or completely missed (0.0 score). Guardian names currently miss lowercase patterns ("mom jessica"), start-of-line patterns, and bidirectional patterns ("Jessica is Mom").

Output: Updated pediatric.py with case-insensitive patterns, bidirectional matching, and speech artifact tolerance. Parameterized tests covering all edge cases.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-pattern-improvements/04-RESEARCH.md
@app/recognizers/pediatric.py
@tests/test_deidentification.py
@tests/handoff_templates.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite guardian and baby name patterns with case-insensitive matching</name>
  <files>app/recognizers/pediatric.py</files>
  <action>
Rewrite the guardian_patterns and baby_name_patterns in get_pediatric_recognizers() to:

1. **Add `(?i)` flag to all patterns** for case-insensitive matching
   - Current: `r"(?<=Mom )[A-Z][a-z]+\b"` only catches "Mom Jessica"
   - New: Must catch "mom jessica", "Mom Jessica", "MOM JESSICA"

2. **Replace lookbehind patterns with non-lookbehind alternatives**
   - Lookbehind fails at position 0 (start of line/string)
   - Use word boundary approach: `r"(?i)\b(?:mom|mother)\s+([A-Z][a-z]+)\b"`
   - IMPORTANT: Capture only the name, not the relationship word (use non-capturing group for relationship)

3. **Add bidirectional patterns** for "Jessica is Mom" patterns
   - Add new patterns: `r"(?i)\b([A-Z][a-z]+)\s+is\s+(?:mom|dad|grandma|grandpa|aunt|uncle)\b"`
   - These catch reversed relationship patterns common in speech

4. **Add speech artifact tolerance**
   - Insert optional filler words: `(?:uh\s+|um\s+)?`
   - Example: `r"(?i)\b(?:mom|mother)\s+(?:uh\s+|um\s+)?([A-Z][a-z]+)\b"`
   - Handle repetitions: `r"(?i)(?:mom\s+)?(?:mom|mother)\s+([A-Z][a-z]+)\b"`

5. **Pattern organization:**
   - Group by relationship type (mom/mother/mommy, dad/father/daddy, etc.)
   - Use alternation `(?:mom|mother|mommy)` instead of separate patterns per variation
   - This reduces pattern count while increasing coverage

6. **Score adjustments:**
   - Base patterns (mom/dad): score 0.85
   - Bidirectional patterns: score 0.80 (slightly broader, lower confidence)
   - Speech artifact patterns: score 0.75 (loosest, lowest confidence)

The key change is moving from lookbehind (`(?<=Mom )`) to word boundary (`\b`) approach, which handles all edge cases while preserving the behavior of only redacting the name (not the relationship word).

Note: The replacement text in deidentification.py handles what gets replaced. The regex capture group determines the matched span.
  </action>
  <verify>
```bash
cd "/Users/joshpankin/My Drive/10-19 Projects/12 Development & AI Projects/12.09 Pediatric_Handoff_PHI_Remover"
python -c "
from app.recognizers.pediatric import get_pediatric_recognizers
from presidio_analyzer import AnalyzerEngine

engine = AnalyzerEngine()
for r in get_pediatric_recognizers():
    engine.registry.add_recognizer(r)

# Test cases
tests = [
    ('Mom Jessica is here', 'GUARDIAN_NAME'),        # Standard
    ('mom jessica is here', 'GUARDIAN_NAME'),        # Lowercase
    ('Jessica is Mom', 'GUARDIAN_NAME'),             # Bidirectional
    ('Um, mom uh Jessica called', 'GUARDIAN_NAME'),  # Speech artifacts
    ('Baby Smith in NICU', 'PERSON'),                # Baby name
    ('baby smith in nicu', 'PERSON'),                # Lowercase baby
]

for text, expected_entity in tests:
    results = engine.analyze(text, language='en', entities=[expected_entity])
    found = any(r.entity_type == expected_entity for r in results)
    status = 'PASS' if found else 'FAIL'
    print(f'{status}: \"{text}\" -> {expected_entity}')
"
```
All 6 test cases should show PASS.
  </verify>
  <done>
Guardian and baby name patterns catch all case variations, start-of-line patterns, bidirectional patterns, and speech artifacts. All test cases pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add parameterized edge case tests for guardian patterns</name>
  <files>tests/test_deidentification.py</files>
  <action>
Add a new test class `TestGuardianPatternEdgeCases` with parameterized tests covering all edge cases from handoff_templates.py:

1. **Create test data from BOUNDARY_EDGE_TEMPLATES:**
```python
GUARDIAN_EDGE_CASES = [
    # (input_text, phi_that_must_be_removed, description)
    ("Mom Jessica is at bedside", "Jessica", "standard_capitalized"),
    ("mom jessica is at bedside", "jessica", "lowercase_all"),
    ("MOM JESSICA is at bedside", "JESSICA", "uppercase_all"),
    ("Jessica is mom", "Jessica", "bidirectional_mom"),
    ("Jessica is dad", "Jessica", "bidirectional_dad"),
    ("Um, mom uh Jessica called", "Jessica", "speech_fillers"),
    ("mom mom Jessica", "Jessica", "repeated_keyword"),
    ("Mom Jessica", "Jessica", "start_of_line"),
    ("(Mom Jessica)", "Jessica", "in_parentheses"),
    ("Contact: Mom Jessica", "Jessica", "after_colon"),
    ("Dad Mike at bedside", "Mike", "dad_standard"),
    ("dad mike at bedside", "mike", "dad_lowercase"),
    ("Mike is dad", "Mike", "dad_bidirectional"),
    ("Grandma Rosa visiting", "Rosa", "grandma_standard"),
    ("grandma rosa visiting", "rosa", "grandma_lowercase"),
]
```

2. **Create parameterized test:**
```python
@pytest.mark.parametrize("text,phi,desc", GUARDIAN_EDGE_CASES, ids=lambda x: x[2] if isinstance(x, tuple) else x)
def test_guardian_edge_case(self, text, phi, desc):
    result = deidentify_text(text)
    assert phi not in result.clean_text, f"PHI '{phi}' should be removed ({desc})"
```

3. **Add baby name edge cases:**
```python
BABY_NAME_EDGE_CASES = [
    ("Baby Smith in NICU", "Smith", "baby_capitalized"),
    ("baby smith in nicu", "smith", "baby_lowercase"),
    ("Infant Jones admitted", "Jones", "infant_capitalized"),
    ("infant jones admitted", "jones", "infant_lowercase"),
    ("Baby Boy Williams", "Williams", "baby_boy_pattern"),
    ("baby girl wilson", "wilson", "baby_girl_lowercase"),
]
```

4. **Add preservation tests** to ensure relationship words are NOT removed:
```python
@pytest.mark.parametrize("text,word_to_preserve", [
    ("Mom Jessica is here", "Mom"),
    ("mom jessica is here", "mom"),
    ("Dad Mike called", "Dad"),
    ("Grandma Rosa visiting", "Grandma"),
])
def test_relationship_word_preserved(self, text, word_to_preserve):
    result = deidentify_text(text)
    assert word_to_preserve.lower() in result.clean_text.lower(), \
        f"Relationship word '{word_to_preserve}' should be preserved"
```

Place the new test class after `TestSampleTranscripts` in the file.
  </action>
  <verify>
```bash
cd "/Users/joshpankin/My Drive/10-19 Projects/12 Development & AI Projects/12.09 Pediatric_Handoff_PHI_Remover"
source venv/bin/activate
pytest tests/test_deidentification.py -v -k "guardian_edge or baby_name_edge or relationship_word" --tb=short
```
All parameterized edge case tests should pass.
  </verify>
  <done>
Parameterized tests added for all guardian and baby name edge cases. Tests pass, confirming pattern improvements work correctly.
  </done>
</task>

</tasks>

<verification>
1. All 6 inline verification tests pass (case variations, bidirectional, speech artifacts)
2. All parameterized edge case tests pass
3. Existing tests still pass (no regressions):
   ```bash
   pytest tests/test_deidentification.py -v -k "not bulk" --tb=short
   ```
4. Guardian relationship words (Mom, Dad, etc.) are preserved in output
</verification>

<success_criteria>
- PATT-01: Lookbehind edge cases fixed (start-of-line, punctuation, word boundaries)
- PATT-02: Case normalization implemented ("mom jessica" caught)
- PATT-03: Bidirectional patterns added ("Jessica is Mom" caught)
- PATT-04: Speech artifact tolerance added
- All existing tests pass (no regressions)
- New parameterized tests cover all edge cases from adversarial templates
</success_criteria>

<output>
After completion, create `.planning/phases/04-pattern-improvements/04-01-SUMMARY.md`
</output>
