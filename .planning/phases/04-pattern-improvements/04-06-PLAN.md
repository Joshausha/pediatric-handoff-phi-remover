---
phase: 04-pattern-improvements
plan: 06
type: execute
wave: 2
depends_on: [04-04, 04-05]
files_modified:
  - .planning/phases/04-pattern-improvements/GAP_ANALYSIS.md
  - .planning/STATE.md
autonomous: false
gap_closure: true

must_haves:
  truths:
    - "Gap analysis documents remaining false negatives after 04-04 and 04-05"
    - "ROOM standalone number detection decision captured"
    - "MRN unprefixed detection decision captured"
    - "LOCATION NER limitation acknowledged with mitigation strategy"
  artifacts:
    - path: ".planning/phases/04-pattern-improvements/GAP_ANALYSIS.md"
      provides: "Documented decisions on risky pattern additions and remaining gaps"
    - path: ".planning/STATE.md"
      provides: "Updated with pattern improvement decisions"
  key_links:
    - from: "GAP_ANALYSIS.md"
      to: "STATE.md"
      via: "decisions update"
      pattern: "decision recorded"
---

<objective>
Analyze remaining gaps after easy wins (04-04, 04-05) and make decisions on risky pattern additions.

Purpose: After addressing phone numbers and hyphenated rooms, significant gaps remain:
- ROOM standalone numbers (e.g., "847", "16", "512") - high false positive risk with ages/vitals
- MRN unprefixed numbers (e.g., "2694522", "46855845") - could conflict with phone numbers
- LOCATION full addresses - fundamental NER limitation

This plan analyzes the tradeoffs and captures decisions on whether to implement risky patterns.

Output: GAP_ANALYSIS.md documenting decisions and expected remaining gaps.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-validation-compliance/validation_results.json
@.planning/phases/05-validation-compliance/VALIDATION_REPORT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Re-run validation to measure improvement from 04-04 and 04-05</name>
  <files>tests/results/post_gap_closure.json</files>
  <action>
Run the validation script to measure the impact of phone number and hyphenated room fixes:

```bash
python scripts/run_validation.py --output tests/results/post_gap_closure.json
```

If that script doesn't exist, use the evaluation script:
```bash
python scripts/evaluate_phi.py tests/synthetic_handoffs.json --output tests/results/post_gap_closure.json
```

If neither script exists, run a manual evaluation using pytest:
```bash
pytest tests/test_deidentification.py -v --tb=short 2>&1 | tee tests/results/post_gap_closure.txt
```

Extract key metrics:
- Overall recall (was 83.0%)
- PHONE_NUMBER recall (was 73.9%)
- ROOM recall (was 43.3%)
- Remaining false negatives by type

Calculate expected improvement:
- Phone fixes: ~40 FNs addressed out of 257 = ~15% of total FNs
- Hyphenated room fixes: ~11 FNs addressed = ~4% of total FNs
- Expected new recall: ~83% + ~5% = ~88%
  </action>
  <verify>
Verify `tests/results/post_gap_closure.json` (or `.txt` if using pytest fallback) exists with updated metrics showing improvement over baseline 83% recall.

**Contingency:** If recall < 85%, document why improvement was lower than expected:
- Pattern conflicts reducing effectiveness
- Test data overlap (same FNs counted in multiple categories)
- Regex bugs not matching expected formats
  </verify>
  <done>Post-gap-closure metrics captured. Expected recall ~88%, with contingency documentation if lower.</done>
</task>

<task type="checkpoint:decision" gate="blocking">
  <decision>Should we add patterns to detect standalone numbers as ROOM or MRN?</decision>
  <context>
**Current state after 04-04/04-05:** Recall improved but still below 95% target.

**Remaining gaps:**
1. **ROOM standalone numbers** (~50 FNs): Numbers like "847", "16", "512" without "Room" prefix
2. **MRN unprefixed numbers** (~40 FNs): 7-8 digit numbers without "#" or "MRN" prefix
3. **LOCATION addresses** (~80 FNs): Full addresses, hospital names, city names

**Analysis:**

**Option A: Add ROOM standalone number pattern**
- Pattern: `\b\d{1,3}\b` with room context words
- Pro: Would catch most standalone room numbers
- Con: Would false-positive on:
  - Ages: "4 year old" - 4 detected as room
  - Vitals: "HR 120" - 120 detected as room
  - Doses: "give 5 mg" - 5 detected as room
  - Temperatures: "temp 38.5" - 38 detected as room
  - Saturations: "sats 98" - 98 detected as room
- Risk: HIGH - would over-redact clinically useful content
- Impact: +50 TPs, estimated +200 FPs

**Option B: Add MRN unprefixed pattern**
- Pattern: `\b\d{7,8}\b` (7-8 digit numbers)
- Pro: Would catch unprefixed MRNs
- Con: Would conflict with:
  - Phone numbers without formatting
  - ZIP codes in addresses
  - Other 7-8 digit numbers
- Risk: MEDIUM - some over-redaction but less impactful
- Impact: +40 TPs, estimated +30 FPs

**Option C: Accept limitations and document residual risk**
- Pro: Maintains high precision, clinically readable transcripts
- Con: Recall stays below 95% target
- Mitigation: User performs manual review of de-identified transcripts
- Risk: LOW - known limitations, documented for compliance

  </context>
  <options>
    <option id="option-a">
      <name>Aggressive: Add both ROOM and MRN patterns</name>
      <pros>Maximum recall improvement (+90 TPs), closer to 95% target</pros>
      <cons>High false positive risk, reduced clinical utility, may over-redact useful content</cons>
    </option>
    <option id="option-b">
      <name>Moderate: Add MRN pattern only</name>
      <pros>Moderate recall improvement (+40 TPs), lower false positive risk than ROOM</pros>
      <cons>Still below 95% target, some conflicts with phone numbers possible</cons>
    </option>
    <option id="option-c">
      <name>Conservative: Accept limitations, document residual risk</name>
      <pros>Maintains precision, clinically useful transcripts, documented compliance approach</pros>
      <cons>Recall stays ~88%, requires manual review as mitigation</cons>
    </option>
    <option id="option-d">
      <name>Data fix: Update test data generator to include prefixes</name>
      <pros>Addresses root cause (synthetic data doesn't match real patterns), no false positive risk</pros>
      <cons>Doesn't improve detection on truly unprefixed real-world data</cons>
    </option>
  </options>
  <resume-signal>
**Execution flow:** Plan pauses at this checkpoint. User reviews options and provides decision.

Select: option-a, option-b, option-c, or option-d (or provide alternative approach)

After user provides decision, executor reads this signal and continues to Task 3 with the selected option.
  </resume-signal>
</task>

<task type="auto">
  <name>Task 3: Document gap analysis, decision, and update STATE.md</name>
  <files>.planning/phases/04-pattern-improvements/GAP_ANALYSIS.md, .planning/STATE.md</files>
  <action>
**Part A: Create GAP_ANALYSIS.md** documenting:

1. **Pre-gap-closure baseline** (from validation): 83% recall, 257 FNs
2. **Post-gap-closure metrics** (after 04-04, 04-05): [insert actual numbers from Task 1]
3. **Remaining gaps by category**:
   - ROOM standalone: ~50 FNs - [decision from checkpoint]
   - MRN unprefixed: ~40 FNs - [decision from checkpoint]
   - LOCATION addresses: ~80 FNs - Presidio NER limitation, not addressable
   - Other: ~10 FNs - rare edge cases
4. **Decision record**: [based on checkpoint response]
5. **Residual risk assessment**:
   - Expected final recall after decisions
   - Mitigation strategy for remaining gaps
   - HIPAA compliance approach

Template:
```markdown
# Phase 4 Gap Analysis Report

**Date:** [date]
**Baseline Recall:** 83.0% (CI: 81.0% - 84.8%)
**Post-Gap-Closure Recall:** [X]% (estimated)

## Gap Closure Summary

### Addressed Gaps (04-04, 04-05)

| Gap | Count | Plan | Status |
|-----|-------|------|--------|
| Phone international formats | ~40 | 04-04 | Fixed |
| Room hyphenated standalone | ~11 | 04-05 | Fixed |
| **Subtotal** | ~51 | | |

### Remaining Gaps

| Gap | Count | Decision | Rationale |
|-----|-------|----------|-----------|
| ROOM standalone numbers | ~50 | [A/B/C/D] | [rationale] |
| MRN unprefixed | ~40 | [A/B/C/D] | [rationale] |
| LOCATION addresses | ~80 | Not addressable | Presidio NER limitation |
| PERSON NER misses | ~6 | Not addressable | Rare NER failures |
| DATE_TIME formats | ~5 | Defer | Low impact |

## Decision Record

**Selected Option:** [option-X]
**Decision Date:** [date]
**Rationale:** [from checkpoint discussion]

## Residual Risk Assessment

**Expected Final Recall:** ~[X]%
**Remaining False Negatives:** ~[Y]

**Mitigation Strategy:**
1. [based on decision]

**HIPAA Compliance:**
- Expert determination approach: Statistical evidence + residual risk documentation
- User review requirement: [yes/no based on decision]
```

**Part B: Update STATE.md** with the decision:

Add to the `decisions` section:
```markdown
### Pattern Improvement Decision (Phase 4)
- **Date:** [date]
- **Decision:** [option selected]
- **Rationale:** [brief summary]
- **Impact:** Recall target adjusted from 95% to ~88% with documented residual risk
```
  </action>
  <verify>
GAP_ANALYSIS.md created with complete decision documentation. STATE.md updated with pattern improvement decision in decisions section.
  </verify>
  <done>Gap analysis documented with decision record and residual risk assessment. STATE.md updated.</done>
</task>

</tasks>

<verification>
1. Post-gap-closure metrics captured in tests/results/post_gap_closure.json (or .txt fallback)
2. User decision on standalone number patterns captured
3. GAP_ANALYSIS.md documents full analysis, decision, and residual risk
4. STATE.md updated with pattern improvement decision
</verification>

<success_criteria>
- Quantified improvement from 04-04 and 04-05 gap closures
- User decision captured on risky pattern additions
- Residual risk documented for HIPAA compliance
- STATE.md updated with decision record
- Clear path forward for remaining Phase 5 work
</success_criteria>

<output>
After completion, create `.planning/phases/04-pattern-improvements/04-06-SUMMARY.md`
</output>
